<!DOCTYPE html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="kidozh的一些想法和随手笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="kidozh">
<meta property="og:url" content="https://kidozh.github.io/page/3/index.html">
<meta property="og:site_name" content="kidozh">
<meta property="og:description" content="kidozh的一些想法和随手笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kidozh">
<meta name="twitter:description" content="kidozh的一些想法和随手笔记">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://kidozh.github.io/page/3/"/>





  <title>kidozh</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">kidozh</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">某不科学的kidozh</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/12/20/e6-9e-84-e5-bb-bawordpress-e4-b8-bb-e9-a2-98-e5-87-bd-e6-95-b0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/20/e6-9e-84-e5-bb-bawordpress-e4-b8-bb-e9-a2-98-e5-87-bd-e6-95-b0/" itemprop="url">构建WordPress主题函数</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-20T06:04:11+08:00">
                2016-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网页/" itemprop="url" rel="index">
                    <span itemprop="name">网页</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们已经创建了一个文件结构，那么现在就让我们开始一个主题把。</p>
<p>我们需要添加一些主题函数到我们的主题之中，这些函数将会完成下面的任务：</p>
<ul>
<li>为WordPress主题特征添加一些支持，比如自定义的背景，页首，博文格式等</li>
<li>设置主题的默认值</li>
<li>对于主题的代码复用</li>
</ul>
<h1 id="编辑文件"><a href="#编辑文件" class="headerlink" title="编辑文件"></a>编辑文件</h1><p>首先，让我们创建以及编辑这些文件</p>
<ul>
<li>functions.php</li>
<li>inc/template-tags.php</li>
<li>inc/tweaks.php<br>如果你是PHP新人的话，那么PHP的函数的保留字为<code>function</code>，比如这样：<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">my_function</span><span class="params">()</span> </span>&#123;</div><div class="line">  ...contents of the <span class="function"><span class="keyword">function</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>当我们创建这个函数之后，我们就可以在主题之中调用这个函数了。函数能够被调用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;div&gt;</div><div class="line">    <span class="meta">&lt;?php</span> my_function(); <span class="meta">?&gt;</span></div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p>其他的函数调用方法就可能有些复杂了：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;div&gt;</div><div class="line">    <span class="meta">&lt;?php</span> my_second_function( <span class="string">'parameter 1'</span>, <span class="string">'parameter 2'</span> ); <span class="meta">?&gt;</span></div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p>在上面的例子之中，我们都会向函数之中传递参数，这个函数将会使用其并将其作为最终的输出结果。</p>
<h1 id="Functions-php"><a href="#Functions-php" class="headerlink" title="Functions.php"></a>Functions.php</h1><p>事不宜迟，我们就开始把。</p>
<p>在上节课创建的主题目录之中，打开functions.php文件，在文件最上面，粘贴下面的值：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Shape functions and definitions</div><div class="line"> *</div><div class="line"> * <span class="doctag">@package</span> Shape</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>如果你是PHP新手的话，我们就从<code>&lt;?php</code>开始编辑文件吧。</p>
<p>接下来，我们就有描述内联信息的块注释：一个文件的简短的介绍，接着就是PHP文档的标签：@package和@since。你能够在WordPress Codex的<a href="http://codex.wordpress.org/Inline_Documentation" target="_blank" rel="external">内联文档</a>之中找到更多的信息。</p>
<p>php的注释和C语言的注释是很像的。<code>/* ... */</code>就是多行注释，而<code>//</code> 则是单行注释。</p>
<h2 id="content-width"><a href="#content-width" class="headerlink" title="$content_width"></a>$content_width</h2><p><code>$content_width</code> 是一个设置内容（比如图片）最大宽度的全局变量。其能够防止超大图片溢出主要的内容区域。我们应该设置这个值来限制我们主要内容区域的宽度。想想我们之前的HTML结构，这个区域其实就是<code>#content div</code>。我们将会使用CSS来设置div的宽度。然而，我们还没有CSS文件。所以在这里，我会告诉你div将会是654px宽。</p>
<p>在<code>functions.php</code>之中，无视最后的一个<code>*/</code>，粘贴下面的代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Set the content width based on the theme's design and stylesheet.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div><div class="line"><span class="keyword">if</span> ( ! <span class="keyword">isset</span>( $content_width ) )</div><div class="line">    $content_width = <span class="number">654</span>; <span class="comment">/* pixels */</span></div></pre></td></tr></table></figure></p>
<p>所以<code>$content_width</code>就被设置好了，PHP变量有一个美元符<code>$</code>置于名称之前，在分配值之后，会有一个半角的<code>;</code>。</p>
<h2 id="shape-setup"><a href="#shape-setup" class="headerlink" title="shape_setup()"></a>shape_setup()</h2><p>接下来，我们将会创建一个函数来新建一个默认主题并且添加一个对于众多WordPress特性支持的函数，跳过在$content_width之后的那一行，添加这个：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ( ! function_exists( <span class="string">'shape_setup'</span> ) ):</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Sets up theme defaults and registers support for various WordPress features.</div><div class="line"> *</div><div class="line"> * Note that this function is hooked into the after_setup_theme hook, which runs</div><div class="line"> * before the init hook. The init hook is too late for some features, such as indicating</div><div class="line"> * support post thumbnails.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">shape_setup</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Custom template tags for this theme.</div><div class="line">     */</div><div class="line">    <span class="keyword">require</span>( get_template_directory() . <span class="string">'/inc/template-tags.php'</span> );</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Custom functions that act independently of the theme templates</div><div class="line">     */</div><div class="line">    <span class="keyword">require</span>( get_template_directory() . <span class="string">'/inc/tweaks.php'</span> );</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Make theme available for translation</div><div class="line">     * Translations can be filed in the /languages/ directory</div><div class="line">     * If you're building a theme based on Shape, use a find and replace</div><div class="line">     * to change 'shape' to the name of your theme in all the template files</div><div class="line">     */</div><div class="line">    load_theme_textdomain( <span class="string">'shape'</span>, get_template_directory() . <span class="string">'/languages'</span> );</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add default posts and comments RSS feed links to head</div><div class="line">     */</div><div class="line">    add_theme_support( <span class="string">'automatic-feed-links'</span> );</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Enable support for the Aside Post Format</div><div class="line">     */</div><div class="line">    add_theme_support( <span class="string">'post-formats'</span>, <span class="keyword">array</span>( <span class="string">'aside'</span> ) );</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This theme uses wp_nav_menu() in one location.</div><div class="line">     */</div><div class="line">    register_nav_menus( <span class="keyword">array</span>(</div><div class="line">        <span class="string">'primary'</span> =&gt; __( <span class="string">'Primary Menu'</span>, <span class="string">'shape'</span> ),</div><div class="line">    ) );</div><div class="line">&#125;</div><div class="line"><span class="keyword">endif</span>; <span class="comment">// shape_setup</span></div><div class="line">add_action( <span class="string">'after_setup_theme'</span>, <span class="string">'shape_setup'</span> );</div></pre></td></tr></table></figure></p>
<p>代码都是很好注释过的，所以你能很好的了解他们正在做什么。</p>
<p>那么我们就一一说明把：</p>
<p>我们将会引用在inc/文件夹下的两个文件template-tags.php和tweak.php。我们将会在稍后创建这两个文件。</p>
<p>接下来，我们调用了<code>load_theme_textdomain()</code>这个函数，这个函数会告诉我们WordPress将会使用我们文件夹下的languages这个来作为翻译的标准。如果你正要创建一个WordPress主题，你一个穷尽你的可能来保证所有字符串都是可翻译的。你永远不知道在啥时候其他人是否需要在其他语言中硬编码。下面有些好的方法来翻译文章，我也会说一些出来，<a href="http://codex.wordpress.org/I18n_for_WordPress_Developers" target="_blank" rel="external">I18n for WordPress Developers</a>将会是一个非常好的入门。</p>
<p>接着，下面的两个函数为RSS反馈以及侧边博文格式提供了支持链接。最后一个函数注册了一个导航菜单位置，我们将会在我们的主要菜单中用到。</p>
<p>接下来，我们会用<code>}</code>来闭合这个函数，并且使用钩子（hook）的方法将其加到我们的主题函数之中。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add_action( <span class="string">'after_setup_theme'</span>, <span class="string">'shape_setup'</span> );</div></pre></td></tr></table></figure></p>
<p>简而言之，我们将会告诉WordPress在运行<code>after_setup_theme()</code>之后运行<code>shape_setup()</code>函数。</p>
<p>我们将会在functions.php之中加入更多东西。</p>
<p>你可能注意到functions.php文件没有任何PHP的闭合符号?&gt;，这是因为这个文件绝大多数都是PHP代码，所以吞掉闭合符号也是非常安全的。至于我们为什么要这么做的原因，自然是因为其能帮助我们免于闭合PHP代码之后引入的空白符。</p>
<h2 id="Template-tags-php和Tweak-php"><a href="#Template-tags-php和Tweak-php" class="headerlink" title="Template-tags.php和Tweak.php"></a>Template-tags.php和Tweak.php</h2><p>还记得下面的代码吗？<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Custom template tags for this theme.</div><div class="line">     */</div><div class="line">    <span class="keyword">require</span>( get_template_directory() . <span class="string">'/inc/template-tags.php'</span> );</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Custom functions that act independently of the theme templates</div><div class="line">     */</div><div class="line">    <span class="keyword">require</span>( get_template_directory() . <span class="string">'/inc/tweaks.php'</span> );</div></pre></td></tr></table></figure></p>
<p>在inc文件夹中创建template-tags.php和tweak.php文件。为什么我们要把自定义的函数分散在众多的文件之中呢？大多数情况下，我们像保持functions.php代码中的干净整洁，但更多的是保证我们主题的模块化，如果你并不需要这些函数的话，你只需要移除这一行就可以了。</p>
<h3 id="template-tags-php"><a href="#template-tags-php" class="headerlink" title="template-tags.php"></a>template-tags.php</h3><p>首先，什么是模板标签？自然是一个函数了。特殊而言，他们是你可以插入到你主题之中来显示动态页面的WordPress函数。你可以在 <a href="https://codex.wordpress.org/Template_Tags" target="_blank" rel="external">everything you want to know about template tags</a>找到一些关于模板标签的信息。</p>
<p>在大多数情况下，我们会在任何我们想要的时候将模板标签添加到我们的主题之中。然而，还是有时候我们需要将多个模板标签输出到一起。把所有的标签放到一起自然是一个很好的主意，所以想想我们要添加的模板函数，我们把他们视为一个乐符，最终我们把他们组成到一起成为一个交响乐，就像这样：一句描述博文何时发表，被谁，或者一个上一个和下一个博文的链接，或者是一个评论列表，你就能知道了。我们首先写下了乐符，然后播放多次。或者，从专业的角度上来说，写了一个函数，把他调用多次。</p>
<p>为了保证这个教程不会过于冗长，我们将返回到template-tags.php之中来添加一些我们需要的函数。对现在而言，让我们在文件首添加一些基本的文档信息把。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Custom template tags for this theme.</div><div class="line"> *</div><div class="line"> * Eventually, some of the functionality here could be replaced by core features</div><div class="line"> *</div><div class="line"> * <span class="doctag">@package</span> Shape</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>最后需要提到一点：“一些在template-tags.php之中的函数功能也许会被核心特性所替代”。这些我们添加的函数将会和WordPress核心特征一样有用。当我们添加了这些函数之后，这回变得更加有意义。</p>
<p>现在，我们就能够正常的闭合PHP标签了。</p>
<h3 id="tweak-php"><a href="#tweak-php" class="headerlink" title="tweak.php"></a>tweak.php</h3><p>这些我们放在文件中的函数并不会影响到模板标签，而相反的是他们将会提升我们主题的品质。他们提供了一个很好的后台任务，这样使得我们的主题更好。</p>
<p>在文件的页首，粘贴一些寻常的文档信息到里面。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Custom functions that act independently of the theme templates</div><div class="line"> *</div><div class="line"> * Eventually, some of the functionality here could be replaced by core features</div><div class="line"> *</div><div class="line"> * <span class="doctag">@package</span> Shape</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<p>接下来，我们要粘贴下面的函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Get our wp_nav_menu() fallback, wp_page_menu(), to show a home link.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">shape_page_menu_args</span><span class="params">( $args )</span> </span>&#123;</div><div class="line">    $args[<span class="string">'show_home'</span>] = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">return</span> $args;</div><div class="line">&#125;</div><div class="line">add_filter( <span class="string">'wp_page_menu_args'</span>, <span class="string">'shape_page_menu_args'</span> );</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Adds custom classes to the array of body classes.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">shape_body_classes</span><span class="params">( $classes )</span> </span>&#123;</div><div class="line">    <span class="comment">// Adds a class of group-blog to blogs with more than 1 published author</span></div><div class="line">    <span class="keyword">if</span> ( is_multi_author() ) &#123;</div><div class="line">        $classes[] = <span class="string">'group-blog'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $classes;</div><div class="line">&#125;</div><div class="line">add_filter( <span class="string">'body_class'</span>, <span class="string">'shape_body_classes'</span> );</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Filter in a link to a content ID attribute for the next/previous image links on image attachment pages</div><div class="line"> *</div><div class="line"> * <span class="doctag">@since</span> Shape 1.0</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">shape_enhanced_image_navigation</span><span class="params">( $url, $id )</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ( ! is_attachment() &amp;&amp; ! wp_attachment_is_image( $id ) )</div><div class="line">        <span class="keyword">return</span> $url;</div><div class="line"></div><div class="line">    $image = get_post( $id );</div><div class="line">    <span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $image-&gt;post_parent ) &amp;&amp; $image-&gt;post_parent != $id )</div><div class="line">        $url .= <span class="string">'#main'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $url;</div><div class="line">&#125;</div><div class="line">add_filter( <span class="string">'attachment_link'</span>, <span class="string">'shape_enhanced_image_navigation'</span>, <span class="number">10</span>, <span class="number">2</span> );</div></pre></td></tr></table></figure></p>
<p>第一个函数<code>shape_page_menu_args</code>，将会影响到我们主要的导航菜单。我们在之前就已经为导航菜单申请了支持，在<code>shape_setup()</code>之中。如果导航菜单并没有被配置，WordPress将会显示一连串的页面（由<code>wp_page_menu()</code>所决定）</p>
<p>在第二个函数<code>shape_body_classes()</code>，我们将会添加一个新的CSS类，<code>group-blog</code>，到我们的主题标签之中。我们将会在WordPress Header 模板之中提及到<a href="http://codex.wordpress.org/Function_Reference/body_class" target="_blank" rel="external">body class</a>。但是现在，你只需要理解body classes使得我们能够在不同的情况下装饰我们的主题的一些部分（比如我们正在访问的页面类型或者是我们作者的数目）。</p>
<p>最终，第三个函数shape_enhanced_image_navigation()，把#main这个id添加到上一个/下一个图像连接之中。回想一下，“#main”是包装我们的内容和小部件区域的div的ID名称。 ID也是页面内的锚点。 当用户点击您的下一个/上一个图片链接时，他们不必从页面顶部向下滚动来查看每个图片。</p>
<p>这就是tweak.php。记着，我们不需要PHP的闭合标签。</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>Woo，这里有好多函数，我们已经在这个教程之中做出了大量的工作。但是不要太高兴，这只是万里长征的第一步路罢了。</p>
<p>敬请关注</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/12/15/peewee-e5-85-a5-e9-97-a8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/15/peewee-e5-85-a5-e9-97-a8/" itemprop="url">peewee入门</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-15T18:37:46+08:00">
                2016-12-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/网页/" itemprop="url" rel="index">
                    <span itemprop="name">网页</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>折腾了几天SQLAlchemy，实在是折腾不动了，所以我决定开一个peewee的坑。</p>
<p>那么，迁移必然是有原因的，我来简单的说一下迁移代码的原因。</p>
<ul>
<li>peewee的写法很像Django自带的orm，对于我这种Django支持者很好</li>
<li>其自带的类型比起SQLAlchemy来说，验证起来要简单许多</li>
<li>peewee轻量级，很方便</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="PIP"><a href="#PIP" class="headerlink" title="PIP"></a>PIP</h2><p>最简单的还是通过<code>PIP</code>来安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install peewee</div></pre></td></tr></table></figure></p>
<p>peewee包含了两个C的扩展：</p>
<ul>
<li>Speedup ： 其包含了一些可以用C来重写的函数，当Cython已经安装的话，这个模块将会被自动安装。</li>
<li>Sqlite扩展 ： 其包含了一些用C操纵的SQLite的函数， REGEXP运算符以及全文搜索排序算法，这个模块应该使用<code>build_sqlite_ext</code>命令来安装<br>安装SQLite扩展的方法：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python setup.py build_sqlite_ext</div><div class="line">python setup.py install</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p>这个工程托管于<a href="https://github.com/coleifer/peewee" target="_blank" rel="external">https://github.com/coleifer/peewee</a>并且可以使用git来安装。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/coleifer/peewee.git</div><div class="line">cd peewee</div><div class="line">python setup.py install</div></pre></td></tr></table></figure></p>
<p>如果你想构建SQLite扩展，你可以这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Build the sqlite extension and place the shared library alongside the other modules.</div><div class="line">python setup.py build_sqlite_ext -i</div></pre></td></tr></table></figure>
<p>在有些系统上，你需要使用<code>sudo</code>来提权</p>
<h1 id="运行测试样例"><a href="#运行测试样例" class="headerlink" title="运行测试样例"></a>运行测试样例</h1><p>运行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">python setup.py test</div><div class="line"></div><div class="line"># Or use the test runner:</div><div class="line">python runtests.py</div></pre></td></tr></table></figure></p>
<p>你也可以使用<code>runtests.py</code>测试指定的特征，默认情况下会使用SQLite数据库，并且playhouse的扩展并不会被测试，你也可以使用下面的命令来查看命令的选项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python runtests.py --help</div></pre></td></tr></table></figure></p>
<h1 id="可选的依赖"><a href="#可选的依赖" class="headerlink" title="可选的依赖"></a>可选的依赖</h1><blockquote>
<p>因为大多数的Python发行版都包含SQLite的支持，你并不需要任何区别于标准库的依赖。你可以在命令行中运行import sqlite3来检测，如果你想运行于其他数据库的话，你可以分别使用满足 DB-API 2.0-compatible的驱动，比如针对MySQL的<code>pymysql</code> 或者针对Postgres的<code>psycopg2</code></p>
</blockquote>
<ul>
<li><a href="http://cython.org/" target="_blank" rel="external">Cython</a> ： 通常用于加速。如果你是用SQLite的话，那么速度提升就会变得很明显</li>
<li><a href="https://github.com/rogerbinns/apsw" target="_blank" rel="external">apsw</a> ： 一个可选的SQLite的第三方库，其提供了更好的性能。你可以通过<a href="http://docs.peewee-orm.com/en/latest/peewee/playhouse.html#AESEncryptedField" title="AESEncryptedField" target="_blank" rel="external"><code>AESEncryptedField</code></a>来使用它。</li>
<li><a href="http://pythonhosted.org/pycrypto/" target="_blank" rel="external">pycrypto</a> ： 一个为了AES加密的库，作用于<a href="http://docs.peewee-orm.com/en/latest/peewee/playhouse.html#AESEncryptedField" title="AESEncryptedField" target="_blank" rel="external"><code>AESEncryptedField</code></a></li>
<li>bcrypt ： bcrypt加密手段，作用于<a href="http://docs.peewee-orm.com/en/latest/peewee/playhouse.html#PasswordField" title="PasswordField" target="_blank" rel="external"><code>PasswordField</code></a></li>
<li><a href="http://www.gevent.org/" target="_blank" rel="external">gevent</a> ：为了SqliteQueueDatabase的一个可选的依赖（其和<code>threading</code>这个库运行的很好）</li>
<li><a href="http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html" target="_blank" rel="external">BerkeleyDB</a> ：可以使用SQLite前端编译，它与Peewee一起工作。<br>如果你使用过django和flask框架，那会对你了解peewee非常有用。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/12/12/e7-ab-99-e7-82-b9-e8-bf-81-e7-a7-bb-e5-88-b0-e6-96-b0-e5-8a-a0-e5-9d-a1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/12/e7-ab-99-e7-82-b9-e8-bf-81-e7-a7-bb-e5-88-b0-e6-96-b0-e5-8a-a0-e5-9d-a1/" itemprop="url">站点迁移到新加坡</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-12T02:46:29+08:00">
                2016-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>以后还请多多关照啦~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/12/01/python-e8-8e-b7-e5-8f-96-e7-b3-bb-e7-bb-9f-e7-8a-b6-e6-80-81psutil-e7-9a-84-e6-a8-a1-e5-9d-97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/01/python-e8-8e-b7-e5-8f-96-e7-b3-bb-e7-bb-9f-e7-8a-b6-e6-80-81psutil-e7-9a-84-e6-a8-a1-e5-9d-97/" itemprop="url">python获取系统状态psutil的模块</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-01T06:45:35+08:00">
                2016-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近需要一个可以实时访问系统信息的模块，网上搜索以后，发现了psutil可以大致满足我的要求。</p>
<h1 id="psutil简介"><a href="#psutil简介" class="headerlink" title="psutil简介"></a>psutil简介</h1><p>psutil(Python system and process utilities)是一个跨平台的进程管理和系统工具的python库，可以处理系统CPU，memory，disks，network等信息。主要用于系统资源的监控，分析，以及对进程进行一定的管理。通过psutil可以实现如<code>ps</code>，<code>top</code>，<code>lsof</code>，<code>netstat</code>，<code>ifconfig</code>， <code>who</code>，<code>df</code>，<code>kill</code>，<code>free</code>，<code>nice</code>，<code>ionice</code>，<code>iostat</code>，<code>iotop</code>，<code>uptime</code>，<code>pidof</code>，<code>tty</code>，<code>taskset</code>，<code>pmap</code>。在Linux，windows，OSX，freebsdSun，Solaris等系统上工作，最新的版本python是要高于2.6(Python 2.4 Python2.5 可以用2.1.3版本)</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>首先确定下当前系统有没有psutil模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> psutil</div></pre></td></tr></table></figure>
<p>如果有的话，就直接导入模块成功，如果没有，就会提示错误然后到官网上下载psutil-2.0.0.tar.gz源码包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tar -zxf psutil-2.0.0.tar.gz &amp; <span class="built_in">cd</span> psutil-2.0.0</div><div class="line">python setup.py install</div></pre></td></tr></table></figure>
<p>也可以直接使用pip install psutil 来安装</p>
<h1 id="系统相关功能"><a href="#系统相关功能" class="headerlink" title="系统相关功能"></a>系统相关功能</h1><h2 id="CPU信息"><a href="#CPU信息" class="headerlink" title="CPU信息"></a>CPU信息</h2><h3 id="cpu-times"><a href="#cpu-times" class="headerlink" title="cpu_times"></a>cpu_times</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.cpu_times(precpu=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>返回系统CPU运行时间的元组，时间为秒。</p>
<h3 id="cpu-percent"><a href="#cpu-percent" class="headerlink" title="cpu_percent"></a>cpu_percent</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.cpu_percent(interval=<span class="keyword">None</span>, percpu=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>返回一个浮点数，代表当前cpu的利用率的百分比，包括sy+user. 当<code>interval</code>为0或者None时，表示的是interval时间内的sys的利用率。 当<code>percpu</code>为True返回是每一个cpu的利用率。</p>
<h3 id="cpu-count"><a href="#cpu-count" class="headerlink" title="cpu_count"></a>cpu_count</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.cpu_count()</div></pre></td></tr></table></figure>
<p>返回CPU的逻辑个数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.cpu_count(logical=<span class="keyword">True</span>)</div></pre></td></tr></table></figure>
<p>返回CPU的物理个数</p>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.virtual_memory()</div></pre></td></tr></table></figure>
<p>返回一个内存信息的元组，大小为字节</p>
<ul>
<li>total: 内存的总大小.</li>
<li>available: 可以用来的分配的内存，不同系统计算方式不同； Linux下的计算公式:free+ buffers +cached</li>
<li>percent: 已经用掉内存的百分比 (total - available) / total 100.</li>
<li>used: 已经用掉内存大小，不同系统计算方式不同</li>
<li>*free: 空闲未被分配的内存，Linux下不包括buffers和cached</li>
</ul>
<p>Platform-specific fields:</p>
<ul>
<li>active: (UNIX): 最近使用内存和正在使用内存。</li>
<li>inactive: (UNIX): 已经分配但是没有使用的内存</li>
<li>buffers: (Linux, BSD): 缓存，linux下的Buffers</li>
<li>cached:(Linux, BSD): 缓存，Linux下的cached.</li>
<li>wired: (BSD, OSX): 一直存在于内存中的部分，不会被移除</li>
<li>shared: (BSD): 缓存</li>
</ul>
<p>内存总大小不等于Used+available,在windows系统可用内存和空闲内存是用一个。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.swap_memory()</div></pre></td></tr></table></figure>
<p>返回系统的swap信息</p>
<ul>
<li>total: swap的总大小 单位为字节</li>
<li>used: 已用的swap大小 bytes</li>
<li>free: 空闲的swap大小 bytes</li>
<li>percent: 已用swap的百分比</li>
<li>sin: 从磁盘调入是swap的大小</li>
<li>sout: 从swap调出到disk的大小<blockquote>
<p><code>sin</code>，<code>sout</code>在windows<strong>没有意义</strong>。</p>
</blockquote>
</li>
</ul>
<h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.disk_partitions(all=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>返回所有挂载的分区的信息的列表，列表中的每一项类似于df命令的格式输出，包括分区，挂载点，文件系统格式，挂载参数等，会忽略掉<code>/dev/shm</code>,<code>/proc/filesystem</code>等，windows上分区格式 “<code>removable</code>“, “<code>fixed</code>“, “<code>remote</code>“, “<code>cdrom</code>“, “<code>unmounted</code>“ or “<code>ramdisk</code>“。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import psutil</div><div class="line">&gt;&gt;&gt; psutil.disk_partitions()</div><div class="line">[sdiskpart(device=&apos;/dev/sda3&apos;, mountpoint=&apos;/&apos;, fstype=&apos;ext4&apos;, opts=&apos;rw,errors=remount-ro&apos;),</div><div class="line"> sdiskpart(device=&apos;/dev/sda7&apos;, mountpoint=&apos;/home&apos;, fstype=&apos;ext4&apos;, opts=&apos;rw&apos;)]</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.disk_usage(path)</div></pre></td></tr></table></figure>
<p>返回硬盘，分区或者目录的使用情况，单位字节</p>
<p>如果不存在会报“<code>OSError</code>”错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import psutil</div><div class="line">&gt;&gt;&gt; psutil.disk_usage(&apos;/&apos;)</div><div class="line">sdiskusage(total=21378641920, used=4809781248, free=15482871808, percent=22.5)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.disk_io_counters(perdisk=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<p>返回当前磁盘的io情况</p>
<ul>
<li>read_count: number of reads</li>
<li>write_count: number of writes</li>
<li>read_bytes: number of bytes read</li>
<li>write_bytes: number of bytes written</li>
<li>read_time: time spent reading from disk (in milliseconds)</li>
<li>write_time: time spent writing to disk (in milliseconds)</li>
</ul>
<h2 id="网络信息"><a href="#网络信息" class="headerlink" title="网络信息"></a>网络信息</h2><p>返回整个系统的网络信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.net_io_counters(pernic=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
<ul>
<li>bytes_sent: 发送的字节数</li>
<li>bytes_recv: 接收的字节数</li>
<li>packets_sent: 发送到数据包的个数</li>
<li>packets_recv: 接受的数据包的个数</li>
<li>errin:</li>
<li>errout: 发送数据包错误的总数</li>
<li>dropin: 接收时丢弃的数据包的总数</li>
<li>dropout: 发送时丢弃的数据包的总数(OSX和BSD系统总是0)</li>
</ul>
<p>如果 <code>pernic</code>值为True，会显示具体各个网卡的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import psutil</div><div class="line">&gt;&gt;&gt; psutil.net_io_counters()</div><div class="line">snetio(bytes_sent=14508483, bytes_recv=62749361, packets_sent=84311, packets_recv=94888, errin=0, errout=0, dropin=0, dropout=0)</div><div class="line">&gt;&gt;&gt;</div><div class="line">&gt;&gt;&gt; psutil.net_io_counters(pernic=True)</div><div class="line">&#123;&apos;lo&apos;: snetio(bytes_sent=547971, bytes_recv=547971, packets_sent=5075, packets_recv=5075, errin=0, errout=0, dropin=0, dropout=0),</div><div class="line">&apos;wlan0&apos;: snetio(bytes_sent=13921765, bytes_recv=62162574, packets_sent=79097, packets_recv=89648, errin=0, errout=0, dropin=0, dropout=0)&#125;</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psutil.net_connections(kind=<span class="string">'inet'</span>)</div></pre></td></tr></table></figure>
<p>返回系统的整个socket连接的信息，可以选择查看哪些类型的连接信息，类似于netstat命令</p>
<p><strong>fd</strong>:</p>
<p> <strong>family</strong>: the address family, either AF_INET, AF_INET6 or AF_UNIX.</p>
<p> <strong>type</strong>: the address type, either SOCK_STREAM or SOCK_DGRAM.</p>
<p> <strong>laddr</strong>: the local address as a (ip, port) tuple or a path in case of AF_UNIX sockets.</p>
<p> <strong>raddr</strong>: the remote address as a (ip, port) tuple or an absolute path in case of UNIX sockets. When the remote endpoint is not connected you’ll <strong>get an empty tuple (AF_INET*) or None (AF_UNIX). On Linux AF_UNIX sockets will always have this set to None. </strong>status<strong>: represents the status of a TCP connection. The return value is one of the psutil.CONN_* constants (a string). For UDP and UNIX </strong>sockets this is always going to be psutil.CONN_NONE.</p>
<p> <strong>pid</strong>: the PID of the process which opened the socket, if retrievable, else None. On some platforms (e.g. Linux) the availability of this field **changes depending on process privileges (root is needed).</p>
<p>参数kind的类型：</p>
<p> “inet” IPv4 and IPv6</p>
<p> “inet4” IPv4</p>
<p> “inet6” IPv6</p>
<p> “tcp” TCP</p>
<p> “tcp4” TCP over IPv4</p>
<p> “tcp6” TCP over IPv6</p>
<p> “udp” UDP</p>
<p> “udp4” UDP over IPv4</p>
<p> “udp6” UDP over IPv6</p>
<p> “unix” UNIX socket (both UDP and TCP protocols)</p>
<p> “all” the sum of all the possible families and protocols</p>
<pre><code>&gt;&gt;&gt;
&gt;&gt;&gt; import psutil
&gt;&gt;&gt; psutil.net_connections()
[pconn(fd=115, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 48776), raddr=(&apos;93.186.135.91&apos;, 80), status=&apos;ESTABLISHED&apos;, pid=1254),
 pconn(fd=117, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 43761), raddr=(&apos;72.14.234.100&apos;, 80), status=&apos;CLOSING&apos;, pid=2987),
 pconn(fd=-1, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 60759), raddr=(&apos;72.14.234.104&apos;, 80), status=&apos;ESTABLISHED&apos;, pid=None),
 pconn(fd=-1, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 51314), raddr=(&apos;72.14.234.83&apos;, 443), status=&apos;SYN_SENT&apos;, pid=None)
 ...]`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## Other system info</div><div class="line"></div><div class="line">`psutil.users()`</div><div class="line"></div><div class="line"> 返回当前系统用户登录信息</div><div class="line"></div><div class="line">**user**: 用户的名称</div><div class="line"></div><div class="line"> **terminal**: 运行终端，tty还是pts等</div><div class="line"></div><div class="line"> **host**: 登录的IP</div><div class="line"></div><div class="line"> **started**: 登录了多长时间</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; psutil.users()
[suser(name=&apos;giampaolo&apos;, terminal=&apos;pts/2&apos;, host=&apos;localhost&apos;, started=1340737536.0),
 suser(name=&apos;giampaolo&apos;, terminal=&apos;pts/3&apos;, host=&apos;localhost&apos;, started=1340737792.0)]`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`psutil.boot_time()`</div><div class="line"></div><div class="line"> 返回当前的时间</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil, datetime
&gt;&gt;&gt; psutil.boot_time()
1389563460.0
&gt;&gt;&gt; datetime.datetime.fromtimestamp(psutil.boot_time()).strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)
&apos;2014-01-12 22:51:00&apos;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">* * *</div><div class="line"></div><div class="line">## Processes</div><div class="line"></div><div class="line">### Functions</div><div class="line"></div><div class="line">`psutil.pids()`</div><div class="line"></div><div class="line"> 返回当前运行的进程pid列表</div><div class="line"></div><div class="line">`psutil.pid_exists(pid)`</div><div class="line"></div><div class="line"> 是否存在次pid，快速的验证方式`pid in psutil.pids()`</div><div class="line"></div><div class="line">`psutil.process_iter()`</div><div class="line"></div><div class="line"> 返回一个包含Process对象的迭代器。每一个对象只创建一次，创建后缓存起来。当一个进程更新时，会更新缓存。遍历所有进程首选psutil.pids().迭代器排序是根据pid。</div></pre></td></tr></table></figure>
<p>`import psutil</p>
<pre><code>for proc in psutil.process_iter():
    try:
        pinfo = proc.as_dict(attrs=[&apos;pid&apos;, &apos;name&apos;])
    except psutil.NoSuchProcess:
        pass
    else:
        print(pinfo)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`psutil.wait_procs(procs, timeout=None, callback=None)`</div><div class="line"></div><div class="line">Convenience function which waits for a list of Process instances to terminate. Return a (gone, alive) tuple indicating which processes are gone and which ones are still alive. The gone ones will have a new returncode attribute indicating process exit status (it may be None). callback is a function which gets called every time a process terminates (a Process instance is passed as callback argument). Function will return as soon as all processes terminate or when timeout occurs. Tipical use case is:</div><div class="line"></div><div class="line">send SIGTERM to a list of processes</div><div class="line"></div><div class="line"> give them some time to terminate</div><div class="line"></div><div class="line"> send SIGKILL to those ones which are still alive</div><div class="line"></div><div class="line">Example:</div></pre></td></tr></table></figure>
<p>`import psutil</p>
<pre><code>def on_terminate(proc):
    print(&quot;process {} terminated&quot;.format(proc))

procs = [...]  # a list of Process instances
for p in procs:
    p.terminate()
gone, alive = wait_procs(procs, timeout=3, callback=on_terminate)
for p in alive:
    p.kill()`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">    ### Exceptions</div><div class="line"></div><div class="line">    `class psutil.Error`</div><div class="line"></div><div class="line">     基础异常，psutil的其他异常都继承这个</div><div class="line"></div><div class="line">    `class psutil.NoSuchProcess(pid, name=None, msg=None)`</div><div class="line"></div><div class="line">     当进程不在进程列表中，或者进程不存在时触发。</div><div class="line"></div><div class="line">    `class psutil.AccessDenied(pid=None, name=None, msg=None)`</div><div class="line"></div><div class="line">     没有权限时，被触发</div><div class="line"></div><div class="line">    `class psutil.TimeoutExpired(seconds, pid=None, name=None, msg=None)`</div><div class="line"></div><div class="line">     当Process.wait() 超时，并且Process 一直在运行时.</div><div class="line"></div><div class="line">    # psutil</div><div class="line"></div><div class="line">    标签（空格分隔）： Python</div><div class="line"></div><div class="line">    * * *</div><div class="line"></div><div class="line">    ## Process class</div><div class="line"></div><div class="line">    `class psutil.Process(pid=None)`</div><div class="line"></div><div class="line">     Process类是一个带有pid的进程。如果没有指定pid，则默认的进程为`os.getpid()`所得进程。Process会触发`NoSuchProcess`（当进程不存在时）和`AccessDenied`异常，</div><div class="line"></div><div class="line">    **注意**</div><div class="line"></div><div class="line">    &gt; Process是通过pid绑定的。如果在一个Process实例，在psutil运行中pid进程死掉，而</div><div class="line">&gt; </div><div class="line">&gt;      这个pid又绑定给了别的新的进程。为了保证Process的安全性可以通过pid+createion time</div><div class="line">&gt; </div><div class="line">&gt;      方式来确认进程是否是同一个。</div><div class="line"></div><div class="line">    `pid`</div><div class="line"></div><div class="line">     进程的PID</div><div class="line"></div><div class="line">    `ppid()`</div><div class="line"></div><div class="line">     父进程pid. On Windows the return value is cached after first call.</div><div class="line"></div><div class="line">    `name()`</div><div class="line"></div><div class="line">     进程名.</div><div class="line"></div><div class="line">    `exe()`</div><div class="line"></div><div class="line">     进程运行命令的绝对路径。</div><div class="line"></div><div class="line">    `cmdline()`</div><div class="line"></div><div class="line">     The command line this process has been called with.</div><div class="line"></div><div class="line">    `create_time()`</div><div class="line"></div><div class="line">     进程创建时间</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil, datetime
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.create_time()
1307289803.47
&gt;&gt;&gt; datetime.datetime.fromtimestamp(p.create_time()).strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)
&apos;2011-03-05 18:03:52&apos;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`as_dict(attrs=None, ad_value=None)`</div><div class="line"></div><div class="line"> 返回进程信息的哈希字典的实用方法，`attrs`指定的值必须是Process的属性值，例如（[&apos;cpu_times&apos;,&apos;name&apos;]）</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.as_dict(attrs=[&apos;pid&apos;, &apos;name&apos;, &apos;username&apos;])
{&apos;username&apos;: &apos;giampaolo&apos;, &apos;pid&apos;: 12366, &apos;name&apos;: &apos;python&apos;}`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`parent()`</div><div class="line"></div><div class="line"> 返回父进程，如果不存在父进程，则返回None。</div><div class="line"></div><div class="line">`status()`</div><div class="line"></div><div class="line"> 进程当前运行状态，string形式。</div><div class="line"></div><div class="line">`cwd()`</div><div class="line"></div><div class="line"> 进程运行的所在的目录</div><div class="line"></div><div class="line">`username()`</div><div class="line"></div><div class="line"> 哪个用户下运行的进程</div><div class="line"></div><div class="line">`uids()`</div><div class="line"></div><div class="line"> 返回real=uid，effective，saved用户的uid</div><div class="line"></div><div class="line">**Availability**: UNIX</div><div class="line"></div><div class="line">`gids()`</div><div class="line"></div><div class="line">**Availability**: UNIX</div><div class="line"></div><div class="line">`terminal()`</div><div class="line"></div><div class="line"> The terminal associated with this process, if any, else None. This is similar to “tty” command but can be used for every process PID.</div><div class="line"></div><div class="line">**Availability**: UNIX</div><div class="line"></div><div class="line">`nice(value=None)`</div><div class="line"></div><div class="line"> 获取或者设置进程的nice值，</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.nice(10)  # set
&gt;&gt;&gt; p.nice()  # get
10
&gt;&gt;&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">在windows系统上，只能通过`GetProrityClass`和`SetPriorityClass`的`psutil.*_PRIORITY_CLASS`包含的值来设定</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; p.nice(psutil.HIGH_PRIORITY_CLASS)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`ionice(ioclass=None, value=None)`</div><div class="line"></div><div class="line"> 获取或者设置进程I/O的优先级。Linux上的`ioclass`的值`psutil.IOPRO_CLASS_*`值在0-7，windows 2 为正常，1为优先级低，0为非常低。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.ionice(psutil.IOPRIO_CLASS_IDLE)  # set
&gt;&gt;&gt; p.ionice()  # get
pionice(ioclass=3, value=0)
&gt;&gt;&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`rlimit(resource, limits=None)`</div><div class="line"></div><div class="line"> Get or set process resource limits (see man prlimit). resource is one of the psutil.RLIMIT_* constants. limits is a (soft, hard) tuple. This is the same as resource.getrlimit() and resource.setrlimit() but can be used for every process PID and only on Linux. Example:</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; # process may open no more than 128 file descriptors
&gt;&gt;&gt; p.rlimit(psutil.RLIMIT_NOFILE, (128, 128))
&gt;&gt;&gt; # process may create files no bigger than 1024 bytes
&gt;&gt;&gt; p.rlimit(psutil.RLIMIT_FSIZE, (1024, 1024))
&gt;&gt;&gt; # get
&gt;&gt;&gt; p.rlimit(psutil.RLIMIT_FSIZE)
(1024, 1024)
&gt;&gt;&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">**Availability**: Linux</div><div class="line"></div><div class="line">`io_counters()`</div><div class="line"></div><div class="line"> 返回这个进程的IO情况</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.io_counters()
pio(read_count=454556, write_count=3456, read_bytes=110592, write_bytes=0)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">**Availability**: all platforms except OSX</div><div class="line"></div><div class="line">`num_ctx_switches()`</div><div class="line"></div><div class="line"> The number voluntary and involuntary context switches performed by this process.</div><div class="line"></div><div class="line">`num_fds()`</div><div class="line"></div><div class="line"> The number of file descriptors used by this process.</div><div class="line"></div><div class="line">**Availability**: UNIX</div><div class="line"></div><div class="line">`num_handles()`</div><div class="line"></div><div class="line"> The number of handles used by this process.</div><div class="line"></div><div class="line">**Availability**: Windows</div><div class="line"></div><div class="line">`num_threads()`</div><div class="line"></div><div class="line"> The number of threads currently used by this process.</div><div class="line"></div><div class="line">`threads()`</div><div class="line"></div><div class="line"> Return threads opened by process as a list of namedtuples including thread id and thread CPU times (user/system).</div><div class="line"></div><div class="line">`cpu_times()`</div><div class="line"></div><div class="line"> Return a tuple whose values are process CPU user and system times which means the amount of time expressed in seconds that a process has spent in user / system mode. This is similar to os.times() but can be used for every process PID.</div><div class="line"></div><div class="line">`cpu_percent(interval=None)`</div><div class="line"></div><div class="line"> Return a float representing the process CPU utilization as a percentage. When interval is &gt; 0.0 compares process times to system CPU times elapsed before and after the interval (blocking). When interval is 0.0 or None compares process times to system CPU times elapsed since last call, returning immediately. That means the first time this is called it will return a meaningless 0.0 value which you are supposed to ignore. In this case is recommended for accuracy that this function be called a second time with at least 0.1 seconds between calls. Example:</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt;
&gt;&gt;&gt; # blocking
&gt;&gt;&gt; p.cpu_percent(interval=1)
2.0
&gt;&gt;&gt; # non-blocking (percentage since last call)
&gt;&gt;&gt; p.cpu_percent(interval=None)
2.9
&gt;&gt;&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">Note a percentage &gt; 100 is legitimate as it can result from a process with multiple threads running on different CPU cores.</div><div class="line"></div><div class="line"> Warning the first time this method is called with interval = 0.0 or None it will return a meaningless 0.0 value which you are supposed to ignore.</div><div class="line"></div><div class="line"> cpu_affinity(cpus=None)</div><div class="line"></div><div class="line"> Get or set process current CPU affinity. CPU affinity consists in telling the OS to run a certain process on a limited set of CPUs only. The number of eligible CPUs can be obtained with list(range(psutil.cpu_count())).</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; psutil.cpu_count()
4
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.cpu_affinity()  # get
[0, 1, 2, 3]
&gt;&gt;&gt; p.cpu_affinity([0])  # set; from now on, process will run on CPU #0 only
&gt;&gt;&gt; p.cpu_affinity()
[0]
&gt;&gt;&gt;
&gt;&gt;&gt; # reset affinity against all CPUs
&gt;&gt;&gt; all_cpus = list(range(psutil.cpu_count()))
&gt;&gt;&gt; p.cpu_affinity(all_cpus)
&gt;&gt;&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">**Availability**: Linux, Windows, BSD</div><div class="line"></div><div class="line">Changed in version 2.2.0: added support for FreeBSD</div><div class="line"></div><div class="line">`memory_info()`</div><div class="line"></div><div class="line"> Return a tuple representing RSS (Resident Set Size) and VMS (Virtual Memory Size) in bytes. On UNIX rss and vms are the same values shown by ps. On Windows rss and vms refer to “Mem Usage” and “VM Size” columns of taskmgr.exe. For more detailed memory stats use memory_info_ex().</div><div class="line"></div><div class="line">`memory_info_ex()`</div><div class="line"></div><div class="line"> Return a namedtuple with variable fields depending on the platform representing extended memory information about the process. All numbers are expressed in bytes.</div><div class="line"></div><div class="line">&lt;table&gt;</div><div class="line">&lt;thead&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;th&gt;Linux&lt;/th&gt;</div><div class="line">&lt;th&gt;OSX&lt;/th&gt;</div><div class="line">&lt;th&gt;BSD&lt;/th&gt;</div><div class="line">&lt;th&gt;SunOS&lt;/th&gt;</div><div class="line">&lt;th&gt;Windows&lt;/th&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;/thead&gt;</div><div class="line">&lt;tbody&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;rss&lt;/td&gt;</div><div class="line">&lt;td&gt;rss&lt;/td&gt;</div><div class="line">&lt;td&gt;rss&lt;/td&gt;</div><div class="line">&lt;td&gt;rss&lt;/td&gt;</div><div class="line">&lt;td&gt;num_page_faults&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;vms&lt;/td&gt;</div><div class="line">&lt;td&gt;vms&lt;/td&gt;</div><div class="line">&lt;td&gt;vms&lt;/td&gt;</div><div class="line">&lt;td&gt;vms&lt;/td&gt;</div><div class="line">&lt;td&gt;peak_wset&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;shared&lt;/td&gt;</div><div class="line">&lt;td&gt;pfaults&lt;/td&gt;</div><div class="line">&lt;td&gt;text&lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;wset&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;text&lt;/td&gt;</div><div class="line">&lt;td&gt;pageins&lt;/td&gt;</div><div class="line">&lt;td&gt;data&lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;peak_paged_pool&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;lib&lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;stack&lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;paged_pool&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;data&lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;peak_nonpaged_pool&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;dirty&lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;nonpaged_pool&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;pagefile&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;peak_pagefile&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt; &lt;/td&gt;</div><div class="line">&lt;td&gt;private&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;/tbody&gt;</div><div class="line">&lt;/table&gt;</div><div class="line"></div><div class="line">Windows metrics are extracted from PROCESS_MEMORY_COUNTERS_EX structure. Example on Linux:</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.memory_info_ex()
pextmem(rss=15491072, vms=84025344, shared=5206016, text=2555904, lib=0, data=9891840, dirty=0)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`memory_percent()`</div><div class="line"></div><div class="line"> Compare physical system memory to process resident memory (RSS) and calculate process memory utilization as a percentage.</div><div class="line"></div><div class="line">`memory_maps(grouped=True)`</div><div class="line"></div><div class="line"> Return process’s mapped memory regions as a list of nameduples whose fields are variable depending on the platform. As such, portable applications should rely on namedtuple’s path and rss fields only. This method is useful to obtain a detailed representation of process memory usage as explained here. If grouped is True the mapped regions with the same path are grouped together and the different memory fields are summed. If grouped is False every mapped region is shown as a single entity and the namedtuple will also include the mapped region’s address space (addr) and permission set (perms). See examples/pmap.py for an example application.</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.memory_maps()
[pmmap_grouped(path=&apos;/lib/x8664-linux-gnu/libutil-2.15.so&apos;, rss=16384, anonymous=8192, swap=0),
 pmmap_grouped(path=&apos;/lib/x8664-linux-gnu/libc-2.15.so&apos;, rss=6384, anonymous=15, swap=0),
 pmmap_grouped(path=&apos;/lib/x8664-linux-gnu/libcrypto.so.0.1&apos;, rss=34124, anonymous=1245, swap=0),
 pmmap_grouped(path=&apos;[heap]&apos;, rss=54653, anonymous=8192, swap=0),
 pmmap_grouped(path=&apos;[stack]&apos;, rss=1542, anonymous=166, swap=0),
 ...]
&gt;&gt;&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`children(recursive=False)`</div><div class="line"></div><div class="line"> Return the children of this process as a list of Process objects, pre-emptively checking whether PID has been reused. If recursive is True return all the parent descendants. Example assuming A == this process:</div><div class="line"></div><div class="line">A ─┐</div><div class="line"></div><div class="line"> │</div><div class="line"></div><div class="line"> ├─ B (child) ─┐</div><div class="line"></div><div class="line"> │ └─ X (grandchild) ─┐</div><div class="line"></div><div class="line"> │ └─ Y (great grandchild)</div><div class="line"></div><div class="line"> ├─ C (child)</div><div class="line"></div><div class="line"> └─ D (child)</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; p.children()<br>    B, C, D</p>
<pre><code>&gt;&gt;&gt; p.children(recursive=True)
B, X, Y, C, D`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">Note that in the example above if process X disappears process Y won’t be returned either as the reference to process A is lost.</div><div class="line"></div><div class="line">`open_files()`</div><div class="line"></div><div class="line"> Return regular files opened by process as a list of namedtuples including the absolute file name and the file descriptor number (on Windows this is always -1). Example:</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; f = open(&apos;file.ext&apos;, &apos;w&apos;)
&gt;&gt;&gt; p = psutil.Process()
&gt;&gt;&gt; p.open_files()
[popenfile(path=&apos;/home/giampaolo/svn/psutil/file.ext&apos;, fd=3)]`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`connections(kind=&quot;inet&quot;)`</div><div class="line"></div><div class="line"> Return socket connections opened by process as a list of namedutples. To get system-wide connections use psutil.net_connections(). Every namedtuple provides 6 attributes:</div><div class="line"></div><div class="line">**fd:** the socket file descriptor. This can be passed to socket.fromfd() to obtain a usable socket object. This is only available on UNIX; on Windows -1 is always returned.</div><div class="line"></div><div class="line"> **family:** the address family, either AF_INET, AF_INET6 or AF_UNIX.</div><div class="line"></div><div class="line"> **type:** the address type, either SOCK_STREAM or SOCK_DGRAM.</div><div class="line"></div><div class="line"> **laddr:** the local address as a (ip, port) tuple or a path in case of AF_UNIX sockets.</div><div class="line"></div><div class="line"> **raddr:** the remote address as a (ip, port) tuple or an absolute path in case of UNIX sockets. When the remote endpoint is not connected you’ll get an empty tuple (AF_INET) or None (AF_UNIX). On Linux AF_UNIX sockets will always have this set to None.</div><div class="line"></div><div class="line"> **status:** represents the status of a TCP connection. The return value is one of the psutil.CONN_* constants. For UDP and UNIX sockets this is always going to be `psutil.CONN_NONE`.</div><div class="line"></div><div class="line">The kind parameter is a string which filters for connections that fit the following criteria:</div><div class="line"></div><div class="line">&lt;table&gt;</div><div class="line">&lt;thead&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;th&gt;Kind value&lt;/th&gt;</div><div class="line">&lt;th&gt;Connections using&lt;/th&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;/thead&gt;</div><div class="line">&lt;tbody&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“inet”&lt;/td&gt;</div><div class="line">&lt;td&gt;IPv4 and IPv6&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“inet4”&lt;/td&gt;</div><div class="line">&lt;td&gt;IPv4&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“inet6”&lt;/td&gt;</div><div class="line">&lt;td&gt;IPv6&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“tcp”&lt;/td&gt;</div><div class="line">&lt;td&gt;TCP&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“tcp4”&lt;/td&gt;</div><div class="line">&lt;td&gt;TCP over IPv4&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“tcp6”&lt;/td&gt;</div><div class="line">&lt;td&gt;TCP over IPv6&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“udp”&lt;/td&gt;</div><div class="line">&lt;td&gt;UDP&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“udp4”&lt;/td&gt;</div><div class="line">&lt;td&gt;UDP over IPv4&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“udp6”&lt;/td&gt;</div><div class="line">&lt;td&gt;UDP over IPv6&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“unix”&lt;/td&gt;</div><div class="line">&lt;td&gt;UNIX socket (both UDP and TCP protocols)&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;tr&gt;</div><div class="line">&lt;td&gt;“all”&lt;/td&gt;</div><div class="line">&lt;td&gt;the sum of all the possible families and protocols&lt;/td&gt;</div><div class="line">&lt;/tr&gt;</div><div class="line">&lt;/tbody&gt;</div><div class="line">&lt;/table&gt;</div><div class="line"></div><div class="line">Example:</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; p = psutil.Process(1694)
&gt;&gt;&gt; p.name()
&apos;firefox&apos;
&gt;&gt;&gt; p.connections()
[pconn(fd=115, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 48776), raddr=(&apos;93.186.135.91&apos;, 80), status=&apos;ESTABLISHED&apos;),
 pconn(fd=117, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 43761), raddr=(&apos;72.14.234.100&apos;, 80), status=&apos;CLOSING&apos;),
 pconn(fd=119, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 60759), raddr=(&apos;72.14.234.104&apos;, 80), status=&apos;ESTABLISHED&apos;),
 pconn(fd=123, family=2, type=1, laddr=(&apos;10.0.0.1&apos;, 51314), raddr=(&apos;72.14.234.83&apos;, 443), status=&apos;SYN_SENT&apos;)]`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`is_running()`</div><div class="line"></div><div class="line"> 判断进程是否存活</div><div class="line"></div><div class="line"> Return whether the current process is running in the current process list. This is reliable also in case the process is gone and its PID reused by another process, therefore it must be preferred over doing psutil.pid_exists(p.pid).</div><div class="line"></div><div class="line">Note this will return True also if the process is a zombie (p.status() == psutil.STATUS_ZOMBIE).</div><div class="line"></div><div class="line"> `send_signal(signal)`</div><div class="line"></div><div class="line"> 发送新号给进程</div><div class="line"></div><div class="line"> Send a signal to process (see signal module constants) pre-emptively checking whether PID has been reused. This is the same as os.kill(pid, sig). On Windows only SIGTERM is valid and is treated as an alias for kill().</div><div class="line"></div><div class="line">`suspend()`</div><div class="line"></div><div class="line"> Suspend process execution with SIGSTOP signal pre-emptively checking whether PID has been reused. On UNIX this is the same as os.kill(pid, signal.SIGSTOP). On Windows this is done by suspending all process threads execution.</div><div class="line"></div><div class="line">`resume()`</div><div class="line"></div><div class="line"> Resume process execution with SIGCONT signal pre-emptively checking whether PID has been reused. On UNIX this is the same as os.kill(pid, signal.SIGCONT). On Windows this is done by resuming all process threads execution.</div><div class="line"></div><div class="line">`terminate()`</div><div class="line"></div><div class="line"> Terminate the process with SIGTERM signal pre-emptively checking whether PID has been reused. On UNIX this is the same as os.kill(pid, signal.SIGTERM). On Windows this is an alias for kill().</div><div class="line"></div><div class="line">`kill()`</div><div class="line"></div><div class="line"> Kill the current process by using SIGKILL signal pre-emptively checking whether PID has been reused. On UNIX this is the same as os.kill(pid, signal.SIGKILL). On Windows this is done by using TerminateProcess.</div><div class="line"></div><div class="line">`wait(timeout=None)`</div><div class="line"></div><div class="line"> Wait for process termination and if the process is a children of the current one also return the exit code, else None. On Windows there’s no such limitation (exit code is always returned). If the process is already terminated immediately return None instead of raising NoSuchProcess. If timeout is specified and process is still alive raise TimeoutExpired exception. It can also be used in a non-blocking fashion by specifying timeout=0 in which case it will either return immediately or raise TimeoutExpired. To wait for multiple processes use psutil.wait_procs().</div><div class="line"></div><div class="line">### Popen class</div><div class="line"></div><div class="line">`class psutil.Popen(*args, **kwargs)`</div><div class="line"></div><div class="line"> A more convenient interface to stdlib subprocess.Popen. It starts a sub process and deals with it exactly as when using subprocess.Popen but in addition it also provides all the methods of psutil.Process class in a single interface. For method names common to both classes such as send_signal(), terminate() and kill() psutil.Process implementation takes precedence. For a complete documentation refer to subprocess module documentation.</div><div class="line"></div><div class="line">Note Unlike subprocess.Popen this class pre-emptively checks wheter PID has been reused on send_signal(), terminate() and kill() so that you don’t accidentally terminate another process, fixing [http://bugs.python.org/issue6973](http://bugs.python.org/issue6973).</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt;</p>
<pre><code>&gt;&gt;&gt; import psutil
&gt;&gt;&gt; from subprocess import PIPE
&gt;&gt;&gt;
&gt;&gt;&gt; p = psutil.Popen([&quot;/usr/bin/python&quot;, &quot;-c&quot;, &quot;print(&apos;hello&apos;)&quot;], stdout=PIPE)
&gt;&gt;&gt; p.name()
&apos;python&apos;
&gt;&gt;&gt; p.username()
&apos;giampaolo&apos;
&gt;&gt;&gt; p.communicate()
(&apos;hello\n&apos;, None)
&gt;&gt;&gt; p.wait(timeout=2)
0
&gt;&gt;&gt;
</code></pre><h3 id="Constants"><a href="#Constants" class="headerlink" title="Constants"></a>Constants</h3><blockquote>
<p>psutil.STATUS_RUNNING</p>
<p> psutil.STATUS_SLEEPING</p>
<p> psutil.STATUS_DISK_SLEEP</p>
<p> psutil.STATUS_STOPPED</p>
<p> psutil.STATUS_TRACING_STOP</p>
<p> psutil.STATUS_ZOMBIE</p>
<p> psutil.STATUS_DEAD</p>
<p> psutil.STATUS_WAKE_KILL</p>
<p> psutil.STATUS_WAKING</p>
<p> psutil.STATUS_IDLE</p>
<p> psutil.STATUS_LOCKED</p>
<p> psutil.STATUS_WAITING</p>
</blockquote>
<p>A set of strings representing the status of a process. Returned by psutil.Process.status().</p>
<blockquote>
<p>psutil.CONN_ESTABLISHED</p>
<p> psutil.CONN_SYN_SENT</p>
<p> psutil.CONN_SYN_RECV</p>
<p> psutil.CONN_FIN_WAIT1</p>
<p> psutil.CONN_FIN_WAIT2</p>
<p> psutil.CONN_TIME_WAIT</p>
<p> psutil.CONN_CLOSE</p>
<p> psutil.CONN_CLOSE_WAIT</p>
<p> psutil.CONN_LAST_ACK</p>
<p> psutil.CONN_LISTEN</p>
<p> psutil.CONN_CLOSING</p>
<p> psutil.CONN_NONE</p>
<p> psutil.CONN_DELETE_TCB(Windows)</p>
<p> psutil.CONN_IDLE(Solaris)</p>
<p> psutil.CONN_BOUND(Solaris)</p>
</blockquote>
<p>A set of strings representing the status of a TCP connection. Returned by psutil.Process.connections() (status field).</p>
<blockquote>
<p>psutil.ABOVE_NORMAL_PRIORITY_CLASS</p>
<p> psutil.BELOW_NORMAL_PRIORITY_CLASS</p>
<p> psutil.HIGH_PRIORITY_CLASS</p>
<p> psutil.IDLE_PRIORITY_CLASS</p>
<p> psutil.NORMAL_PRIORITY_CLASS</p>
<p> psutil.REALTIME_PRIORITY_CLASS</p>
<p> A set of integers representing the priority of a process on Windows (see MSDN documentation). They can be used in conjunction with psutil.Process.nice() to get or set process priority.</p>
</blockquote>
<p><strong>Availability</strong>: Windows</p>
<p>psutil.IOPRIO_CLASS_NONE</p>
<p> psutil.IOPRIO_CLASS_RT</p>
<p> psutil.IOPRIO_CLASS_BE</p>
<p> psutil.IOPRIO_CLASS_IDLE</p>
<p> A set of integers representing the I/O priority of a process on Linux. They can be used in conjunction with psutil.Process.ionice() to get or set process I/O priority. IOPRIO_CLASS_NONE and IOPRIO_CLASS_BE (best effort) is the default for any process that hasn’t set a specific I/O priority. IOPRIO_CLASS_RT (real time) means the process is given first access to the disk, regardless of what else is going on in the system. IOPRIO_CLASS_IDLE means the process will get I/O time when no-one else needs the disk. For further information refer to manuals of ionice command line utility or ioprio_get system call.</p>
<p><strong>Availability</strong>: Linux</p>
<blockquote>
<p>psutil.RLIMIT_INFINITY</p>
<p> psutil.RLIMIT_AS</p>
<p> psutil.RLIMIT_CORE</p>
<p> psutil.RLIMIT_CPU</p>
<p> psutil.RLIMIT_DATA</p>
<p> psutil.RLIMIT_FSIZE</p>
<p> psutil.RLIMIT_LOCKS</p>
<p> psutil.RLIMIT_MEMLOCK</p>
<p> psutil.RLIMIT_MSGQUEUE</p>
<p> psutil.RLIMIT_NICE</p>
<p> psutil.RLIMIT_NOFILE</p>
<p> psutil.RLIMIT_NPROC</p>
<p> psutil.RLIMIT_RSS</p>
<p> psutil.RLIMIT_RTPRIO</p>
<p> psutil.RLIMIT_RTTIME</p>
<p> psutil.RLIMIT_RTPRIO</p>
<p> psutil.RLIMIT_SIGPENDING</p>
<p> psutil.RLIMIT_STACK</p>
<p> Constants used for getting and setting process resource limits to be used in conjunction with psutil.Process.rlimit(). See man prlimit for futher information.</p>
</blockquote>
<p><strong>Availability</strong>: Linux</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/11/28/bcrypt-e7-9a-84-e4-bd-bf-e7-94-a8-e6-96-b9-e6-b3-95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/28/bcrypt-e7-9a-84-e4-bd-bf-e7-94-a8-e6-96-b9-e6-b3-95/" itemprop="url">bcrypt的使用方法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-28T00:29:32+08:00">
                2016-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网页/" itemprop="url" rel="index">
                    <span itemprop="name">网页</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>还是因为倒腾lab.npuacm.info，看了网上的一些关于密码存储的报道，再加上我之前开发Django的经验，我选择bcrypt作为加密密码的方法。</p>
<p>bcrypt作为一种非常有力的加密手法。它的口令必须是8至56个字符，并将在内部被转化为448位的密钥。然而，所提供的所有字符都具有十分重要的意义。密码越强大，您的数据就越安全。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>最简单的还是使用pip了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip install bcrypt</div></pre></td></tr></table></figure>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><p>哈希然后检查这个值是否正确很简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> bcrypt</div><div class="line">password = <span class="string">b"super secret password"</span></div><div class="line"><span class="comment"># Hash a password for the first time, with a randomly-generated salt</span></div><div class="line">hashed = bcrypt.hashpw(password, bcrypt.gensalt())</div><div class="line"><span class="comment"># Check that a unhashed password matches one that has previously been</span></div><div class="line"><span class="comment">#   hashed</span></div><div class="line"><span class="keyword">if</span> bcrypt.hashpw(password, hashed) == hashed:</div><div class="line">     print(<span class="string">"It Matches!"</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">     print(<span class="string">"It Does not Match :("</span>)</div></pre></td></tr></table></figure>
<h1 id="可调节的工作轮次"><a href="#可调节的工作轮次" class="headerlink" title="可调节的工作轮次"></a>可调节的工作轮次</h1><p>bcrypt的特性之一是可调的工作轮次。调节这个轮次，你只需要传入round的参数就可以了。<code>bcrypt.gensalt(rounds=12)</code> 默认的就是12</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> bcrypt</div><div class="line">password = <span class="string">b"super secret password"</span></div><div class="line"><span class="comment"># Hash a password for the first time, with a certain number of rounds</span></div><div class="line">hashed = bcrypt.hashpw(password, bcrypt.gensalt(<span class="number">14</span>))</div><div class="line"><span class="comment"># Check that a unhashed password matches one that has previously been</span></div><div class="line"><span class="comment">#   hashed</span></div><div class="line"><span class="keyword">if</span> bcrypt.hashpw(password, hashed) == hashed:</div><div class="line">    print(<span class="string">"It Matches!"</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    print(<span class="string">"It Does not Match :("</span>)</div></pre></td></tr></table></figure>
<h1 id="可调节的前缀"><a href="#可调节的前缀" class="headerlink" title="可调节的前缀"></a>可调节的前缀</h1><p>你也可以调整bcrypt的前缀来决定其会兼容谁，你可以传递2a或者2b（默认值）来决定。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bcrypt.gensalt(prefix=<span class="string">b"2b"</span>)</div></pre></td></tr></table></figure>
<h1 id="兼容的版本"><a href="#兼容的版本" class="headerlink" title="兼容的版本"></a>兼容的版本</h1><p>其可以运行于Python2.6+、3.2+以及PyPy之上。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/11/27/nginx-e5-af-b9-e4-ba-8etornado-e7-9a-84-e9-85-8d-e7-bd-ae/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/27/nginx-e5-af-b9-e4-ba-8etornado-e7-9a-84-e9-85-8d-e7-bd-ae/" itemprop="url">Nginx对于Tornado的配置</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-27T23:38:23+08:00">
                2016-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/网页/" itemprop="url" rel="index">
                    <span itemprop="name">网页</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近一直被轰炸HTTPS的好处，于是咬咬牙把<a href="https://lab.npuacm.info" target="_blank" rel="external">lab.npuacm.info</a>加了个SSL。下面我就简单的说一下步骤。</p>
<h1 id="获得SSL证书"><a href="#获得SSL证书" class="headerlink" title="获得SSL证书"></a>获得SSL证书</h1><p>对于SSL证书，我们可以在下面这些网站获得：</p>
<ol>
<li><a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s encrypt</a></li>
<li><a href="https://www.startssl.com/" target="_blank" rel="external">StartSSL</a></li>
<li>腾讯云提供的<a href="https://www.qcloud.com/product/ssl.html" target="_blank" rel="external">SSL</a>证书</li>
</ol>
<p>前面几种网上案例很多，我就不多说了，需要注意的是第一和第二个都是需要Shell权限的，所以如果你没有权限的话，那就需要联系一下你的server提供商了。</p>
<h1 id="配置Nginx服务器"><a href="#配置Nginx服务器" class="headerlink" title="配置Nginx服务器"></a>配置Nginx服务器</h1><p>网上主要可以配置Nginx和Tornado主程序两种，不过我还是建议各位dalao直接去配置Nginx，毕竟耐艹，而且对于静态文件而言，还需要Nginx来处理。</p>
<p>首先，我的思路是，需要对原来的HTTP访问全部转发到HTTPS上，所以，我们可以在Nginx中配置这一项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    server_name example.com;</div><div class="line"></div><div class="line">    rewrite /(.*) https://$http_host/$1 redirect;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后就要对HTTPS进行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 443;</div><div class="line">    ssl on;</div><div class="line">    ssl_certificate /path/to/cert.pem;</div><div class="line">    ssl_certificate_key /path/to/cert.key;</div><div class="line"></div><div class="line">    default_type application/octet-stream;</div><div class="line"></div><div class="line">    location /static/ &#123;</div><div class="line">        root /var/www/static;</div><div class="line">        if ($query_string) &#123;</div><div class="line">            expires max;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location = /favicon.ico &#123;</div><div class="line">        rewrite (.*) /static/favicon.ico;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        proxy_pass_header Server;</div><div class="line">        proxy_set_header Host $http_host;</div><div class="line">        proxy_redirect off;</div><div class="line">        proxy_set_header X-Real-IP $remote_addr;</div><div class="line">        proxy_set_header X-Scheme $scheme;</div><div class="line">        proxy_pass http://tornadoes;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是这样明显不够，因为我的tornado中使用了Websocket技术，这里就不能使用<code>ws://</code>协议而应该是<code>wss://</code>了，所以我们需要告诉Nginx开启Websocket服务。</p>
<p>所以最终的代码应该是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">upstream tornados&#123;</div><div class="line">    server 127.0.0.1:8003;</div><div class="line">    server 127.0.0.1:8001;</div><div class="line">    server 127.0.0.1:8002;</div><div class="line">&#125;</div><div class="line">proxy_next_upstream error;</div><div class="line">server &#123;</div><div class="line">    listen  80;</div><div class="line">    server_name lab.npuacm.info;</div><div class="line"></div><div class="line">    # rewrite</div><div class="line">    rewrite /(.*) https://$http_host/$1 redirect;</div><div class="line">&#125;</div><div class="line">server&#123;</div><div class="line">    listen 443;</div><div class="line">    ssl on;</div><div class="line">    server_name lab.npuacm.info;</div><div class="line"></div><div class="line">    ssl_certificate your_public_key.crt;</div><div class="line">    ssl_certificate_key your_key.key;</div><div class="line"></div><div class="line">    default_type application/octet-stream;</div><div class="line"></div><div class="line">	# Nginx处理这个问题</div><div class="line">    location /static/ &#123;</div><div class="line">        root /home/ubuntu/npuacmLab;</div><div class="line">        if ($query_string)&#123;</div><div class="line">            expires 24h;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    location / &#123;</div><div class="line">        proxy_pass_header Server;</div><div class="line">        proxy_set_header Host $http_host;</div><div class="line">        proxy_redirect off;</div><div class="line">        proxy_set_header X-Real-IP $remote_addr;</div><div class="line">        proxy_set_header X-Scheme $scheme;</div><div class="line">        proxy_pass http://tornados;</div><div class="line">        proxy_http_version 1.1;</div><div class="line">        proxy_set_header Upgrade $http_upgrade;</div><div class="line">        proxy_set_header Connection &quot;upgrade&quot;;</div><div class="line">        proxy_set_header Host $host;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自然，如果你并不想配置ngnix的话，你可以直接在本地开启HTTPS服务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">http_server = tornado.httpserver.HTTPServer(app</div><div class="line">    ssl_options=&#123;</div><div class="line">    <span class="string">"certfile"</span>: os.path.join(os.path.abspath(<span class="string">"SSL"</span>), <span class="string">"public_key.crt"</span>),</div><div class="line">    <span class="string">"keyfile"</span>: os.path.join(os.path.abspath(<span class="string">"SSL"</span>), <span class="string">"private_key.key"</span>),</div><div class="line">&#125;</div><div class="line">)</div><div class="line">http_server.listen(options.port)</div><div class="line">tornado.ioloop.IOLoop.instance().start()</div></pre></td></tr></table></figure>
<p>这样本地调试的时候，你就可以直接输入HTTPS调试了，同样的Websocket也可以直接使用<code>wss://</code>协议了。</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>被国内运营商劫持的满屏幕都是充话费的。。。也是醉了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/11/14/abaqus-e6-a8-a1-e6-8b-9f-e8-9e-ba-e6-a0-93-e8-bf-9e-e6-8e-a5-e7-9a-84-e6-96-b9-e6-b3-95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/14/abaqus-e6-a8-a1-e6-8b-9f-e8-9e-ba-e6-a0-93-e8-bf-9e-e6-8e-a5-e7-9a-84-e6-96-b9-e6-b3-95/" itemprop="url">ABAQUS模拟螺栓连接的方法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-14T05:52:14+08:00">
                2016-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/机械/" itemprop="url" rel="index">
                    <span itemprop="name">机械</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>螺栓连接是结构连接的一种主要方式，在CAE分析中经常遇到，针对不同的情况，通常我们会采取不同的方法来处理。如果仿真的重点在于模拟螺栓，要求输出螺栓的应力、变形数据等，则将其创建为三维部件进行精细建模；如果螺栓在仿真过程中是次要的，只起简单的连接和紧固作用，则可以使用MPC约束和梁单元对螺栓进行简化建模。作为一款功能强大的通用CAE软件，ABAQUS处理普通螺栓连接的方式有三种：带螺纹的实体螺栓、不带螺纹的实体螺栓和MPC与梁单元组合的螺栓简化模型。</p>
<h1 id="带螺纹的实体螺栓"><a href="#带螺纹的实体螺栓" class="headerlink" title="带螺纹的实体螺栓"></a>带螺纹的实体螺栓</h1><p>对于带螺纹的实体螺栓仿真，只需在ABAQUS中定义适当的接触关系，选择合适的摩擦系数即可，通常使用通用接触即可满足计算的要求。采用这种实体螺栓的仿真计算，虽然得到的结果很精确，但却大大增加了螺栓模型前处理的工作量（螺栓和螺纹均用六面体网格建模），且计算量大，计算过程中接触收敛困难。因此，在精度要求不高的情况下，不采用这种实体螺栓模型。</p>
<h1 id="不带螺纹的实体螺栓"><a href="#不带螺纹的实体螺栓" class="headerlink" title="不带螺纹的实体螺栓"></a>不带螺纹的实体螺栓</h1><p>为了简化模型，提高计算的效率，可以创建不带螺纹的实体螺栓模型。这种情况下，只需在ABAQUS的接触定义中设置跟实际螺纹形状有关联的参数，如牙角、螺距、螺栓小径等，即可以模拟真实的螺栓连接接触状况，得到足够精确的结果，同时节省了分析的时间，提高分析效率。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/11/05/sqlalchemy-e5-85-b3-e7-b3-bb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/05/sqlalchemy-e5-85-b3-e7-b3-bb/" itemprop="url">SQLAlchemy关系</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-05T04:20:42+08:00">
                2016-11-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>『关系』是关系型数据库的一大特色，也是我们在建模过程中的一个重要的抽象过程。在前面的两个教程中，我们分别回顾了使用SQLAlchemy在数据库中进行<a href="http://www.jianshu.com/p/0d234e14b5d3" target="_blank" rel="external">创建</a>和<a href="http://www.jianshu.com/p/8d085e2f2657" target="_blank" rel="external">简单查询</a>的方法，今天我们来深入到更为复杂和抽象部分。</p>
<h1 id="建立关系"><a href="#建立关系" class="headerlink" title="建立关系"></a>建立关系</h1><p>之前我们已经建立了一个用户(User)表，现在我们来考虑增加一个与用户关联的新的表。在我们的系统里面，用户可以存储多个与之相关的email地址。这是一种基本的一对多的关系。我们把这个新增加的存储email地址的表称为<code>addresses</code>。应用Declarative，我们按照如下方式定义这个新表：</p>
<pre><code>&gt;&gt;&gt; from sqlalchemy import ForeignKey
&gt;&gt;&gt; from sqlalchemy.orm import relationship

&gt;&gt;&gt; class Address(Base):
...     __tablename__ = &apos;addresses&apos;
...     id = Column(Integer, primary_key=True)
...     email_address = Column(String, nullable=False)
...     user_id = Column(Integer, ForeignKey(&apos;users.id&apos;))
...
...     user = relationship(&quot;User&quot;, back_populates=&quot;addresses&quot;)
...
...     def __repr__(self):
...         return &quot;&lt;Address(email_address=&apos;%s&apos;)&gt;&quot; % self.email_address

&gt;&gt;&gt; User.addresses = relationship(
...     &quot;Address&quot;, order_by=Address.id, back_populates=&quot;user&quot;)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">上面的代码中我们使用了一个新的名为`ForeignKey`的构造。其含义为，其所在的列的值域应当被限制在另一个表的指定列的取值范围之类。这一特性是关系型数据库的核心特性之一。就上例而言，`addresses.user_id`这一列的取值范围，应当包含在`users.id`的取值范围之内。</div><div class="line"></div><div class="line">除了`ForeignKey`之外，我们还引入了一个`relationship`，来告诉ORM，`Address`类需要被连接到`User`类。`relationship`和`ForeignKey`这个两个属性决定了表之间关系的属性，决定了这个关系是多对一的。</div><div class="line"></div><div class="line">在完成对`Address`类的声明之后，我们还定义另一个`relationship`，将其赋值给了`User.addresses`。在两个`relationship`中，我们都有传入了一个`relationship.back_populates`的属性来为反向关系所对应的属性进行命名。（作者：到这里为止，看来SQLAlchemy中定义关系要比Django的ORM要麻烦许多。Django中只需要一行就可以了。而且这里的两个`relationship`的定义明显是冗余的）</div><div class="line"></div><div class="line">多对一的关系的反向永远都是一对多的关系。关于更多的`relationship()`的配置方法，可以参见这个链接[Basic Relationship Patterns](http://docs.sqlalchemy.org/en/rel_1_0/orm/basic_relationships.html#relationship-patterns)。</div><div class="line"></div><div class="line">上述我们定义的两个互补的关系`Address.user`和`User.addresses`被称为双向关系([bidirectional relationship](http://docs.sqlalchemy.org/en/rel_1_0/glossary.html#term-bidirectional-relationship))，这是SQLAlchemy的核心特性这一。</div><div class="line"></div><div class="line">`relationship()`的参数配置中指向被连接的类的字符串，可以指向工程中任何位置所定义的，基于`declarative base`的类，而无先后之分。Declarative会在完成所有的映射以后的将这些字符串转换为适当的、实际使用的参数形式。</div><div class="line"></div><div class="line"># 使用关联对象</div><div class="line"></div><div class="line">现在，当我们创建一个`User`实例的时候，会同时创建一个空的`addresses`的collection。这个collection可能是多种类型，如list, set, 或是dictionary。默认情况下，其应当为一个Python列表。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; jack = User(name=’jack’, fullname=’Jack Bean’, password=’gjffdd’)</p>
<pre><code>&gt;&gt;&gt; jack.addresses
[]`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">此时你可以自由的向这个列表里面插入`User`对象。</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt; jack.addresses = [
    ...                 Address(email_address=&#39;jack@google.com&#39;),
    ...                 Address(email_address=&#39;j25@yahoo.com&#39;)]</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">当使用bidirectional relationship时，通过其中一个方向的关系（如上例）会自动出现在另一个方向的关系上。</div></pre></td></tr></table></figure></p>
<p>`&gt;&gt;&gt; jack.addresses[1]<br>    <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#x6f;&#x3a;&#65;&#x64;&#100;&#x72;&#101;&#x73;&#x73;&#40;&#x65;&#x6d;&#97;&#105;&#x6c;&#95;&#x61;&#x64;&#x64;&#114;&#x65;&#115;&#x73;&#x3d;&#x27;&#x6a;&#x32;&#53;&#64;&#121;&#97;&#x68;&#111;&#x6f;&#46;&#x63;&#111;&#109;&#39;&#41;">&#65;&#x64;&#100;&#x72;&#101;&#x73;&#x73;&#40;&#x65;&#x6d;&#97;&#105;&#x6c;&#95;&#x61;&#x64;&#x64;&#114;&#x65;&#115;&#x73;&#x3d;&#x27;&#x6a;&#x32;&#53;&#64;&#121;&#97;&#x68;&#111;&#x6f;&#46;&#x63;&#111;&#109;&#39;&#41;</a></p>
<pre><code>&gt;&gt;&gt; jack.addresses[1].user
&lt;User(name=&apos;jack&apos;, fullname=&apos;Jack Bean&apos;, password=&apos;gjffdd&apos;)&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">让我们把jack添加进入`Session`。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; session.add(jack)</p>
<pre><code>&gt;&gt;&gt; session.commit()
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
(&apos;jack&apos;, &apos;Jack Bean&apos;, &apos;gjffdd&apos;)
INSERT INTO addresses (email_address, user_id) VALUES (?, ?)
(&apos;jack@google.com&apos;, 5)
INSERT INTO addresses (email_address, user_id) VALUES (?, ?)
(&apos;j25@yahoo.com&apos;, 5)
COMMIT`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">可以发现上面执行了三个`INSERT`命令，也就是说与jack关联的两个`Address`对象也被提交了。现在我们通过查询来取出jack。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; jack = session.query(User).\<br>    … filter_by(name=’jack’).one()<br>    BEGIN (implicit)<br>    SELECT users.id AS users_id,<br>            users.name AS users_name,<br>            users.fullname AS users_fullname,<br>            users.password AS users_password<br>    FROM users<br>    WHERE users.name = ?<br>    (‘jack’,)</p>
<pre><code>&gt;&gt;&gt; jack
&lt;User(name=&apos;jack&apos;, fullname=&apos;Jack Bean&apos;, password=&apos;gjffdd&apos;)&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">可以发现目前只有针对`User`表的查询，而没有对`Address`表的查询。此时访问`addresses`属性，相关的SQL才会执行</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt; jack.addresses
    SELECT addresses.id AS addresses_id,
            addresses.email_address AS
            addresses_email_address,
            addresses.user_id AS addresses_user_id
    FROM addresses
    WHERE ? = addresses.user_id ORDER BY addresses.id
    (5,)
    [&lt;Address(email_address=&#39;jack@google.com&#39;)&gt;, &lt;Address(email_address=&#39;j25@yahoo.com&#39;)&gt;]</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">上面这种方式我们称之为[lazy loading](http://docs.sqlalchemy.org/en/rel_1_0/glossary.html#term-lazy-loading)。</div><div class="line"></div><div class="line"># 使用join进行查询</div><div class="line"></div><div class="line">现在我们有了两会在那个彼此关联的数据表了，相比与上一篇教程中的简单查询情况，此时试图对这两张表进行联合查询就更加复杂一些了。关于join技术，读者可以自行阅读[我的前一篇文章](http://www.jianshu.com/p/9e1d3793cba6)。</div><div class="line"></div><div class="line">为了在`User`和`Address`之间构造一个简单的join，我们可以通过`Query.filter()`来连接其相关列（本质是隐式写法的JOIN）。下面是一个简单的例子：</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; for u, a in session.query(User, Address).\
    ...                     filter(User.id==Address.user_id).\
    ...                     filter(Address.email_address==&#39;jack@google.com&#39;).\
    ...                     all():
    ...     print(u)
    ...     print(a)
    &lt;User(name=&#39;jack&#39;, fullname=&#39;Jack Bean&#39;, password=&#39;gjffdd&#39;)&gt;
    &lt;Address(email_address=&#39;jack@google.com&#39;)&gt;</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">而实际的SQL JOIN语法，可以通过`Query.join()`来想实现</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; session.query(User).join(Address).\
    ...         filter(Address.email_address==&#39;jack@google.com&#39;).\
    ...         all()
    users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users JOIN addresses ON users.id = addresses.user_id
    WHERE addresses.email_address = ?
    (&#39;jack@google.com&#39;,)
    [&lt;User(name=&#39;jack&#39;, fullname=&#39;Jack Bean&#39;, password=&#39;gjffdd&#39;)&gt;]</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">在上面的例子中由于只存在一个ForeignKey，`Query.join`知道如何选取合适的列进行JOIN。如果没有定义ForeignKey，或者存在多个，此时你需要手动指明你参与JOIN的列。`Query.join()`以如下方式进行：</div></pre></td></tr></table></figure></p>
<p><code>query.join(Address, User.id==Address.user_id)    # explicit condition
    query.join(User.addresses)                       # specify relationship from left to right
    query.join(Address, User.addresses)              # same, with explicit target
    query.join(&#39;addresses&#39;)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">对于OUTER JOIN，只需要使用`Query.outerjoin()`就可以了。</div></pre></td></tr></table></figure></p>
<p><code>query.outerjoin(User.addresses)   # LEFT OUTER JOIN</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">关于`join()`更为详细的用法，还是请参考官方的文档[join](http://docs.sqlalchemy.org/en/rel_1_0/orm/query.html#sqlalchemy.orm.query.Query.join)</div><div class="line"></div><div class="line">## 使用Aliases</div><div class="line"></div><div class="line">当你的查询涉及多个表，而其中同一个表出现了多次时，你需要的为重复的表aliase一个新的名字来避免冲突。这个功能其实我们在上一篇文章里面也提到过，下面是关于`aliased`的一个例子：</div></pre></td></tr></table></figure></p>
<p>`&gt;&gt;&gt; from sqlalchemy.orm import aliased</p>
<pre><code>&gt;&gt;&gt; adalias1 = aliased(Address)
&gt;&gt;&gt; adalias2 = aliased(Address)
&gt;&gt;&gt; for username, email1, email2 in \
...     session.query(User.name, adalias1.email_address, adalias2.email_address).\
...     join(adalias1, User.addresses).\
...     join(adalias2, User.addresses).\
...     filter(adalias1.email_address==&apos;jack@google.com&apos;).\
...     filter(adalias2.email_address==&apos;j25@yahoo.com&apos;):
...     print(username, email1, email2)
SELECT users.name AS users_name,
        addresses_1.email_address AS addresses_1_email_address,
        addresses_2.email_address AS addresses_2_email_address
FROM users JOIN addresses AS addresses_1
        ON users.id = addresses_1.user_id
JOIN addresses AS addresses_2
        ON users.id = addresses_2.user_id
WHERE addresses_1.email_address = ?
        AND addresses_2.email_address = ?
(&apos;jack@google.com&apos;, &apos;j25@yahoo.com&apos;)
jack jack@google.com j25@yahoo.com`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## 使用子查询(Subqueries)</div><div class="line"></div><div class="line">`Query`适合于用来构造子查询。假如我们想要取出`User`记录，并且同时计算各个用户的`Address`的数量。产生这种功能的SQL指令最好的办法是按照user的id分组统计地址的数量，然后join到外层查询。此时我们需要LEFT JOIN，这样可以使得没有地址的用户也会出现在查询结果中（地址数量为0）。 我们期望的SQL命令是这样的：</div></pre></td></tr></table></figure>
<p><code>SELECT users.*, adr_count.address_count FROM users LEFT OUTER JOIN
        (SELECT user_id, count(*) AS address_count
            FROM addresses GROUP BY user_id) AS adr_count
        ON users.id=adr_count.user_id</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">使用`Query`，我们可以从内到外来构造上面的语句。</div></pre></td></tr></table></figure></p>
<p>`&gt;&gt;&gt; from sqlalchemy.sql import func</p>
<pre><code>&gt;&gt;&gt; stmt = session.query(Address.user_id, func.count(&apos;*&apos;).\
...         label(&apos;address_count&apos;)).\
...         group_by(Address.user_id).subquery()`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`func`我们已经在之前的教程中认识过了。`subquery()`可以产生一个内嵌了alias（是一个`query.statement.alias()`）的查询(SELECT)语句的表达。</div><div class="line"></div><div class="line">当我们生成了statement之后，其完全可以视为一个`Table`来使用。你可以通过`c`来访问它的属性。</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt; for u, count in session.query(User, stmt.c.address_count).\
    ...     outerjoin(stmt, User.id==stmt.c.user_id).order_by(User.id):
    ...     print(u, count)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password,
            anon_1.address_count AS anon_1_address_count
    FROM users LEFT OUTER JOIN
        (SELECT addresses.user_id AS user_id, count(?) AS address_count
        FROM addresses GROUP BY addresses.user_id) AS anon_1
        ON users.id = anon_1.user_id
    ORDER BY users.id
    (&#39;*&#39;,)
    &lt;User(name=&#39;ed&#39;, fullname=&#39;Ed Jones&#39;, password=&#39;f8s7ccs&#39;)&gt; None
    &lt;User(name=&#39;wendy&#39;, fullname=&#39;Wendy Williams&#39;, password=&#39;foobar&#39;)&gt; None
    &lt;User(name=&#39;mary&#39;, fullname=&#39;Mary Contrary&#39;, password=&#39;xxg527&#39;)&gt; None
    &lt;User(name=&#39;fred&#39;, fullname=&#39;Fred Flinstone&#39;, password=&#39;blah&#39;)&gt; None
    &lt;User(name=&#39;jack&#39;, fullname=&#39;Jack Bean&#39;, password=&#39;gjffdd&#39;)&gt; 2</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## 从子查询中取出Entity</div><div class="line"></div><div class="line">在前一个例子中，我们从子查询活着的是一个临时性的JOIN后的表，但是这个表并未定义我们在ORM中定义的Entity。如果我们想将这个临时表映射到ORM中的类呢？此时我们可以使用`aliased`这个函数来完成这个映射。</div></pre></td></tr></table></figure></p>
<p>`&gt;&gt;&gt; stmt = session.query(Address).\<br>    …                 filter(Address.email_address != ‘j25@yahoo.com’).\<br>    …                 subquery()</p>
<pre><code>&gt;&gt;&gt; adalias = aliased(Address, stmt)
&gt;&gt;&gt; for user, address in session.query(User, adalias).\
...         join(adalias, User.addresses):
...     print(user)
...     print(address)
SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password,
            anon_1.id AS anon_1_id,
            anon_1.email_address AS anon_1_email_address,
            anon_1.user_id AS anon_1_user_id
FROM users JOIN
    (SELECT addresses.id AS id,
            addresses.email_address AS email_address,
            addresses.user_id AS user_id
    FROM addresses
    WHERE addresses.email_address != ?) AS anon_1
    ON users.id = anon_1.user_id
(&apos;j25@yahoo.com&apos;,)
&lt;User(name=&apos;jack&apos;, fullname=&apos;Jack Bean&apos;, password=&apos;gjffdd&apos;)&gt;
&lt;Address(email_address=&apos;jack@google.com&apos;)&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"># 使用EXISTS</div><div class="line"></div><div class="line">EXISTS关键字是一个BOOL型操作符。当查询结果存在至少一行时返回True。EXISTS可以常常和JOIN搭配使用。</div><div class="line"></div><div class="line">下面是一个显式的EXISTS构造方法：</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; from sqlalchemy.sql import exists</p>
<pre><code>&gt;&gt;&gt; stmt = exists().where(Address.user_id==User.id)
&gt;&gt;&gt; for name, in session.query(User.name).filter(stmt):
...     print(name)
SELECT users.name AS users_name
FROM users
WHERE EXISTS (SELECT *
FROM addresses
WHERE addresses.user_id = users.id)
()
jack`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`Query`还定义了若干个自动使用了EXISTS的操作。上面的例子可以用`any()`来完成：</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt; for name, in session.query(User.name).\
    ...         filter(User.addresses.any()):
    ...     print(name)
    SELECT users.name AS users_name
    FROM users
    WHERE EXISTS (SELECT 1
    FROM addresses
    WHERE users.id = addresses.user_id)
    ()
    jack</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`any()`也接受筛选条件来限制匹配的行：</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; for name, in session.query(User.name).\
    ...     filter(User.addresses.any(Address.email_address.like(&#39;%google%&#39;))):
    ...     print(name)
    jack</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">`has()`对于的many-to-one的关系，起到的是和`any()`同样的作用（注意这里`~`表示NOT）：</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; session.query(Address).\
    ...         filter(~Address.user.has(User.name==&#39;jack&#39;)).all()
    []</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">    ## 常用的关系操作</div><div class="line"></div><div class="line">    下面只是简单的列出了一些常用的操作。想要更为详细的了解这些功能，还是推荐去官网的相关文档。</div><div class="line"></div><div class="line">*   **eq**() (many-to-one “equals” comparison):</div></pre></td></tr></table></figure></p>
<p><code>query.filter(Address.user == someuser)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   **ne**() (many-to-one “not equals” comparison):</div></pre></td></tr></table></figure></p>
<p><code>query.filter(Address.user != someuser)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   IS NULL (many-to-one comparison, also uses **eq**()):</div></pre></td></tr></table></figure></p>
<p><code>query.filter(Address.user == None)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   contains() (used for one-to-many collections):</div></pre></td></tr></table></figure></p>
<p><code>query.filter(User.addresses.contains(someaddress))</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   any() (used for collections):</div></pre></td></tr></table></figure></p>
<p>`query.filter(User.addresses.any(Address.email_address == ‘bar’))</p>
<pre><code># also takes keyword arguments:
query.filter(User.addresses.any(email_address=&apos;bar&apos;))`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   has() (used for scalar references):</div></pre></td></tr></table></figure>
<p><code>query.filter(Address.user.has(name=&#39;ed&#39;))</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   Query.with_parent() (used for any relationship):</div></pre></td></tr></table></figure></p>
<p><code>session.query(Address).with_parent(someuser, &#39;addresses&#39;)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## Eager Loading（找不到合适的翻译）</div><div class="line"></div><div class="line">前面的教程中我们有提及到lazing loading的机制。当我们通过查询取出用户时，与之关联的地址并没有取出来。当我们试图获取`User.addresses`时，相关的针对地址的SQL查询才起作用。如果你想要减少query的次数的话，就需要使用Eager Loading了。SQLAlchemy提供了三种Eager Loading的方式，其中两种是自动的，而第三种涉及到自定义的筛选条件。所有的这三种Eager Loading方式都会通过调用`Query.options()`来影响查询的过程，促使`Query`生成需要的额外配置来取出期望的内容。</div><div class="line"></div><div class="line"># Subquery Loading</div><div class="line"></div><div class="line">在上面的例子中，我们希望在 取出用户的时候就同步取出对应的地址。此时你们可以此采用`orm.subqueryload()`。这个函数可以发起第二个SELECT查询来取出与结果相关的另一个表的信息。这里取名为&quot;subquery&quot;的原因是，此处的`Query`在发起第二个查询时作为子查询而被复用了。详细过程参加下面的程序：</div></pre></td></tr></table></figure></p>
<p>`&gt;&gt;&gt; from sqlalchemy.orm import subqueryload</p>
<pre><code>&gt;&gt;&gt; jack = session.query(User).\
...                 options(subqueryload(User.addresses)).\
...                 filter_by(name=&apos;jack&apos;).one()
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ?
(&apos;jack&apos;,)
SELECT addresses.id AS addresses_id,
        addresses.email_address AS addresses_email_address,
        addresses.user_id AS addresses_user_id,
        anon_1.users_id AS anon_1_users_id
FROM (SELECT users.id AS users_id
    FROM users WHERE users.name = ?) AS anon_1
JOIN addresses ON anon_1.users_id = addresses.user_id
ORDER BY anon_1.users_id, addresses.id
(&apos;jack&apos;,)
&gt;&gt;&gt; jack
&lt;User(name=&apos;jack&apos;, fullname=&apos;Jack Bean&apos;, password=&apos;gjffdd&apos;)&gt;

&gt;&gt;&gt; jack.addresses
[&lt;Address(email_address=&apos;jack@google.com&apos;)&gt;, &lt;Address(email_address=&apos;j25@yahoo.com&apos;)&gt;]`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">**注意**：当`subqueryload()`和涉及limiting的函数一起使用的时候（如`Query.first()`, `Query.limit()`, Query.offset()`等），应当加上一个以Unique的行作为参数的`Query.order_by()`来确保结果的正确性。详情参见[The importance of Ordering](http://docs.sqlalchemy.org/en/rel_1_0/orm/loading_relationships.html#subqueryload-ordering)</div><div class="line"></div><div class="line"># Joined Load</div><div class="line"></div><div class="line">这种自动Eager Loading的方式要更为常用一些。Joined Loading发起了一个JOIN（默认是LEFT OUTER JOIN），故而查询结果和制定的与之关联的行可以被同时取出。我们这里以和上面的Subquery Loading中同样的查询目的为例。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; from sqlalchemy.orm import joinedload</p>
<pre><code>&gt;&gt;&gt; jack = session.query(User).\
...                        options(joinedload(User.addresses)).\
...                        filter_by(name=&apos;jack&apos;).one()
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password,
        addresses_1.id AS addresses_1_id,
        addresses_1.email_address AS addresses_1_email_address,
        addresses_1.user_id AS addresses_1_user_id
FROM users
    LEFT OUTER JOIN addresses AS addresses_1 ON users.id = addresses_1.user_id
WHERE users.name = ? ORDER BY addresses_1.id
(&apos;jack&apos;,)

&gt;&gt;&gt; jack
&lt;User(name=&apos;jack&apos;, fullname=&apos;Jack Bean&apos;, password=&apos;gjffdd&apos;)&gt;

&gt;&gt;&gt; jack.addresses
[&lt;Address(email_address=&apos;jack@google.com&apos;)&gt;, &lt;Address(email_address=&apos;j25@yahoo.com&apos;)&gt;]`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">注意到，如果你是在命令行运行了前一个Subquery Loading的例子的话，在这里jack的addresses实际上已经填充了的，但是这里的Joined Load仍然是会发起JOIN。另外，LEFT OUTER JOIN指令实际上有可能导致重复的User出现，但是在结果中实际得到的User却不会重复。这是因为`Query`实际上是基于Object Identity采用了一种&quot;uniquing&quot;的策略。</div><div class="line"></div><div class="line">历史上来看`joinedload()`出现的更早一些。`joinedloading()`更加适合于处理Many-to-one的关系。</div><div class="line"></div><div class="line"># 显式的Join + EagerLoad</div><div class="line"></div><div class="line">第三种方式我们是我们自己显式的调用join来定位JOIN连接主键，并接着关联表的信息填充到查询结果中对应对象或者列表中。这个特性需要使用到`orm.contains_eager()`函数。这个机制最典型的用途是pre-loading many-to-one关系，同时添加对这个关系的筛选。我们用下面的这个例子来阐述说明上面这些比较绕的话。假设我们需要筛选出用户的名字为jack的邮件地址，进行这个查询的方法如下：</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; from sqlalchemy.orm import contains_eager</p>
<pre><code>&gt;&gt;&gt; jacks_addresses = session.query(Address).\
...                             join(Address.user).\
...                             filter(User.name==&apos;jack&apos;).\
...                             options(contains_eager(Address.user)).\
...                             all()
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password,
        addresses.id AS addresses_id,
        addresses.email_address AS addresses_email_address,
        addresses.user_id AS addresses_user_id
FROM addresses JOIN users ON users.id = addresses.user_id
WHERE users.name = ?
(&apos;jack&apos;,)

&gt;&gt;&gt; jacks_addresses
[&lt;Address(email_address=&apos;jack@google.com&apos;)&gt;, &lt;Address(email_address=&apos;j25@yahoo.com&apos;)&gt;]

&gt;&gt;&gt; jacks_addresses[0].user
&lt;User(name=&apos;jack&apos;, fullname=&apos;Jack Bean&apos;, password=&apos;gjffdd&apos;)&gt;`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## 关系中的删除问题</div><div class="line"></div><div class="line">沃恩尝试删除jack，来看结果：</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; session.delete(jack)</p>
<pre><code>&gt;&gt;&gt; session.query(User).filter_by(name=&apos;jack&apos;).count()
UPDATE addresses SET user_id=? WHERE addresses.id = ?
((None, 1), (None, 2))
DELETE FROM users WHERE users.id = ?
(5,)
SELECT count(*) AS count_1
FROM (SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ?) AS anon_1
(&apos;jack&apos;,)
0`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">那么与jack关联的地址呢？</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt; session.query(Address).filter(
    ...     Address.email_address.in_([&#39;jack@google.com&#39;, &#39;j25@yahoo.com&#39;])
    ...  ).count()
    2</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">地址记录仍然在这里。如果我们commit的话，我们可以从上面的SQL语句中发现，相关的`Address`的`user_id`属性被设置成了NULL。这不符合我们的要求。那么我们需要自己来设置关系的删除规则。</div><div class="line"></div><div class="line">## 配置delete/delete-orphan Cascade</div><div class="line"></div><div class="line">我们通过配置`User.addresses`关系的**cascade***选项来控制删除行为。尽管SQLAlchemy允许你在任何时候给ORM添加属性或者关系。此时我们还是需要移除现存的关系并且重新开始（作者：django的ORM包含）。让我们首先关闭当前的session</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; session.close()</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">并且使用一个新的`declarative_base()`:</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; Base = declarative_base()</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">下面我们重新声明`User`类，注意`addresses`中的配置：</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; class User(Base):
    ...     __tablename__ = &#39;users&#39;
    ...
    ...     id = Column(Integer, primary_key=True)
    ...     name = Column(String)
    ...     fullname = Column(String)
    ...     password = Column(String)
    ...
    ...     addresses = relationship(&quot;Address&quot;, back_populates=&#39;user&#39;,
    ...                     cascade=&quot;all, delete, delete-orphan&quot;)
    ...
    ...     def __repr__(self):
    ...        return &quot;&lt;User(name=&#39;%s&#39;, fullname=&#39;%s&#39;, password=&#39;%s&#39;)&gt;&quot; % (
    ...                                self.name, self.fullname, self.password)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">接下来重新声明`Address`。</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; class Address(Base):
    ...     __tablename__ = &#39;addresses&#39;
    ...     id = Column(Integer, primary_key=True)
    ...     email_address = Column(String, nullable=False)
    ...     user_id = Column(Integer, ForeignKey(&#39;users.id&#39;))
    ...     user = relationship(&quot;User&quot;, back_populates=&quot;addresses&quot;)
    ...
    ...     def __repr__(self):
    ...         return &quot;&lt;Address(email_address=&#39;%s&#39;)&gt;&quot; % self.email_address</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">现在让我们取出jack(下面我们使用了一个之前没有提到的函数`get()`，其参数为查询目标的主键)，现在从`addresses`中删除一个地址的话，会导致这个`Address`被删除。</div></pre></td></tr></table></figure></p>
<p>`# load Jack by primary key<br>    SQL&gt;&gt;&gt; jack = session.query(User).get(5)</p>
<pre><code># remove one Address (lazy load fires off)
SQL&gt;&gt;&gt; del jack.addresses[1]

# only one address remains
SQL&gt;&gt;&gt; session.query(Address).filter(
...     Address.email_address.in_([&apos;jack@google.com&apos;, &apos;j25@yahoo.com&apos;])
... ).count()
1`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">删除jack也会导致剩下jack以及其所有的`Address`都会被删除:</div></pre></td></tr></table></figure>
<p>`&gt;&gt; session.delete(jack)</p>
<pre><code>SQL&gt;&gt;&gt; session.query(User).filter_by(name=&apos;jack&apos;).count()
0

SQL&gt;&gt;&gt; session.query(Address).filter(
...    Address.email_address.in_([&apos;jack@google.com&apos;, &apos;j25@yahoo.com&apos;])
... ).count()
0`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">关于更多的Cascade配置请参见官方文档。</div><div class="line"></div><div class="line">## 建立多对多关系ManyToMany Relationship</div><div class="line"></div><div class="line">现在我们需要引入一个新的模型来阐述多对多的关系了。假设我们需要完成一个博客应用。在这个应用里面我们可以书写`BlogPost`，每个博客都有若干`Keyword`。</div><div class="line"></div><div class="line">对于一个多对多的关系，我们需要建立一个未映射的（也就是没有一个Python类与之对应的）表`Table`来作为中间联系的表。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; from sqlalchemy import Table, Text</p>
<pre><code>&gt;&gt;&gt; # association table
&gt;&gt;&gt; post_keywords = Table(&apos;post_keywords&apos;, Base.metadata,
...     Column(&apos;post_id&apos;, ForeignKey(&apos;posts.id&apos;), primary_key=True),
...     Column(&apos;keyword_id&apos;, ForeignKey(&apos;keywords.id&apos;), primary_key=True)
... )`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">不同于我们之前的典型的ORM方法，在上面的代码中我们直接声明了一个`Table`，而没有制定与之对应的Python类。`Table`是一个构造函数，其参数中的每个`Colomn`以逗号分隔。</div><div class="line"></div><div class="line">下面我们来定义`BlogPost`和`Keyword`。我们这里需要使用`relationship()`在这两个类中定义一对互补的关系，其中每个关系的都指向`post_keyword`这个表。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; class BlogPost(Base):<br>    …     <strong>tablename</strong> = ‘posts’<br>    …<br>    …     id = Column(Integer, primary_key=True)<br>    …     user_id = Column(Integer, ForeignKey(‘users.id’))<br>    …     headline = Column(String(255), nullable=False)<br>    …     body = Column(Text)<br>    …<br>    …     # many to many BlogPost&lt;-&gt;Keyword<br>    …     keywords = relationship(‘Keyword’,<br>    …                             secondary=post_keywords,<br>    …                             back_populates=’posts’)<br>    …<br>    …     def <strong>init</strong>(self, headline, body, author):<br>    …         self.author = author<br>    …         self.headline = headline<br>    …         self.body = body<br>    …<br>    …     def <strong>repr</strong>(self):<br>    …         return “BlogPost(%r, %r, %r)” % (self.headline, self.body, self.author)</p>
<pre><code>&gt;&gt;&gt; class Keyword(Base):
...     __tablename__ = &apos;keywords&apos;
...
...     id = Column(Integer, primary_key=True)
...     keyword = Column(String(50), nullable=False, unique=True)
...     posts = relationship(&apos;BlogPost&apos;,
...                          secondary=post_keywords,
...                          back_populates=&apos;keywords&apos;)
...
...     def __init__(self, keyword):
...         self.keyword = keyword`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">在上面的定义中，我们可以发现和OneToMany关系不同，`relationship()`中多了一个`secondary`的参数，这个参数指向了中间表(原文为associated table)。这个中间表只包含了指向多对多关系两侧的表的主键的列。如果这个表包含了其他属性，甚至是自身的主键，SQLAlchemy需要你使用另一种，称为`association object`的机制来处理。</div><div class="line"></div><div class="line">我们还希望我们的`BlogPost`能够拥有一个`author`属性，这个属性指向我们先前定义的`User`。此时我们需要再定义一个双向关系。由于一个作者可能拥有很多文章，我们希望访问`User.posts`的时候可以加以筛选而不是载入全部的相关文章。为此我们在定义`User.posts`中的时候，设置`lazy=&apos;dynamic&apos;`，来控制载入策略。</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; BlogPost.author = relationship(User, back_populates=”posts”)</p>
<pre><code>&gt;&gt;&gt; User.posts = relationship(BlogPost, back_populates=&quot;author&quot;, lazy=&quot;dynamic&quot;)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">然后让我们来创建数据库中对应的表</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt; Base.metadata.create_all(engine)
    PRAGMA...
    CREATE TABLE keywords (
        id INTEGER NOT NULL,
        keyword VARCHAR(50) NOT NULL,
        PRIMARY KEY (id),
        UNIQUE (keyword)
    )
    ()
    COMMIT
    CREATE TABLE posts (
        id INTEGER NOT NULL,
        user_id INTEGER,
        headline VARCHAR(255) NOT NULL,
        body TEXT,
        PRIMARY KEY (id),
        FOREIGN KEY(user_id) REFERENCES users (id)
    )
    ()
    COMMIT
    CREATE TABLE post_keywords (
        post_id INTEGER NOT NULL,
        keyword_id INTEGER NOT NULL,
        PRIMARY KEY (post_id, keyword_id),
        FOREIGN KEY(post_id) REFERENCES posts (id),
        FOREIGN KEY(keyword_id) REFERENCES keywords (id)
    )
    ()
    COMMIT</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">多对多关系的使用方法道也没有太大的不同之处。让我们先来给windy添加博文。</div></pre></td></tr></table></figure></p>
<p>`&gt;&gt;&gt; wendy = session.query(User).\<br>    …                 filter_by(name=’wendy’).\<br>    …                 one()</p>
<pre><code>&gt;&gt;&gt; post = BlogPost(&quot;Wendy&apos;s Blog Post&quot;, &quot;This is a test&quot;, wendy)
&gt;&gt;&gt; session.add(post)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">给博文添加一些关键字。目前数据库里面还没有关键字存在，我们创建一些：</div></pre></td></tr></table></figure>
<p>`&gt;&gt;&gt; post.keywords.append(Keyword(‘wendy’))</p>
<pre><code>&gt;&gt;&gt; post.keywords.append(Keyword(&apos;firstpost&apos;))`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">我们可以开始查询了。先以&apos;firstpost&apos;为关键字来检索所有的博文。我们使用`any`来查询拥有关键词&apos;firstpost&apos;的博文：</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt; session.query(BlogPost).\
    ...             filter(BlogPost.keywords.any(keyword=&#39;firstpost&#39;)).\
    ...             all()
    [BlogPost(&quot;Wendy&#39;s Blog Post&quot;, &#39;This is a test&#39;, &lt;User(name=&#39;wendy&#39;, fullname=&#39;Wendy Williams&#39;, password=&#39;foobar&#39;)&gt;)]</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">如果我们希望将查询范围限制在wendy用户所拥有的博文之内，</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; session.query(BlogPost).\
    ...             filter(BlogPost.author==wendy).\
    ...             filter(BlogPost.keywords.any(keyword=&#39;firstpost&#39;)).\
    ...             all()
    SELECT posts.id AS posts_id,
            posts.user_id AS posts_user_id,
            posts.headline AS posts_headline,
            posts.body AS posts_body
    FROM posts
    WHERE ? = posts.user_id AND (EXISTS (SELECT 1
        FROM post_keywords, keywords
        WHERE posts.id = post_keywords.post_id
            AND keywords.id = post_keywords.keyword_id
            AND keywords.keyword = ?))
    (2, &#39;firstpost&#39;)
    [BlogPost(&quot;Wendy&#39;s Blog Post&quot;, &#39;This is a test&#39;, &lt;User(name=&#39;wendy&#39;, fullname=&#39;Wendy Williams&#39;, password=&#39;foobar&#39;)&gt;)]</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">或者我们可以直接在wendy的`posts`属性上进行查询：</div></pre></td></tr></table></figure></p>
<p>`&gt;&gt;&gt; wendy.posts.\<br>    …         filter(BlogPost.keywords.any(keyword=’firstpost’)).\<br>    …         all()<br>    [BlogPost(“Wendy’s Blog Post”, ‘This is a test’, <user(name='wendy', fullname="Wendy Williams" ,="" password="foobar" )="">)]</user(name='wendy',></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/11/05/sqlalchemy-e6-9f-a5-e8-af-a2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/05/sqlalchemy-e6-9f-a5-e8-af-a2/" itemprop="url">SQLAlchemy查询</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-05T04:15:08+08:00">
                2016-11-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>和Django一样，我们orm也要知道如何查询数据。</p>
<h1 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h1><p><code>Session</code>的<code>query</code>函数会返回一个<code>Query</code>对象。<code>query</code>函数可以接受多种参数类型。可以是类，或者是类的instrumented <strong>descriptor</strong>。下面的这个例子取出了所有的<code>User</code>记录。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> instance <span class="keyword">in</span> session.query(User).order_by(User.id):</div><div class="line"><span class="meta">... </span>    print(instance.name, instance.fullname)</div><div class="line">ed Ed Jones</div><div class="line">wendy Wendy Williams</div><div class="line">mary Mary Contrary</div><div class="line">fred Fred Flinstone</div></pre></td></tr></table></figure>
<p><code>Query</code>也接受ORM-instrumented descriptors作为参数。当多个参数传入时，返回结果为以同样顺序排列的tuples</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> name, fullname <span class="keyword">in</span> session.query(User.name, User.fullname):</div><div class="line"><span class="meta">... </span>    print(name, fullname)</div><div class="line">ed Ed Jones</div><div class="line">wendy Wendy Williams</div><div class="line">mary Mary Contrary</div><div class="line">fred Fred Flinstone</div></pre></td></tr></table></figure>
<p><code>Query</code>返回的tuples由<code>KeyedTuple</code>这个类提供，其成员除了用下标访问意外，还可以视为实例变量来获取。对应的变量的名称与被查询的类变量名称一样，如下例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User, User.name).all():</div><div class="line"><span class="meta">... </span>   print(row.User, row.name)</div><div class="line">&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'Ed Jones'</span>, password=<span class="string">'f8s7ccs'</span>)&gt; ed</div><div class="line">&lt;User(name=<span class="string">'wendy'</span>, fullname=<span class="string">'Wendy Williams'</span>, password=<span class="string">'foobar'</span>)&gt; wendy</div><div class="line">&lt;User(name=<span class="string">'mary'</span>, fullname=<span class="string">'Mary Contrary'</span>, password=<span class="string">'xxg527'</span>)&gt; mary</div><div class="line">&lt;User(name=<span class="string">'fred'</span>, fullname=<span class="string">'Fred Flinstone'</span>, password=<span class="string">'blah'</span>)&gt; fred</div></pre></td></tr></table></figure>
<p>你可以通过<code>label()</code>来制定descriptor对应实例变量的名称</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User.name.label(<span class="string">'name_label'</span>)).all():</div><div class="line"><span class="meta">... </span>   print(row.name_label)</div><div class="line">ed</div><div class="line">wendy</div><div class="line">mary</div><div class="line">fred</div></pre></td></tr></table></figure>
<p>而对于类参数而言，要实现同样的定制需要使用<code>aliased</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> aliased</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>user_alias = aliased(User, name=<span class="string">'user_alias'</span>)</div><div class="line"></div><div class="line">SQL&gt;&gt;&gt; <span class="keyword">for</span> row <span class="keyword">in</span> session.query(user_alias, user_alias.name).all():</div><div class="line"><span class="meta">... </span>   print(row.user_alias)</div><div class="line">&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'Ed Jones'</span>, password=<span class="string">'f8s7ccs'</span>)&gt;</div><div class="line">&lt;User(name=<span class="string">'wendy'</span>, fullname=<span class="string">'Wendy Williams'</span>, password=<span class="string">'foobar'</span>)&gt;</div><div class="line">&lt;User(name=<span class="string">'mary'</span>, fullname=<span class="string">'Mary Contrary'</span>, password=<span class="string">'xxg527'</span>)&gt;</div><div class="line">&lt;User(name=<span class="string">'fred'</span>, fullname=<span class="string">'Fred Flinstone'</span>, password=<span class="string">'blah'</span>)&gt;</div></pre></td></tr></table></figure>
<p>基本的查询操作除了上面这些之外，还包括OFFSET和LIMIT，这个可以通过Python的array slice来完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> u <span class="keyword">in</span> session.query(User).order_by(User.id)[<span class="number">1</span>:<span class="number">3</span>]:</div><div class="line"><span class="meta">... </span>   print(u)</div><div class="line">&lt;User(name=<span class="string">'wendy'</span>, fullname=<span class="string">'Wendy Williams'</span>, password=<span class="string">'foobar'</span>)&gt;</div><div class="line">&lt;User(name=<span class="string">'mary'</span>, fullname=<span class="string">'Mary Contrary'</span>, password=<span class="string">'xxg527'</span>)&gt;</div></pre></td></tr></table></figure>
<p>上述过程实际上只涉及了整体取出的操作，而没有进行筛选，筛选常用的函数是<code>filter_by</code>和<code>filter</code>。其中后者比起前者要更灵活一些，你可以在后者的参数中使用python的运算符。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> name, <span class="keyword">in</span> session.query(User.name).\</div><div class="line"><span class="meta">... </span>            filter_by(fullname=<span class="string">'Ed Jones'</span>):</div><div class="line"><span class="meta">... </span>   print(name)</div><div class="line">ed</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> name, <span class="keyword">in</span> session.query(User.name).\</div><div class="line"><span class="meta">... </span>            filter(User.fullname==<span class="string">'Ed Jones'</span>):</div><div class="line"><span class="meta">... </span>   print(name)</div><div class="line">ed</div></pre></td></tr></table></figure>
<p>注意<code>Query</code>对象是<strong>generative</strong>的，这意味你可以把他们串接起来调用，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> user <span class="keyword">in</span> session.query(User).\</div><div class="line"><span class="meta">... </span>         filter(User.name==<span class="string">'ed'</span>).\</div><div class="line"><span class="meta">... </span>         filter(User.fullname==<span class="string">'Ed Jones'</span>):</div><div class="line"><span class="meta">... </span>   print(user)</div><div class="line">&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'Ed Jones'</span>, password=<span class="string">'f8s7ccs'</span>)&gt;</div></pre></td></tr></table></figure>
<p>串接的<code>filter</code>之间是<strong>与</strong>的关系。</p>
<h1 id="常用的filter操作符"><a href="#常用的filter操作符" class="headerlink" title="常用的filter操作符"></a>常用的filter操作符</h1><p>下面的这些操作符可以应用在<code>filter</code>函数中</p>
<ul>
<li><p><code>equals</code>:</p>
<p>query.filter(User.name == ‘ed’)`</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">*   `not equals`:</div></pre></td></tr></table></figure>
</li>
</ul>
<p><code>query.filter(User.name != &#39;ed&#39;)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">*   `LIKE`:</div></pre></td></tr></table></figure></p>
<p><code>query.filter(User.name.like(&#39;%ed%&#39;))</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">*   `IN`:</div></pre></td></tr></table></figure></p>
<p>`query.filter(User.name.in_([‘ed’, ‘wendy’, ‘jack’]))</p>
<pre><code># works with query objects too:
query.filter(User.name.in_(
        session.query(User.name).filter(User.name.like(&apos;%ed%&apos;))
))`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   `NOT IN`:</div></pre></td></tr></table></figure>
<p><code>query.filter(~User.name.in_([&#39;ed&#39;, &#39;wendy&#39;, &#39;jack&#39;]))</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   `IS NULL`:</div></pre></td></tr></table></figure></p>
<p>`query.filter(User.name == None)</p>
<pre><code># alternatively, if pep8/linters are a concern
query.filter(User.name.is_(None))`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   `IS NOT NULL`:</div></pre></td></tr></table></figure>
<p>`query.filter(User.name != None)</p>
<pre><code># alternatively, if pep8/linters are a concern
query.filter(User.name.isnot(None))`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   `AND`:</div></pre></td></tr></table></figure>
<p>`# use and<em>()<br>    from sqlalchemy import and</em><br>    query.filter(and_(User.name == ‘ed’, User.fullname == ‘Ed Jones’))</p>
<pre><code># or send multiple expressions to .filter()
query.filter(User.name == &apos;ed&apos;, User.fullname == &apos;Ed Jones&apos;)

# or chain multiple filter()/filter_by() calls
query.filter(User.name == &apos;ed&apos;).filter(User.fullname == &apos;Ed Jones&apos;)`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   `OR`:</div></pre></td></tr></table></figure>
<p><code>from sqlalchemy import or_
    query.filter(or_(User.name == &#39;ed&#39;, User.name == &#39;wendy&#39;))</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   `MATCH`:</div></pre></td></tr></table></figure></p>
<p><code>query.filter(User.name.match(&#39;wendy&#39;))</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">    # 返回列表(List)和单项(Scalar)</div><div class="line"></div><div class="line">    很多`Query`的方法执行了SQL命令并返回了取出的数据库结果。</div><div class="line"></div><div class="line">*   `all()`返回一个列表:</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; query = session.query(User).filter(User.name.like(&#39;%ed&#39;)).order_by(User.id)
    SQL&gt;&gt;&gt; query.all()
    [&lt;User(name=&#39;ed&#39;, fullname=&#39;Ed Jones&#39;, password=&#39;f8s7ccs&#39;)&gt;,
        &lt;User(name=&#39;fred&#39;, fullname=&#39;Fred Flinstone&#39;, password=&#39;blah&#39;)&gt;]</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">*   `first()`返回至多一个结果，而且以单项形式，而不是只有一个元素的tuple形式返回这个结果.</div></pre></td></tr></table></figure></p>
<p><code>&gt;&gt;&gt; query.first()
    &lt;User(name=&#39;ed&#39;, fullname=&#39;Ed Jones&#39;, password=&#39;f8s7ccs&#39;)&gt;</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">*   `one()`返回且仅返回一个查询结果。当结果的数量不足一个或者多于一个时会报错。</div><div class="line">    ```python</div><div class="line">&gt;&gt;&gt; user = query.one()</div><div class="line">    Traceback (most recent call last):</div><div class="line">    ...</div><div class="line">    MultipleResultsFound: Multiple rows were found for one()</div></pre></td></tr></table></figure></p>
<pre><code>没有查找到结果时：

<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>user = query.filter(User.id == <span class="number">99</span>).one()</div><div class="line">    Traceback (most recent call last):</div><div class="line">    ...</div><div class="line">    NoResultFound: No row was found <span class="keyword">for</span> one()</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p><code>one_or_none()</code>：从名称可以看出，当结果数量为0时返回<code>None</code>， 多于1个时报错</p>
</li>
<li><p><code>scalar()</code>和<code>one()</code>类似，但是返回单项而不是tuple</p>
<h1 id="嵌入使用SQL"><a href="#嵌入使用SQL" class="headerlink" title="嵌入使用SQL"></a>嵌入使用SQL</h1><p>你可以在<code>Query</code>中通过<code>text()</code>使用SQL语句。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</div><div class="line">    &gt;&gt;&gt; <span class="keyword">for</span> user <span class="keyword">in</span> session.query(User).\</div><div class="line">    ...             filter(text(<span class="string">"id&lt;224"</span>)).\</div><div class="line">    ...             order_by(text(<span class="string">"id"</span>)).all():</div><div class="line">    ...     print(user.name)</div><div class="line">    ed</div><div class="line">    wendy</div><div class="line">    mary</div><div class="line">    fred</div></pre></td></tr></table></figure>
<p>除了上面这种直接将参数写进字符串的方式外，你还可以通过<code>params()</code>方法来传递参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>session.query(User).filter(text(<span class="string">"id&lt;:value and name=:name"</span>)).\</div><div class="line">    ...     params(value=<span class="number">224</span>, name=<span class="string">'fred'</span>).order_by(User.id).one()</div><div class="line">    &lt;User(name=<span class="string">'fred'</span>, fullname=<span class="string">'Fred Flinstone'</span>, password=<span class="string">'blah'</span>)&gt;</div></pre></td></tr></table></figure>
<p>并且，你可以直接使用完整的SQL语句，但是要注意将表名和列明写正确。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">`&gt;&gt;&gt; session.query(User).from_statement(</div><div class="line">    ...                     text(&quot;SELECT * FROM users where name=:name&quot;)).\</div><div class="line">    ...                     params(name=&apos;ed&apos;).all()</div><div class="line">    [&lt;User(name=&apos;ed&apos;, fullname=&apos;Ed Jones&apos;, password=&apos;f8s7ccs&apos;)&gt;]`</div></pre></td></tr></table></figure>
<pre><code># 计数

`Query`定义了一个很方便的计数函数`count()`
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">`&gt;&gt;&gt; session.query(User).filter(User.name.like(&apos;%ed&apos;)).count()</div><div class="line">    SELECT count(*) AS count_1</div><div class="line">    FROM (SELECT users.id AS users_id,</div><div class="line">                    users.name AS users_name,</div><div class="line">                    users.fullname AS users_fullname,</div><div class="line">                    users.password AS users_password</div><div class="line">    FROM users</div><div class="line">    WHERE users.name LIKE ?) AS anon_1</div><div class="line">    (&apos;%ed&apos;,)</div><div class="line">    2`</div></pre></td></tr></table></figure>
<pre><code>注意上面我们同时列出了实际的SQL指令。在SQLAlchemy中，我们总是将被计数的查询打包成一个子查询，然后对这个子查询进行计数。即便是最简单的`SELECT count(*) FROM table`，也会如此处理。为了更精细的控制计数过程，我们可以采用`func.count()`这个函数。
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">`&gt;&gt;&gt; from sqlalchemy import func</div><div class="line">    SQL&gt;&gt;&gt; session.query(func.count(User.name), User.name).group_by(User.name).all()</div><div class="line">    SELECT count(users.name) AS count_1, users.name AS users_name</div><div class="line">    FROM users GROUP BY users.name</div><div class="line">    ()</div><div class="line">    [(1, u&apos;ed&apos;), (1, u&apos;fred&apos;), (1, u&apos;mary&apos;), (1, u&apos;wendy&apos;)]`</div></pre></td></tr></table></figure>
<pre><code>为了实现最简单的`SELECT count(*) FROM table`，我们可以如下调用
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">`&gt;&gt;&gt; session.query(func.count(&apos;*&apos;)).select_from(User).scalar()</div><div class="line">    SELECT count(?) AS count_1</div><div class="line">    FROM users</div><div class="line">    (&apos;*&apos;,)</div><div class="line">    4`</div></pre></td></tr></table></figure>
<pre><code>如果我们对`User`的主键进行计数，那么`select_from`也可以省略。
</code></pre><p><code>``
</code>&gt;&gt;&gt; session.query(func.count(User.id)).scalar()<br>    SELECT count(users.id) AS count_1<br>    FROM users<br>    ()<br>    4</p>
<p>在下一篇教程里面我们将会介绍SQLAlchemy对于『关系』的处理方式，以及针对关系的更加复杂的查询。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/11/05/sqlalchemy-e4-bb-8b-e7-bb-8d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/05/sqlalchemy-e4-bb-8b-e7-bb-8d/" itemprop="url">SQLAlchemy介绍</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-05T01:33:34+08:00">
                2016-11-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近一直忙着开发<a href="http://lab.npuacm.info" target="_blank" rel="external">lab.npuacm.info</a>，因为更换了Python的框架（Django -&gt; Tornado），所以对于数据库而言，我需要一个ORM来防止手残的我存储数据。</p>
<p>所以我选择了SQLAlchemy。</p>
<h1 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h1><p>所谓ORM（Object Relational Mapping），就是建立其由Python类到数据库表的映射关系：一个Python实例(<em>instance</em>)对应数据库中的一行(<em>row</em>)。这种映射包含两层含义，一是实现对象和与之关联的的行的状态同步，二是将涉及数据库的查询操作，表达为Python类的相互关系。</p>
<p>注意ORM和SQLAlchemy的Expression Language不同。后者可以视为对原始SQL的封装。ORM是基于Expression Language而构建的，其抽象层次要高于Expression Language。很多时候我们都是使用ORM，有时需要一些高度定制化的功能时，就需要使用到Expression Language。</p>
<h1 id="版本检查"><a href="#版本检查" class="headerlink" title="版本检查"></a>版本检查</h1><p>你可以这样检查SQLAlchemy的版本信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sqlalchemy</div><div class="line">sqlalchemy.__version__</div><div class="line"></div><div class="line"><span class="string">'1.1.2'</span></div></pre></td></tr></table></figure>
<h1 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h1><p>在这个教程中我们使用in-memory的SQLite数据库，你也可以根据自己的需要配置对应的数据库设置。为了建立同数据库的链接，我们需要使用到<code>create_engine</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>engine = create_engine(<span class="string">'sqlite:///:memory:'</span>, echo=<span class="keyword">True</span>)</div></pre></td></tr></table></figure>
<p>这里的<code>echo</code>设置为True可以使得后面我们可以在控制台看到操作涉及的SQL语言。如果你觉得麻烦，可以将其设置为False。我们这里就不贴出了。</p>
<p><code>create_engine</code>返回的是一个<code>Engine</code>实例，它代表了指向数据库的一些非常核心的接口。他会根据你选择的数据库配置而调用对应的<code>DBAPI</code>。</p>
<p>当第一次如<code>Engine.execute()</code>或者<code>Engine.connect()</code>的方法被调用时，<code>Engine</code>才会真正的建立起到数据库的<code>DBAPI</code>连接。实际上，我们一般并不会直接使用<code>Engine</code>。</p>
<h1 id="Declaring-a-Mapping"><a href="#Declaring-a-Mapping" class="headerlink" title="Declaring a Mapping"></a>Declaring a Mapping</h1><p>当我们使用ORM的时候，其配置过程主要分为两个部分：一是描述我们要处理的数据库表的信息，二是将我们的Python类映射到这些表上。这两个过程在SQLAlchemy中是一起完成的，我们将这个过程称之为<strong>Declarative</strong>。</p>
<p>使用Declarative参与ORM映射的类需要被定义成为一个指定基类的子类，这个基类应当含有ORM映射中相关的类和表的信息。这样的基类我们称之为<strong>declarative base class</strong>。在我们的应用中，我们一般只需要一个这样的基类。这个基类我们可以通过<code>declarative_base</code>来创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>Base = declarative_base()</div></pre></td></tr></table></figure>
<p>现在我们已经有了一个基类，我们可以基于这个基类来创建我们的自定义类了。我们以建立一个用户类为例子。从<code>Base</code>派生一个名为<code>User</code>的类，在这个类里面我们可以定义将要映射到数据库的表上的属性（主要是表的名字，列的类型和名称等）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></div><div class="line"><span class="meta">... </span>    __tablename__ = <span class="string">'users'</span></div><div class="line">...</div><div class="line"><span class="meta">... </span>    id = Column(Integer, primary_key=<span class="keyword">True</span>)</div><div class="line"><span class="meta">... </span>    name = Column(String)</div><div class="line"><span class="meta">... </span>    fullname = Column(String)</div><div class="line"><span class="meta">... </span>    password = Column(String)</div><div class="line">...</div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line"><span class="meta">... </span>       <span class="keyword">return</span> <span class="string">"&lt;User(name='%s', fullname='%s', password='%s')&gt;"</span> % (</div><div class="line"><span class="meta">... </span>                            self.name, self.fullname, self.password)</div></pre></td></tr></table></figure>
<p>通过Declarative生成的类至少应该包含一个名为<strong>tablename</strong>的属性来给出目标表的名称，以及至少一个<code>Column</code>来给出表的主键(Primary Key)。SQLAlchemy不会对于类名和表名之间的关联做任何假设，也不会自动涉及数据类型以及约束的转换。一般的你可以自己创建一个模板来建立这些自动转换，这样可以减少你的很多重复劳动。</p>
<p>当我们的类声明完成后，Declarative将会将所有的<code>Column</code>成员替换成为特殊的Python访问器(accessors)，我们称之为<strong>descriptors</strong>。这个过程我们称为<strong>instrumentation</strong>，经过instrumentation的映射类可以让我们能够读写数据库的表和列。</p>
<p>注意除了这些涉及ORM的映射意外，这些mapping类的其他部分仍然是不变的。</p>
<h1 id="Create-a-schema"><a href="#Create-a-schema" class="headerlink" title="Create a schema"></a>Create a schema</h1><p>我们通过Declarative系统构建好我们的<code>User</code>类之后，与之同时的关于表的信息也已经创建好了，我们称之为<strong>table metadata</strong>。描述这些信息的类为<code>Table</code>。我们可以通过<code>__table__</code>这个类变量来查看表信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; User.__table__ </div><div class="line">Table(&apos;users&apos;, MetaData(bind=None),</div><div class="line">            Column(&apos;id&apos;, Integer(), table=&lt;users&gt;, primary_key=True, nullable=False),</div><div class="line">            Column(&apos;name&apos;, String(), table=&lt;users&gt;),</div><div class="line">            Column(&apos;fullname&apos;, String(), table=&lt;users&gt;),</div><div class="line">            Column(&apos;password&apos;, String(), table=&lt;users&gt;), schema=None)</div></pre></td></tr></table></figure>
<p>当我们完成类声明时，Declarative用一个Python的metaclass来为这个类进行了加工。在这个阶段，它依据我们给出的设置创建了<code>Table</code>对象，然后构造一个<code>Mapper</code>对象来与之关联。这些幕后的对象我们大多都不需要直接与之打交道。</p>
<p><code>Table</code>对象是一个更大家庭—-我们称之为<code>MetaData</code>—-的一部分。当我们使用Declarative时，这个对象也可以在Declarative base class的<code>.metadata</code>属性中看到。</p>
<p><code>MetaData</code>是我们与数据库打交道的一个接口。对于我们的SQLite数据库而言，此时还没有一个名为<code>users</code>的表的存在，我们需要使用<code>MetaData</code>来发出<code>CREATE TABLE</code>的命令。下面我们使用<code>MetaData.create_all()</code>指令，将我们上面得到的<code>Engine</code>作为参数传入。如果你上面设置了echo为True的话，应该可以看到这一过程中的SQL指令。首先检查了<code>users</code>表的存在性，如果不存在的话会执行表的创建工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; Base.metadata.create_all(engine)</div><div class="line">SELECT ...</div><div class="line">PRAGMA table_info(&quot;users&quot;)</div><div class="line">()</div><div class="line">CREATE TABLE users (</div><div class="line">    id INTEGER NOT NULL, name VARCHAR,</div><div class="line">    fullname VARCHAR,</div><div class="line">    password VARCHAR,</div><div class="line">    PRIMARY KEY (id)</div><div class="line">)</div><div class="line">()</div><div class="line">COMMIT</div></pre></td></tr></table></figure>
<h1 id="Create-an-Instance-of-the-Mapped-Class"><a href="#Create-an-Instance-of-the-Mapped-Class" class="headerlink" title="Create an Instance of the Mapped Class"></a>Create an Instance of the Mapped Class</h1><p>创建<code>User</code>对象十分简单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; ed_user = User(name=&apos;ed&apos;, fullname=&apos;Ed Jones&apos;, password=&apos;edspassword&apos;)</div><div class="line">&gt;&gt;&gt; ed_user.name</div><div class="line">&apos;ed&apos;</div><div class="line">&gt;&gt;&gt; ed_user.password</div><div class="line">&apos;edspassword&apos;</div><div class="line">&gt;&gt;&gt; str(ed_user.id)</div><div class="line">&apos;None&apos;</div></pre></td></tr></table></figure>
<h1 id="Create-a-Session"><a href="#Create-a-Session" class="headerlink" title="Create a Session"></a>Create a Session</h1><p>Session是一个非常重要的概念，类似于iOS中的NSManagedContext的概念，我也在尝试进一步去理解它。</p>
<p>我们现在可以和数据库对话了。ORM对数据库的入口即是<code>Session</code>，当我们构建应用时，和<code>create_engine</code>的同一级别下，我们定义一个<code>Session</code>类来作为生成新的Session的Factory类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>Session = sessionmaker(bind=engine)</div></pre></td></tr></table></figure>
<p>当你试图在定义<code>Engine</code>之前定义<code>Sesssion</code>的话，这里的<code>bind</code>可以不设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>Session = sessionmaker()</div></pre></td></tr></table></figure>
<p>后续你定义好<code>Engine</code>后可以通过<code>configure()</code>来将其连接到<code>Session</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>Session.configure(bind=engine)  <span class="comment"># once engine is available</span></div></pre></td></tr></table></figure>
<p>这个我们自定义的工厂类就可以拿来我们构造新的<code>Session</code>了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session = Session()</div></pre></td></tr></table></figure>
<p>上面的<code>Session</code>已经和我们的<code>SQLite</code>的数据库的<code>Engine</code>关联起来了，但是我们可以发现它还没有打开任何到数据库的连接(connection)。当一个<code>Session</code>被首次使用时，它会从<code>Engine</code>所维护的连接池中取出一个连接来操作数据库。这个连接在我们应用有所更改或者关闭<code>Session</code>时会被释放。</p>
<h1 id="Adding-and-Update-Objects"><a href="#Adding-and-Update-Objects" class="headerlink" title="Adding and Update Objects"></a>Adding and Update Objects</h1><p>为了将<code>User</code>对象存入数据库，我们调用<code>Sesson</code>的<code>add()</code>函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>ed_user = User(name=<span class="string">'ed'</span>, fullname=<span class="string">'Ed Jones'</span>, password=<span class="string">'edspassword'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>session.add(ed_user)</div></pre></td></tr></table></figure>
<p>当这个操作完成之后，我们成这个<code>User</code>实例的状态为<strong>pending</strong>。目前实际上还没有执行SQL操作，也就是说数据库中还没有产生和这个<code>User</code>实例对应的行。<code>Session</code>将会在需要的时候执行相应的SQL命令，这个过程我们称之为<strong>flush</strong>。如果我们试图查询<code>Ed Jones</code>，所有处于<code>pending</code>状态的信息将会首先被<strong>flush</strong>，然后负责进行查询的SQL语言在此之后立即被执行。</p>
<p>例如，我们创建一个查询来获取刚刚我们创建的用户（涉及查询的部分我们后续会详细介绍）。这个查询会返回一个和我们之前添加的用户相同的用户实例。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; our_user = session.query(User).filter_by(name='ed').first() BEGIN (implicit)</div><div class="line">INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)</div><div class="line">('ed', 'Ed Jones', 'edspassword')</div><div class="line">SELECT users.id AS users_id,</div><div class="line">        users.name AS users_name,</div><div class="line">        users.fullname AS users_fullname,</div><div class="line">        users.password AS users_password</div><div class="line">FROM users</div><div class="line">WHERE users.name = ?</div><div class="line"> LIMIT ? OFFSET ?</div><div class="line">('ed', 1, 0)</div><div class="line">&gt;&gt;&gt; our_user</div><div class="line">&lt;User(name='ed', fullname='Ed Jones', password='edspassword')&gt;</div></pre></td></tr></table></figure>
<p>事实上这里的<code>Session</code>判断出来了需要返回的行和已经存在内存中的一个映射实例应当是同一个，所以我们会得到一个和之前完全相同的实例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>ed_user <span class="keyword">is</span> our_user</div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure>
<p>这里ORM所表现的理念，我们称之为<a href="http://docs.sqlalchemy.org/en/rel_1_0/glossary.html#term-identity-map" target="_blank" rel="external">identity map</a>。这个设计理念保证了在一个<code>Session</code>对于一个制定行的操作，作用于同一个内存实例上。当一个拥有特定主键的对象出现在<code>Session</code>中时，所有的查询操作对这个主键都会返回一个相同的Python对象。并且，如果你试图引入重复了主键的新的对象时，系统会产生一个错误来阻止你的操作。</p>
<p>我们可以通过<code>add_all()</code>来一次加入多个对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>session.add_all([</div><div class="line"><span class="meta">... </span>    User(name=<span class="string">'wendy'</span>, fullname=<span class="string">'Wendy Williams'</span>, password=<span class="string">'foobar'</span>),</div><div class="line"><span class="meta">... </span>    User(name=<span class="string">'mary'</span>, fullname=<span class="string">'Mary Contrary'</span>, password=<span class="string">'xxg527'</span>),</div><div class="line"><span class="meta">... </span>    User(name=<span class="string">'fred'</span>, fullname=<span class="string">'Fred Flinstone'</span>, password=<span class="string">'blah'</span>)])</div></pre></td></tr></table></figure>
<p>并且，如果我们希望改变Ed的密码，可以直接修改之：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>ed_user.password = <span class="string">'f8s7ccs'</span></div></pre></td></tr></table></figure>
<p>这个修改会被<code>Session</code>记录下来</p>
<pre><code>&gt;&gt;&gt; session.dirty
IdentitySet([&lt;User(name=&apos;ed&apos;, fullname=&apos;Ed Jones&apos;, password=&apos;f8s7ccs&apos;)&gt;])
</code></pre><p>当然，上面的插入操作也被记录了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>session.new </div><div class="line">IdentitySet([&lt;User(name=<span class="string">'wendy'</span>, fullname=<span class="string">'Wendy Williams'</span>, password=<span class="string">'foobar'</span>)&gt;,</div><div class="line">&lt;User(name=<span class="string">'mary'</span>, fullname=<span class="string">'Mary Contrary'</span>, password=<span class="string">'xxg527'</span>)&gt;,</div><div class="line">&lt;User(name=<span class="string">'fred'</span>, fullname=<span class="string">'Fred Flinstone'</span>, password=<span class="string">'blah'</span>)&gt;])</div></pre></td></tr></table></figure>
<p>我们可以使用<code>commit()</code>命令来将这些更改<strong>flush</strong>到数据库中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>session.commit()</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="kido zhang" />
          <p class="site-author-name" itemprop="name">kido zhang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">112</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">78</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kidozh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/331837926Ji" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                    
                      Twitter
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/kidozh" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/kidozh" target="_blank" title="douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      douban
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/kidozh" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      zhihu
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kido zhang</span>

  
</div>


  <div class="powered-by">
    由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    主题 &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Pisces
    </a>
  </div>


        







        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

</body>
</html>
