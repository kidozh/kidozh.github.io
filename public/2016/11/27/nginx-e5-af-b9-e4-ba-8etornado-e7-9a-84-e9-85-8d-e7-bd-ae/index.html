<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Nginx对于Tornado的配置 · kidozh</title><meta name="description" content="Nginx对于Tornado的配置 - kido zhang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://kidozh.com/atom.xml" title="kidozh"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/1793490853" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/kidozh" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Nginx对于Tornado的配置</h1><div class="post-info">2016年11月27日</div><div class="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近一直被轰炸HTTPS的好处，于是咬咬牙把<a href="https://lab.npuacm.info" target="_blank" rel="external">lab.npuacm.info</a>加了个SSL。下面我就简单的说一下步骤。</p>
<h1 id="获得SSL证书"><a href="#获得SSL证书" class="headerlink" title="获得SSL证书"></a>获得SSL证书</h1><p>对于SSL证书，我们可以在下面这些网站获得：</p>
<ol>
<li><a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s encrypt</a></li>
<li><a href="https://www.startssl.com/" target="_blank" rel="external">StartSSL</a></li>
<li>腾讯云提供的<a href="https://www.qcloud.com/product/ssl.html" target="_blank" rel="external">SSL</a>证书</li>
</ol>
<p>前面几种网上案例很多，我就不多说了，需要注意的是第一和第二个都是需要Shell权限的，所以如果你没有权限的话，那就需要联系一下你的server提供商了。</p>
<h1 id="配置Nginx服务器"><a href="#配置Nginx服务器" class="headerlink" title="配置Nginx服务器"></a>配置Nginx服务器</h1><p>网上主要可以配置Nginx和Tornado主程序两种，不过我还是建议各位dalao直接去配置Nginx，毕竟耐艹，而且对于静态文件而言，还需要Nginx来处理。</p>
<p>首先，我的思路是，需要对原来的HTTP访问全部转发到HTTPS上，所以，我们可以在Nginx中配置这一项。</p>
<pre class="lang:default decode:true " title="转发到安全的连接服务">server {
    listen 80;
    server_name example.com;

    rewrite /(.*) https://$http_host/$1 redirect;
}</pre>

<p>然后就要对HTTPS进行配置</p>
<pre class="lang:default decode:true ">server {
    listen 443;
    ssl on;
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/cert.key;

    default_type application/octet-stream;

    location /static/ {
        root /var/www/static;
        if ($query_string) {
            expires max;
        }
    }

    location = /favicon.ico {
        rewrite (.*) /static/favicon.ico;
    }

    location / {
        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://tornadoes;
    }
}</pre>

<p>但是这样明显不够，因为我的tornado中使用了Websocket技术，这里就不能使用<code>ws://</code>协议而应该是<code>wss://</code>了，所以我们需要告诉Nginx开启Websocket服务。</p>
<p>所以最终的代码应该是</p>
<pre class="lang:default decode:true ">upstream tornados{
    server 127.0.0.1:8003;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
}
proxy_next_upstream error;
server {
    listen  80;
    server_name lab.npuacm.info;

    # rewrite
    rewrite /(.*) https://$http_host/$1 redirect;
}
server{
    listen 443;
    ssl on;
    server_name lab.npuacm.info;

    ssl_certificate your_public_key.crt;
    ssl_certificate_key your_key.key;

    default_type application/octet-stream;

    # Nginx处理这个问题
    location /static/ {
        root /home/ubuntu/npuacmLab;
        if ($query_string){
            expires 24h;
        }
    }
    location / {
        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://tornados;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}

</pre>

<p>自然，如果你并不想配置ngnix的话，你可以直接在本地开启HTTPS服务。</p>
<pre class="lang:python decode:true ">    http_server = tornado.httpserver.HTTPServer(app
        ssl_options={
        "certfile": os.path.join(os.path.abspath("SSL"), "public_key.crt"),
        "keyfile": os.path.join(os.path.abspath("SSL"), "private_key.key"),
    }
    )
    http_server.listen(options.port)
    tornado.ioloop.IOLoop.instance().start()</pre>

<p>这样本地调试的时候，你就可以直接输入HTTPS调试了，同样的Websocket也可以直接使用<code>wss://</code>协议了。</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>被国内运营商劫持的满屏幕都是充话费的。。。也是醉了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/11/28/bcrypt-e7-9a-84-e4-bd-bf-e7-94-a8-e6-96-b9-e6-b3-95/" class="prev">上一篇</a><a href="/2016/11/14/abaqus-e6-a8-a1-e6-8b-9f-e8-9e-ba-e6-a0-93-e8-bf-9e-e6-8e-a5-e7-9a-84-e6-96-b9-e6-b3-95/" class="next">下一篇</a></div><div class="copyright"><p>© 2013 - 2017 <a href="http://kidozh.com">kido zhang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>